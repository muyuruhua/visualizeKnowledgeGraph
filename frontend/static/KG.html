<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å›¾è°±å¯è§†åŒ–ç³»ç»Ÿ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #e8f5e9 100%);
            color: #263238;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            width: 300px;
            background: linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%);
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin: 10px;
        }

        .visualization-panel {
            flex: 1;
            position: relative;
            margin: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        #graph-container {
            width: 100%;
            height: 100%;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .mode-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .mode-btn.preview {
            background: linear-gradient(135deg, #4dd0e1 0%, #80deea 100%);
            color: #263238;
        }

        .mode-btn.preview:hover {
            background: linear-gradient(135deg, #26c6da 0%, #4dd0e1 100%);
        }

        .mode-btn.data {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: #263238;
        }

        .mode-btn.data:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
        }

        .mode-btn.refresh {
            background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
            color: white;
        }

        .mode-btn.refresh:hover {
            background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
        }

        .mode-btn.refresh:disabled {
            background: linear-gradient(135deg, #ccc 0%, #ddd 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .mode-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .data-editor {
            display: none;
            width: 100%;
            height: 100%;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow-y: auto;
        }

        .data-editor.active {
            display: block;
        }

        .preview-mode {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .json-editor {
            width: 100%;
            height: calc(100% - 200px);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background: #ffffff;
            resize: none;
        }

        .data-controls {
            margin-top: 15px;
            display: flex !important;
            gap: 10px;
            justify-content: center;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .data-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .data-btn.save {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }

        .data-btn.save:hover {
            background: linear-gradient(135deg, #388e3c 0%, #4caf50 100%);
        }

        .data-btn.cancel {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
            color: white;
        }

        .data-btn.cancel:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
        }

        .data-btn.reorder {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
        }

        .data-btn.reorder:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
        }

        .data-btn.suffix {
            background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
            color: white;
        }

        .data-btn.suffix:hover {
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
        }

        /* ç¦ç”¨çŠ¶æ€çš„æ ·å¼ */
        .domain-select-disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .domain-select-disabled input,
        .domain-select-disabled select,
        .domain-select-disabled button {
            background-color: #f5f5f5 !important;
            cursor: not-allowed !important;
            color: #999 !important;
        }

        /* ç¡®ä¿ä¸‹æ‹‰æ¡†åœ¨æ¢å¤åæ­£å¸¸æ˜¾ç¤º */
        .domain-dropdown {
            display: none;
        }

        .domain-dropdown.visible {
            display: block;
        }

        /* äº’æ¢å®ä½“æŒ‰é’®æ ·å¼ */
        .swap-entities-container {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .btn-swap {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .btn-swap:hover {
            background: #e0e0e0;
            border-color: #ccc;
        }

        .swap-icon {
            font-size: 14px;
            margin-right: 4px;
        }

        /* ç®€åŒ–çš„JSONç¼–è¾‘å™¨æ ·å¼ */
        .simple-json-editor {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            outline: none;
            resize: vertical;
            min-height: 400px;
            background: #fafafa;
            color: #333;
            width: 100%;
            box-sizing: border-box;
        }

        .simple-json-editor:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            background: #fff;
        }

        /* è‡ªå®šä¹‰é¢†åŸŸæç¤ºæ ·å¼ */
        .custom-domain-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }

        .custom-domain-info::before {
            content: "ğŸ’¡ ";
            margin-right: 5px;
        }

        /* è‡ªå®šä¹‰é€‰é¡¹æ ·å¼ï¼ˆé¢†åŸŸå’Œå…³ç³»ç±»å‹ï¼‰ */
        .dropdown-item[style*="color: #2e7d32"] {
            background: #f1f8e9;
            border-left: 3px solid #2e7d32;
            font-weight: 500;
        }

        .dropdown-item[style*="color: #2e7d32"]:hover {
            background: #e8f5e8;
        }

        .domain-info-disabled {
            color: #666 !important;
            font-style: italic !important;
        }

        /* æ•°æ®æ¨¡å¼ä¸‹çš„ç¦ç”¨æ ·å¼ */
        .data-mode-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .data-mode-disabled input,
        .data-mode-disabled select,
        .data-mode-disabled button {
            background-color: #f5f5f5 !important;
            cursor: not-allowed !important;
            color: #999 !important;
        }

        /* ç¼–è¾‘æŒ‰é’®ç¦ç”¨æ ·å¼ */
        .btn-edit:disabled,
        .btn-save:disabled,
        .btn-cancel:disabled,
        .btn-delete:disabled,
        .btn-copy:disabled,
        .btn-update:disabled {
            background-color: #f5f5f5 !important;
            color: #999 !important;
            cursor: not-allowed !important;
            opacity: 0.5 !important;
        }

        /* æ•°æ®æ¨¡å¼ä¸‹ç¦ç”¨çš„ç¼–è¾‘æŒ‰é’® */
        .data-mode .btn-edit,
        .data-mode .btn-save,
        .data-mode .btn-cancel,
        .data-mode .btn-delete,
        .data-mode .btn-copy,
        .data-mode .btn-update {
            pointer-events: none;
        }

        /* å®ä½“åˆ—è¡¨æŒ‰é’®ç¦ç”¨æ ·å¼ */
        .action-btn[style*="pointer-events: none"] {
            opacity: 0.3 !important;
            cursor: not-allowed !important;
        }

        /* æ•°æ®æ¨¡å¼ä¸‹å®ä½“åˆ—è¡¨æŒ‰é’®ç¦ç”¨ */
        .data-mode .action-btn {
            pointer-events: none !important;
            opacity: 0.3 !important;
            cursor: not-allowed !important;
        }

        /* æ•°æ®æ¨¡å¼ä¸‹å®ä½“åˆ—è¡¨é¡¹ç¦ç”¨ */
        .data-mode .entity-item {
            pointer-events: none !important;
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }

        /* å®ä½“åˆ—è¡¨é¡¹ç¦ç”¨æ ·å¼ */
        .entity-item[style*="pointer-events: none"] {
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4dd0e1 0%, #80deea 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #263238;
        }

        .control-btn:hover {
            background: linear-gradient(135deg, #26c6da 0%, #4dd0e1 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #546e7a;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #b2ebf2;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.8);
            color: #263238;
            font-size: 14px;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #4dd0e1;
            outline: none;
            box-shadow: 0 0 0 2px rgba(77, 208, 225, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-primary, .btn-secondary {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
            color: #ffffff;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(102, 187, 106, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            box-shadow: 0 3px 6px rgba(102, 187, 106, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #b0bec5 0%, #cfd8dc 100%);
            color: #263238;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #90a4ae 0%, #b0bec5 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
            color: #ffffff;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(244, 67, 54, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
            box-shadow: 0 3px 6px rgba(244, 67, 54, 0.4);
        }

        .list-title {
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0f2f1;
            color: #2e7d32;
        }

        .entity-item {
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 3px solid #81c784;
        }

        .entity-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        }

        .entity-info p {
            font-size: 12px;
            color: #607d8b;
            margin-top: 3px;
        }

        .entity-domain {
            font-size: 11px;
            color: #2e7d32;
            background: #e8f5e8;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            font-weight: normal;
        }

        .entity-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .action-btn {
            font-size: 14px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .action-btn:hover {
            opacity: 1;
        }

        .edit-btn {
            color: #2e7d32;
        }

        .delete-btn {
            color: #e53935;
        }

        .copy-btn {
            color: #1976d2;
        }

        .no-data {
            color: #78909c;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .detail-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0f2f1;
            color: #2e7d32;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-section h3 {
            font-size: 14px;
            color: #546e7a;
            margin-bottom: 5px;
        }

        .detail-content {
            font-size: 15px;
            padding: 5px;
            background: #f1f8e9;
            border-radius: 4px;
            color: #263238;
        }
        
        /* å¯è°ƒæ•´å¤§å°çš„æè¿°æ¡†æ ·å¼ */
        .resizable-description {
            position: relative;
            height: 300px; /* å›ºå®šé«˜åº¦ - å¢åŠ ä¸€å€ */
            overflow-y: auto; /* å‚ç›´æ»šåŠ¨æ¡ */
            border: 1px solid #c8e6c9;
            padding: 10px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }
        
        
        .description-text {
            word-wrap: break-word;
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œç¬¦å’Œç©ºæ ¼ */
            word-break: break-word; /* é•¿å•è¯è‡ªåŠ¨æ¢è¡Œ */
            color: #333;
            font-size: 14px;
            flex: 1;
            overflow-y: auto;
        }
        
        .description-controls {
            position: sticky;
            bottom: 0;
            display: flex;
            gap: 5px;
            z-index: 10;
            background: #fafafa;
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            pointer-events: auto;
            margin-top: auto;
            margin-left: auto;
            width: fit-content;
            flex-shrink: 0;
        }
        
        /* ç¡®ä¿æŒ‰é’®åœ¨æè¿°æ¡†æ‹‰ä¼¸æ—¶ä¿æŒä½ç½® */
        .resizable-description:focus-within .description-controls {
            position: sticky;
            bottom: 0;
        }
        
        .description-controls button {
            padding: 3px 8px;
            font-size: 11px;
            border: 1px solid #4caf50;
            background: #4caf50;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 40px;
            text-align: center;
        }
        
        .description-controls button:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .description-controls .copy-btn {
            background: #2196f3;
            border-color: #2196f3;
        }
        
        .description-controls .copy-btn:hover {
            background: #1976d2;
        }

        /* å®ä½“æ‚¬æµ®ä¿¡æ¯æ¡†æ ·å¼ */
        .entity-tooltip {
            position: fixed; /* ä½¿ç”¨fixedå®šä½ï¼Œç›¸å¯¹äºè§†å£ */
            width: 280px; /* å›ºå®šå®½åº¦ */
            height: 400px; /* å›ºå®šé«˜åº¦ - å¢åŠ ä¸€å€ */
            border: 2px solid #4dd0e1;
            border-radius: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ï¼Œä¾¿äºé˜…è¯» */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            font-size: 14px;
            z-index: 1000;
            pointer-events: auto; /* å…è®¸é¼ æ ‡äº¤äº’ï¼Œç”¨äºæ»šåŠ¨ */
            opacity: 0;
            transition: opacity 0.3s ease;
            left: 0;
            top: 0;
            overflow-y: auto; /* å‚ç›´æ»šåŠ¨æ¡ */
            display: none; /* é»˜è®¤éšè— */
            backdrop-filter: blur(10px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        }


        .entity-tooltip h4 {
            margin: 0 0 5px 0;
            color: #2e7d32;
            font-size: 15px;
            border-bottom: 1px solid #e0f2f1;
            padding-bottom: 3px;
        }

        .entity-tooltip p {
            margin: 3px 0;
            color: #263238;
            font-size: 13px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œç¬¦å’Œç©ºæ ¼ */
            word-wrap: break-word; /* é•¿å•è¯è‡ªåŠ¨æ¢è¡Œ */
        }
        
        /* æ‚¬æµ®çª—å£æ»šåŠ¨æ¡æ ·å¼ */
        .entity-tooltip::-webkit-scrollbar {
            width: 6px;
        }
        
        .entity-tooltip::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        
        .entity-tooltip::-webkit-scrollbar-thumb {
            background: rgba(77, 208, 225, 0.6);
            border-radius: 3px;
        }
        
        .entity-tooltip::-webkit-scrollbar-thumb:hover {
            background: rgba(77, 208, 225, 0.8);
        }

        /* æ˜¾ç¤ºæ‚¬æµ®æ¡†æ—¶çš„æ ·å¼ */
        .entity-tooltip.visible {
            display: block;
            opacity: 1;
        }

        /* å³é”®æ“ä½œèœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            z-index: 10000;
            display: none;
            min-width: 160px;
        }

        .context-menu.visible {
            display: block;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .menu-item:hover {
            background-color: #f5f5f5;
        }

        .menu-item.danger:hover {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .menu-icon {
            margin-right: 10px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .menu-text {
            flex: 1;
        }

        /* èŠ‚ç‚¹é€‰ä¸­çŠ¶æ€æ ·å¼ */
        .node.selected {
            stroke: #ff6b6b;
            stroke-width: 3px;
        }

        /* å…³ç³»è¾¹æ ·å¼ - å¸¦ç®­å¤´ */
        .links line {
            stroke: #90a4ae;
            stroke-opacity: 0.6;
            transition: all 0.3s ease;
        }

        /* ç®­å¤´æ ‡è®°å®šä¹‰ */
        .arrowhead {
            stroke-width: 1.5px;
            stroke-opacity: 0.8;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* èŠ‚ç‚¹æ ·å¼ä¿®æ”¹ï¼šå¤§å®å¿ƒåœ† + å†…éƒ¨æ–‡å­— */
        .nodes circle {
            stroke: #ffffff;
            stroke-width: 2px;
            fill: #00BFFF;
            r: 35; /* å¢å¤§èŠ‚ç‚¹åŠå¾„ä¸º35px */
            transition: all 0.3s ease;
        }

        /* èŠ‚ç‚¹æ–‡å­—æ ·å¼ï¼šå±…ä¸­æ˜¾ç¤ºåœ¨åœ†å†… */
        .nodes text {
            fill: #ffffff; /* ç™½è‰²æ–‡å­—æ›´æ¸…æ™° */
            font-size: 9px; /* å¢å¤§å­—ä½“ */
            font-weight: 500; /* å­—ä½“ç²—ç»† */
            text-anchor: middle;
            dominant-baseline: middle; /* å‚ç›´å±…ä¸­ */
            pointer-events: none; /* æ–‡å­—ä¸é˜»ç¢ç‚¹å‡» */
            transition: all 0.3s ease;
        }

        /* å…³ç³»æ–‡å­—æ ·å¼ */
        .link-labels text {
            fill: #37474f; /* æ›´æ·±çš„é¢œè‰² */
            font-size: 9px; /* å¢å¤§å­—ä½“ */
            font-weight: 500; /* å­—ä½“ç²—ç»† */
            text-anchor: middle;
            transition: all 0.3s ease;
        }

        /* å®ä½“ç‚¹å‡»é«˜äº® - é»„è‰²æ ·å¼ */
        .highlighted circle {
            stroke: #ffca28; /* é»„è‰²é«˜äº®è¾¹æ¡† */
            stroke-width: 3px;
            animation: pulse 1.5s infinite;
        }

        .highlighted text {
            fill: #ffff00; /* é»„è‰² */
            font-weight: bold;
            font-size: 10px; /* å¢å¤§å­—ä½“ */
        }

        /* æœç´¢ç»“æœé«˜äº® - ä¸ç‚¹å‡»é«˜äº®ä¿æŒä¸€è‡´ */
        .search-highlighted circle {
            stroke: #ffca28; /* é‡‘è‰²/é»„è‰² */
            stroke-width: 3px;
            animation: pulse 1.5s infinite;
            fill: #66bb6a;
        }

        .search-highlighted text {
            fill: #ffff00; /* é»„è‰² */
            font-weight: bold;
            font-size: 10px; /* ä¸ç‚¹å‡»é«˜äº®ä¿æŒä¸€è‡´ */
        }

        /* æœç´¢ç»“æœçš„å…³ç³»é«˜äº® */
        .search-highlighted-link {
            stroke: #ffca28 !important;
            stroke-width: 3px !important;
            stroke-opacity: 1 !important;
            animation: pulseLink 1.5s infinite;
        }

        /* é«˜äº®çŠ¶æ€çš„ç®­å¤´ */
        .search-highlighted-arrow, .arrow-highlighted {
            fill: none !important;
            stroke: #ffca28 !important;
            stroke-width: 2px !important;
            stroke-opacity: 1 !important;
        }

        /* æœç´¢ç»“æœçš„å…³ç³»æ ‡ç­¾é«˜äº® - ä¸ç‚¹å‡»é«˜äº®ä¿æŒä¸€è‡´ */
        .search-highlighted-link-label {
            fill: #800080 !important; /* ç´«è‰² */
            font-weight: bold !important;
            font-size: 15px !important; /* ä¸ç‚¹å‡»é«˜äº®ä¿æŒä¸€è‡´ */
        }

        /* æœªæ¶‰åŠçš„å…ƒç´ é™ä½å¯è§æ€§ */
        .faded {
            opacity: 0.3;
        }

        /* å…³ç³»ç‚¹å‡»é«˜äº®æ ·å¼ */
        .link-highlighted {
            stroke: #ffca28 !important;
            stroke-width: 3px !important;
            stroke-opacity: 1 !important;
            animation: pulseLink 1.5s infinite;
        }

        .link-label-highlighted {
            fill: #800080 !important; /* ç´«è‰² */
            font-weight: bold !important;
            font-size: 15px !important; /* å¢å¤§å­—ä½“ */
        }

        /* å…³ç³»å…³è”å®ä½“é«˜äº® */
        .relation-entity-highlighted circle {
            stroke: #ffca28 !important;
            stroke-width: 3px !important;
            animation: pulse 1.5s infinite;
        }

        .relation-entity-highlighted text {
            fill: #ffff00 !important; /* é»„è‰² */
            font-weight: bold !important;
            font-size: 10px !important; /* å¢å¤§å­—ä½“ */
        }

        @keyframes pulse {
            0% { stroke-width: 3px; }
            50% { stroke-width: 6px; }
            100% { stroke-width: 3px; }
        }

        @keyframes pulseLink {
            0% { stroke-width: 3px; }
            50% { stroke-width: 5px; }
            100% { stroke-width: 3px; }
        }



        .search-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-direction: column;
        }

        .search-type-container {
            width: 100%;
            margin-bottom: 8px;
        }

        #search-type {
            width: 100%;
        }

        .search-input-group {
            display: flex;
            gap: 5px;
            width: 100%;
        }

        .search-input-container {
            position: relative;
            flex: 1;
        }

        #search-input {
            width: 100%;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .search-suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .search-suggestion-item:last-child {
            border-bottom: none;
        }

        .search-suggestion-highlight {
            background-color: #ffeb3b;
            font-weight: bold;
        }

        .search-results-info {
            color: #2e7d32;
            font-size: 12px;
            margin: -15px 0 15px 0;
            text-align: right;
            padding-right: 5px;
        }

        .file-operation-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .file-input-container {
            position: relative;
            width: 100%;
        }

        #file-upload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* å…³ç³»ç¼–è¾‘è¡¨å•æ ·å¼ */
        .relation-edit-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0f2f1;
        }

        /* å®ä½“ç¼–è¾‘è¡¨å•æ ·å¼ */
        .entity-edit-form {
            margin-top: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0f2f1;
        }

        .entity-edit-form .form-group {
            margin-bottom: 15px;
        }

        .entity-edit-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .entity-edit-form input,
        .entity-edit-form select,
        .entity-edit-form textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .entity-edit-form input:focus,
        .entity-edit-form select:focus,
        .entity-edit-form textarea:focus {
            outline: none;
            border-color: #26a69a;
            box-shadow: 0 0 0 2px rgba(38, 166, 154, 0.2);
        }

        .entity-edit-form .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .entity-edit-form .btn-primary,
        .entity-edit-form .btn-secondary {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .entity-edit-form .btn-primary {
            background-color: #26a69a;
            color: white;
        }

        .entity-edit-form .btn-primary:hover {
            background-color: #1e8a7f;
        }

        .entity-edit-form .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .entity-edit-form .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* AIé—®ç­”æœºå™¨äººæ ·å¼ */
        .ai-chatbot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ai-chatbot:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }

        /* å²åŠªæ¯”ç®€çº¦å®¢æœå›¾æ ‡æ ·å¼ */
        .snoopy-icon {
            position: relative;
            width: 50px;
            height: 50px;
            margin: auto;
        }

        .snoopy-head {
            position: absolute;
            width: 42px;
            height: 40px;
            background: #FFFFFF;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            top: 5px;
            left: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 2px solid #E0E0E0;
        }

        .snoopy-ears {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .ear {
            position: absolute;
            width: 12px;
            height: 16px;
            background: #FFFFFF;
            border-radius: 50% 50% 0 0;
            top: -1px;
            border: 2px solid #E0E0E0;
        }

        .left-ear {
            left: 6px;
            transform: rotate(-25deg);
        }

        .right-ear {
            right: 6px;
            transform: rotate(25deg);
        }

        .snoopy-eyes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .eye {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #000;
            border-radius: 50%;
            top: 16px;
            animation: blink 5s infinite;
        }

        .left-eye {
            left: 16px;
        }

        .right-eye {
            right: 16px;
        }

        @keyframes blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0; }
        }

        .snoopy-nose {
            position: absolute;
            width: 4px;
            height: 3px;
            background: #000;
            border-radius: 50%;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
        }

        .snoopy-mouth {
            position: absolute;
            width: 6px;
            height: 2px;
            background: #000;
            border-radius: 0 0 3px 3px;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* æ‚¬åœæ—¶çš„åŠ¨ç”»æ•ˆæœ */
        .ai-chatbot:hover .snoopy-icon {
            transform: scale(1.15);
            transition: transform 0.3s ease;
        }

        .ai-chatbot:hover .snoopy-ears {
            animation: wiggle 0.6s ease-in-out;
        }

        .ai-chatbot:hover .snoopy-head {
            animation: bounce 0.8s ease-in-out;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-8deg); }
            75% { transform: rotate(8deg); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }

        /* å²åŠªæ¯”ç®€çº¦åŠ¨ç”» */
        .snoopy-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }



        .ai-chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-title {
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-chat-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-switch-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
        }

        .ai-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-switch.active {
            background: #4CAF50;
        }

        .ai-switch-slider {
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            left: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .ai-switch.active .ai-switch-slider {
            left: 29px;
        }

        .ai-switch-text {
            font-size: 10px;
            color: white;
            font-weight: bold;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .ai-switch.active .ai-switch-text {
            color: white;
        }

        /* æ ‡é¢˜ä¸­çš„å²åŠªæ¯”å¤´åƒæ ·å¼ */
        .snoopy-title-avatar {
            position: relative;
            width: 24px;
            height: 24px;
            background: #FFFFFF;
            border-radius: 50%;
            border: 1px solid #E0E0E0;
            flex-shrink: 0;
        }

        .snoopy-title-avatar .snoopy-head {
            position: absolute;
            width: 16px;
            height: 14px;
            background: #FFFFFF;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            top: 3px;
            left: 4px;
            border: 1px solid #E0E0E0;
        }

        .snoopy-title-avatar .snoopy-ears {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .snoopy-title-avatar .ear {
            position: absolute;
            width: 5px;
            height: 6px;
            background: #FFFFFF;
            border-radius: 50% 50% 0 0;
            top: 0;
            border: 1px solid #E0E0E0;
        }

        .snoopy-title-avatar .left-ear {
            left: 3px;
            transform: rotate(-20deg);
        }

        .snoopy-title-avatar .right-ear {
            right: 3px;
            transform: rotate(20deg);
        }

        .snoopy-title-avatar .snoopy-eyes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .snoopy-title-avatar .eye {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #000;
            border-radius: 50%;
            top: 6px;
        }

        .snoopy-title-avatar .left-eye {
            left: 6px;
        }

        .snoopy-title-avatar .right-eye {
            right: 6px;
        }

        .snoopy-title-avatar .snoopy-nose {
            position: absolute;
            width: 1.5px;
            height: 1px;
            background: #000;
            border-radius: 50%;
            top: 9px;
            left: 50%;
            transform: translateX(-50%);
        }

        .ai-chat-close {
            cursor: pointer;
            font-size: 20px;
            color: white;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .ai-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .ai-message.user {
            justify-content: flex-end;
        }

        .ai-message-content {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .ai-message.user .ai-message-content {
            background: #667eea;
            color: white;
        }

        .ai-message.bot .ai-message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .ai-message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .ai-message.user .ai-message-avatar {
            background: #667eea;
            color: white;
        }

        .ai-message.bot .ai-message-avatar {
            background: #764ba2;
            color: white;
            position: relative;
            overflow: hidden;
        }

        /* å²åŠªæ¯”å¤´åƒæ ·å¼ */
        .snoopy-avatar {
            position: relative;
            width: 30px;
            height: 30px;
            background: #FFFFFF;
            border-radius: 50%;
            border: 2px solid #E0E0E0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .snoopy-avatar .snoopy-head {
            position: absolute;
            width: 20px;
            height: 18px;
            background: #FFFFFF;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            top: 4px;
            left: 5px;
            border: 1px solid #E0E0E0;
        }

        .snoopy-avatar .snoopy-ears {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .snoopy-avatar .ear {
            position: absolute;
            width: 6px;
            height: 8px;
            background: #FFFFFF;
            border-radius: 50% 50% 0 0;
            top: 0;
            border: 1px solid #E0E0E0;
        }

        .snoopy-avatar .left-ear {
            left: 4px;
            transform: rotate(-20deg);
        }

        .snoopy-avatar .right-ear {
            right: 4px;
            transform: rotate(20deg);
        }

        .snoopy-avatar .snoopy-eyes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .snoopy-avatar .eye {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #000;
            border-radius: 50%;
            top: 8px;
        }

        .snoopy-avatar .left-eye {
            left: 8px;
        }

        .snoopy-avatar .right-eye {
            right: 8px;
        }

        .snoopy-avatar .snoopy-nose {
            position: absolute;
            width: 2px;
            height: 1.5px;
            background: #000;
            border-radius: 50%;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .ai-input-container {
            display: flex;
            gap: 10px;
        }

        .ai-input-field {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .ai-input-field:focus {
            border-color: #667eea;
        }

        .ai-send-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .ai-send-btn:hover {
            background: #5a6fd8;
        }

        .ai-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .ai-typing {
            display: none;
            padding: 10px 15px;
            color: #666;
            font-style: italic;
        }

        .relation-item {
            margin-bottom: 10px;
            padding: 5px;
            background: #f1f8e9;
            border-radius: 4px;
        }

        /* å®ä½“å’Œå…³ç³»ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ */
        .entity-select-container, .relation-type-select-container {
            position: relative;
        }

        .entity-dropdown, .relation-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #b2ebf2;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            margin-top: 2px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        }

        .entity-dropdown.visible, .relation-type-dropdown.visible {
            display: block;
        }

        .dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #e0f7fa;
        }

        .dropdown-item.active {
            background-color: #81c784;
            color: white;
        }

        /* é¢†åŸŸé€‰æ‹©å™¨æ ·å¼ */
        .domain-selector-container {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }

        .domain-info {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            font-size: 12px;
            color: #2e7d32;
            text-align: center;
        }

        #domain-select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #81c784;
            color: #2e7d32;
            font-weight: 500;
        }

        #domain-select:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        /* é¢†åŸŸé€‰æ‹©ä¸‹æ‹‰æ¡†æ ·å¼ */
        .domain-select-container {
            position: relative;
        }

        .domain-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #81c784;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            margin-top: 2px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        }

        .domain-dropdown.visible {
            display: block;
        }

        .domain-dropdown .dropdown-item {
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .domain-dropdown .dropdown-item:hover {
            background-color: #e0f7fa;
        }

        .domain-dropdown .dropdown-item.active {
            background-color: #81c784;
            color: white;
        }

        #domain-select-display {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #81c784;
            color: #2e7d32;
            font-weight: 500;
        }

        #domain-select-display:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="panel left-panel">
            <!-- æ–‡ä»¶æ“ä½œåŒºåŸŸ -->
            <div class="file-operation-group">
                <div class="file-input-container">
                    <button class="btn-secondary" style="width: 100%;">ä¸Šä¼ JSONæ–‡ä»¶</button>
                    <input type="file" id="file-upload" accept=".json">
                </div>

                <button id="save-current-data" class="btn-primary">ä¿å­˜æ–‡ä»¶</button>
                
                <button id="clear-all-data" class="btn-danger" style="width: 100%; margin-top: 10px;">ä¸€é”®æ¸…ç©ºæ•°æ®</button>

                <div id="current-file-info" style="font-size: 12px; color: #546e7a; margin-top: -10px; margin-bottom: 10px; display: none;">
                    å½“å‰æ–‡ä»¶: <span id="current-file-name">-</span>
                </div>
            </div>

            <div class="form-section">
                <h3 id="entity-form-title" class="list-title">æ·»åŠ å®ä½“</h3>
                <div class="form-group">
                    <label for="entity-domain">å›¾è°±é¢†åŸŸ</label>
                    <select id="entity-domain">
                        <option value="default">é»˜è®¤é¢†åŸŸ</option>
                        <option value="technology">æŠ€æœ¯é¢†åŸŸ</option>
                        <option value="medicine">åŒ»å­¦é¢†åŸŸ</option>
                        <option value="finance">é‡‘èé¢†åŸŸ</option>
                        <option value="education">æ•™è‚²é¢†åŸŸ</option>
                        <option value="culture">æ–‡åŒ–é¢†åŸŸ</option>
                        <option value="custom">è‡ªå®šä¹‰é¢†åŸŸ</option>
                    </select>
                    <input type="text" id="custom-domain" placeholder="è¾“å…¥è‡ªå®šä¹‰é¢†åŸŸåç§°" style="display: none; margin-top: 5px; width: 100%;">
                </div>
                <div class="form-group">
                    <label for="entity-id">å®ä½“ID</label>
                    <input type="text" id="entity-id" placeholder="è¾“å…¥å”¯ä¸€ID">
                </div>
                <div class="form-group">
                    <label for="entity-name">å®ä½“åç§°</label>
                    <input type="text" id="entity-name" placeholder="è¾“å…¥å®ä½“åç§°">
                </div>
                <div class="form-group">
                    <label for="entity-desc">å®ä½“æè¿°</label>
                    <textarea id="entity-desc" rows="3" placeholder="è¾“å…¥å®ä½“æè¿°"></textarea>
                </div>
                <div class="btn-group">
                    <button id="add-entity" class="btn-primary">æ·»åŠ å®ä½“</button>
                    <button id="update-entity" class="btn-primary" style="display: none;">æ›´æ–°å®ä½“</button>
                    <button id="cancel-edit" class="btn-secondary" style="display: none;">å–æ¶ˆ</button>
                    <button id="clear-entity-form" class="btn-secondary">æ¸…ç©º</button>
                </div>
            </div>

            <div class="form-section" style="margin-top: 30px;">
                <h3 class="list-title">æ·»åŠ å…³ç³»</h3>
                <div class="form-group">
                    <label for="source-entity-display">æºå®ä½“</label>
                    <div class="entity-select-container">
                        <input type="text" id="source-entity-display" placeholder="é€‰æ‹©æˆ–æœç´¢æºå®ä½“">
                        <input type="hidden" id="source-entity" value="">
                        <div class="entity-dropdown" id="source-entity-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="target-entity-display">ç›®æ ‡å®ä½“</label>
                    <div class="entity-select-container">
                        <input type="text" id="target-entity-display" placeholder="é€‰æ‹©æˆ–æœç´¢ç›®æ ‡å®ä½“">
                        <input type="hidden" id="target-entity" value="">
                        <div class="entity-dropdown" id="target-entity-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="relation-type-display">å…³ç³»ç±»å‹</label>
                    <div class="relation-type-select-container">
                        <input type="text" id="relation-type-display" placeholder="è¾“å…¥æˆ–é€‰æ‹©å…³ç³»ç±»å‹">
                        <input type="hidden" id="relation-type" value="">
                        <div class="relation-type-dropdown" id="relation-type-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edge-type">è¾¹ç±»å‹</label>
                    <select id="edge-type" class="form-control">
                        <option value="solid-arrow">å®çº¿ + å®å¿ƒé»‘è‰²ä¸‰è§’ç®­å¤´</option>
                        <option value="dashed-arrow">è™šçº¿ + å®å¿ƒé»‘è‰²ä¸‰è§’ç®­å¤´</option>
                        <option value="solid-triangle">å®çº¿ + ç©ºå¿ƒä¸‰è§’ç®­å¤´</option>
                        <option value="dashed-triangle">è™šçº¿ + ç©ºå¿ƒä¸‰è§’ç®­å¤´</option>
                        <option value="hollow-diamond">å®çº¿ + ç©ºå¿ƒè±å½¢</option>
                        <option value="solid-diamond">å®çº¿ + å®å¿ƒé»‘è‰²è±å½¢</option> 
                    </select>
                </div>
                <div class="btn-group">
                    <button id="add-relation" class="btn-primary">æ·»åŠ å…³ç³»</button>
                    <button id="clear-relation-form" class="btn-secondary">æ¸…ç©º</button>
                </div>
            </div>

            <div class="entity-list">
                <h3 class="list-title">å®ä½“åˆ—è¡¨</h3>
                <div id="entities-container">
                    <div class="no-data">æš‚æ— å®ä½“æ•°æ®</div>
                </div>
            </div>
        </div>

        <div class="visualization-panel">
            <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <div class="mode-switcher">
                <button class="mode-btn preview active" onclick="switchToPreviewMode()">é¢„è§ˆæ¨¡å¼</button>
                <button class="mode-btn data" onclick="switchToDataMode()">æ•°æ®æ¨¡å¼</button>
                <button id="refresh-data" class="mode-btn refresh" onclick="refreshDataFromDatabase()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>
            
            <!-- é¢„è§ˆæ¨¡å¼å†…å®¹ -->
            <div id="preview-mode" class="preview-mode">
            <div id="graph-container"></div>
            <!-- æ–°å¢ï¼šå®ä½“æ‚¬æµ®ä¿¡æ¯æ¡† -->
            <div id="entity-tooltip" class="entity-tooltip">
                <h4 id="tooltip-title"></h4>
                <p><strong>IDï¼š</strong><span id="tooltip-id"></span></p>
                <p><strong>é¢†åŸŸï¼š</strong><span id="tooltip-domain"></span></p>
                <p><strong>æè¿°ï¼š</strong><span id="tooltip-desc"></span></p>
            </div>
            
            <!-- å®ä½“å³é”®æ“ä½œèœå• -->
            <div id="context-menu" class="context-menu">
                <div class="menu-item" id="edit-entity-menu">
                    <span class="menu-icon">âœï¸</span>
                    <span class="menu-text">ç¼–è¾‘å®ä½“</span>
                </div>
                <div class="menu-item" id="copy-entity-menu">
                    <span class="menu-icon">ğŸ“‹</span>
                    <span class="menu-text">å¤åˆ¶å®ä½“</span>
                </div>
                <div class="menu-item" id="copy-5-entities-menu">
                    <span class="menu-icon">ğŸ“‹</span>
                    <span class="menu-text">å¤åˆ¶5ä¸ªå®ä½“</span>
                </div>
                <div class="menu-item" id="add-relation-menu">
                    <span class="menu-icon">ğŸ”—</span>
                    <span class="menu-text">æ–°å¢å…³ç³»</span>
                </div>
                <div class="menu-item" id="delete-entity-menu">
                    <span class="menu-icon">ğŸ—‘ï¸</span>
                    <span class="menu-text">åˆ é™¤å®ä½“</span>
                </div>
            </div>
            
            <!-- å…³ç³»å³é”®æ“ä½œèœå• -->
            <div id="relation-context-menu" class="context-menu">
                <div class="menu-item" id="edit-relation-menu">
                    <span class="menu-icon">âœï¸</span>
                    <span class="menu-text">ç¼–è¾‘å…³ç³»</span>
                </div>
                <div class="menu-item" id="delete-relation-menu">
                    <span class="menu-icon">ğŸ—‘ï¸</span>
                    <span class="menu-text">åˆ é™¤å…³ç³»</span>
                </div>
            </div>
            <!-- åŸæœ‰æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <div class="control-btn" id="zoom-in" title="æ”¾å¤§">+</div>
                <div class="control-btn" id="zoom-out" title="ç¼©å°">-</div>
                <div class="control-btn" id="fit-view" title="é€‚é…æ˜¾ç¤º">âŸ²</div>
                <div class="control-btn" id="reset-view" title="é‡ç½®å¸ƒå±€">âŸ³</div>
                </div>
            </div>
            
            <!-- æ•°æ®æ¨¡å¼å†…å®¹ -->
            <div id="data-mode" class="data-editor">
                <h3 style="margin-bottom: 15px; color: #333;">çŸ¥è¯†å›¾è°±æ•°æ®ç¼–è¾‘å™¨</h3>
                <div id="data-mode-info" style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 14px;">
                    <strong>å½“å‰ç¼–è¾‘èŒƒå›´ï¼š</strong><span id="edit-scope">æ‰€æœ‰é¢†åŸŸ</span><br>
                    <small style="color: #666; margin-top: 5px; display: block;">ğŸ’¡ æ•°æ®æ¨¡å¼ä¸‹é¢†åŸŸç­›é€‰åŠŸèƒ½å·²ç¦ç”¨ï¼Œç¼–è¾‘èŒƒå›´åŸºäºè¿›å…¥æ•°æ®æ¨¡å¼æ—¶çš„é¢†åŸŸé€‰æ‹©</small>
                </div>
                <div id="custom-domain-tip" class="custom-domain-info" style="display: none;">
                    æ£€æµ‹åˆ°è‡ªå®šä¹‰é¢†åŸŸï¼Œå¯ä»¥ç”Ÿæˆåˆå§‹åŒ–æ•°æ®ä½œä¸ºèµ·ç‚¹ï¼Œæˆ–ç›´æ¥ç¼–è¾‘ç©ºç™½æ•°æ®ã€‚
                </div>
                
                <!-- ç®€åŒ–çš„JSONç¼–è¾‘å™¨ -->
                <textarea id="json-editor" class="simple-json-editor" placeholder="JSONæ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."></textarea>
                
                <div class="data-controls">
                    <button class="data-btn reorder" onclick="reorderEntityIds()">é‡æ–°æ’åº</button>
                    <button class="data-btn suffix" onclick="addSuffixToIds()">æ·»åŠ åç¼€</button>
                    <button class="data-btn save" onclick="saveJsonData()">ä¿å­˜åˆ°æ•°æ®åº“</button>
                    <button class="data-btn cancel" onclick="cancelDataEdit()">å–æ¶ˆç¼–è¾‘</button>
                </div>
            </div>
        </div>

        <div class="panel right-panel">
            <!-- é¢†åŸŸé€‰æ‹©åŒºåŸŸ -->
            <div class="domain-selector-container">
                <h3 class="list-title">é¢†åŸŸç­›é€‰</h3>
                <div class="form-group">
                    <label for="domain-select">é€‰æ‹©é¢†åŸŸ</label>
                    <div class="domain-select-container">
                        <input type="text" id="domain-select-display" placeholder="è¾“å…¥æˆ–é€‰æ‹©é¢†åŸŸ">
                        <input type="hidden" id="domain-select" value="all">
                        <div class="domain-dropdown" id="domain-dropdown"></div>
                    </div>
                </div>
                <div class="domain-info">
                    <span id="current-domain-info">å½“å‰æ˜¾ç¤ºï¼šæ‰€æœ‰é¢†åŸŸ</span>
                </div>
            </div>

            <div class="search-container">
                <!-- æœç´¢ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                <div class="search-type-container">
                    <select id="search-type">
                        <option value="entityId">å®ä½“ID</option>
                        <option value="entityName" selected>å®ä½“åç§°</option>
                        <option value="entityDesc">å®ä½“æè¿°</option>
                        <option value="relation">å…³ç³»ç±»å‹</option>
                    </select>
                </div>
                <div class="search-input-group">
                    <div class="search-input-container">
                        <input type="text" id="search-input" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹...">
                        <div id="search-suggestions" class="search-suggestions"></div>
                    </div>
                    <button id="search-btn" class="btn-primary">æœç´¢</button>
                </div>
            </div>
            <div id="search-results-info" class="search-results-info"></div>
            <div id="detail-view">
                <div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
        </div>
    </div>

    <!-- AIé—®ç­”æœºå™¨äºº -->
    <div class="ai-chatbot" onclick="toggleAIChat()">
        <div class="snoopy-icon">
            <div class="snoopy-head"></div>
            <div class="snoopy-ears">
                <div class="ear left-ear"></div>
                <div class="ear right-ear"></div>
            </div>
            <div class="snoopy-eyes">
                <div class="eye left-eye"></div>
                <div class="eye right-eye"></div>
            </div>
            <div class="snoopy-nose"></div>
            <div class="snoopy-mouth"></div>
        </div>
    </div>

    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                <div class="snoopy-title-avatar">
                    <div class="snoopy-head"></div>
                    <div class="snoopy-ears">
                        <div class="ear left-ear"></div>
                        <div class="ear right-ear"></div>
                    </div>
                    <div class="snoopy-eyes">
                        <div class="eye left-eye"></div>
                        <div class="eye right-eye"></div>
                    </div>
                    <div class="snoopy-nose"></div>
                </div>
                å²åŠªæ¯”AIåŠ©æ‰‹
            </div>
            <div class="ai-chat-controls">
                <div class="ai-switch-container">
                    <span class="ai-switch-label">AIæ¨¡å¼</span>
                    <div class="ai-switch" id="aiSwitch" onclick="toggleAISwitch()">
                        <div class="ai-switch-slider" id="aiSwitchSlider"></div>
                        <div class="ai-switch-text" id="aiSwitchText">å¤–éƒ¨</div>
                    </div>
                </div>
            </div>
            <div class="ai-chat-close" onclick="toggleAIChat()">Ã—</div>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message bot">
                <div class="ai-message-avatar">
                    <div class="snoopy-avatar">
                        <div class="snoopy-head"></div>
                        <div class="snoopy-ears">
                            <div class="ear left-ear"></div>
                            <div class="ear right-ear"></div>
                        </div>
                        <div class="snoopy-eyes">
                            <div class="eye left-eye"></div>
                            <div class="eye right-eye"></div>
                        </div>
                        <div class="snoopy-nose"></div>
                    </div>
                </div>
                <div class="ai-message-content">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯å²åŠªæ¯”AIåŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®æ‚¨åˆ†æå›¾è°±æ•°æ®ã€æŸ¥æ‰¾å®ä½“å…³ç³»ã€å›ç­”å…³äºçŸ¥è¯†å›¾è°±çš„é—®é¢˜ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥ä¸ºæ‚¨æœåŠ¡çš„å—ï¼Ÿ
                </div>
            </div>
        </div>
        <div class="ai-typing" id="aiTyping">AIæ­£åœ¨æ€è€ƒä¸­...</div>
        <div class="ai-chat-input">
            <div class="ai-input-container">
                <input type="text" class="ai-input-field" id="aiInputField" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleAIKeyPress(event)">
                <button class="ai-send-btn" onclick="sendAIMessage()" id="aiSendBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // APIåŸºç¡€URL
        const API_BASE_URL = '/api/kg';
        
        // APIè°ƒç”¨å‡½æ•°
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const result = await response.json();
                
                if (result.ret === 0) {
                    return result;
                } else {
                    throw new Error(result.msg || 'APIè°ƒç”¨å¤±è´¥');
                }
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                throw error;
            }
        }
        
        // æ ¹æ®å…³ç³»ç±»å‹è‡ªåŠ¨è®¾ç½®è¾¹ç±»å‹
        function getEdgeTypeForRelation(relationType) {
            const mapping = {
                'ç»§æ‰¿': 'solid-triangle',        // ç©ºå¿ƒä¸‰è§’ç®­å¤´
                'æ³›åŒ–': 'solid-triangle',        // ç©ºå¿ƒä¸‰è§’ç®­å¤´
                'å®ç°': 'dashed-triangle',       // è™šçº¿ç©ºå¿ƒä¸‰è§’ç®­å¤´
                'å…³è”': 'solid-arrow',           // å®çº¿ç®­å¤´
                'èšåˆ': 'hollow-diamond',        // ç©ºå¿ƒè±å½¢
                'ç»„åˆ': 'solid-diamond',        // å®å¿ƒè±å½¢
                'ä¾èµ–': 'dashed-arrow',          // è™šçº¿ç®­å¤´
                'å¤šæ€': 'solid-arrow',           // å®çº¿ç®­å¤´
                'åµŒå¥—ç±»': 'solid-arrow',         // å®çº¿ç®­å¤´
                'å‹å…ƒ': 'solid-arrow',           // å®çº¿ç®­å¤´
                'æ³›å‹': 'solid-arrow',           // å®çº¿ç®­å¤´
                'å…³è”ç±»': 'solid-arrow',         // å®çº¿ç®­å¤´
                'è§’è‰²é™å®šå…³è”': 'solid-arrow'    // å®çº¿ç®­å¤´
            };
            return mapping[relationType] || 'solid-arrow';
        }

        // æ£€æµ‹å’Œå¤„ç†é‡å¤å…³ç³»
        function processDuplicateRelations(links) {
            const processedLinks = [];
            const relationMap = new Map();
            
            links.forEach(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                const relationKey = `${sourceId}-${targetId}`;
                const reverseKey = `${targetId}-${sourceId}`;
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–¹å‘çš„å…³ç³»
                if (relationMap.has(relationKey)) {
                    console.warn(`å‘ç°é‡å¤å…³ç³»: ${relationKey} (${link.type})`);
                    // å¯ä»¥é€‰æ‹©ä¿ç•™ç¬¬ä¸€ä¸ªæˆ–åˆå¹¶æè¿°
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åå‘å…³ç³»
                if (relationMap.has(reverseKey)) {
                    console.warn(`å‘ç°åå‘å…³ç³»: ${relationKey} ä¸ ${reverseKey}`);
                    // å¯¹äºæŸäº›å…³ç³»ç±»å‹ï¼ŒåŒå‘å…³ç³»æ˜¯åˆç†çš„ï¼ˆå¦‚å¤šæ€ï¼‰
                    if (link.type === 'å¤šæ€' || link.type === 'å…³è”') {
                        // å…è®¸åŒå‘å…³ç³»ï¼Œä½†æ·»åŠ æ ‡è®°
                        link.isBidirectional = true;
                    }
                }
                
                relationMap.set(relationKey, link);
                processedLinks.push(link);
            });
            
            return processedLinks;
        }

        // è·å–å›¾è°±æ•°æ®
        async function loadGraphData() {
            try {
                const result = await apiCall('/data');
                graphData = result.data;
                
                // ç¡®ä¿æ•°æ®åŒ…å«é¢†åŸŸä¿¡æ¯
                graphData.nodes = graphData.nodes.map(node => ({
                    ...node,
                    domain: node.domain || 'default'
                }));
                
                // å¤„ç†é‡å¤å…³ç³»
                graphData.links = processDuplicateRelations(graphData.links);
                
                graphData.links = graphData.links.map(link => ({
                    ...link,
                    domain: link.domain || 'default',
                    edgeType: link.edgeType || getEdgeTypeForRelation(link.type)  // è‡ªåŠ¨è®¾ç½®è¾¹ç±»å‹
                }));
                
                // è°ƒè¯•ï¼šæ£€æŸ¥æ‰€æœ‰å…³ç³»çš„è¾¹ç±»å‹è®¾ç½®
                console.log('æ‰€æœ‰å…³ç³»ç±»å‹:', [...new Set(graphData.links.map(l => l.type))]);
                
                const compositionLinks = graphData.links.filter(link => link.type === 'ç»„åˆ');
                if (compositionLinks.length > 0) {
                    console.log('ç»„åˆå…³ç³»è°ƒè¯•:', compositionLinks.map(link => ({
                        id: link.id,
                        type: link.type,
                        edgeType: link.edgeType,
                        source: link.source,
                        target: link.target
                    })));
                }
                
                const dependencyLinks = graphData.links.filter(link => link.type === 'ä¾èµ–');
                if (dependencyLinks.length > 0) {
                    console.log('ä¾èµ–å…³ç³»è°ƒè¯•:', dependencyLinks.map(link => ({
                        id: link.id,
                        type: link.type,
                        edgeType: link.edgeType,
                        source: link.source,
                        target: link.target
                    })));
                }
                
                // åŒæ—¶æ›´æ–° allGraphData å’Œ filteredGraphData
                allGraphData = {
                    nodes: [...graphData.nodes],
                    links: [...graphData.links]
                };
                filteredGraphData = {
                    nodes: [...graphData.nodes],
                    links: [...graphData.links]
                };
                
                console.log('ä»åç«¯åŠ è½½æ•°æ®æˆåŠŸ:', {
                    graphData: graphData,
                    allGraphData: allGraphData,
                    domains: [...new Set(graphData.nodes.map(n => n.domain))]
                });
                return true;
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }
        
        // åˆ›å»ºå®ä½“
        async function createEntity(entityData) {
            try {
                const result = await apiCall('/entities', 'POST', entityData);
                console.log('åˆ›å»ºå®ä½“æˆåŠŸ:', result);
                return true;
            } catch (error) {
                console.error('åˆ›å»ºå®ä½“å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ›´æ–°å®ä½“
        async function updateEntityAPI(entityId, entityData) {
            try {
                const result = await apiCall(`/entities/${entityId}`, 'PUT', entityData);
                console.log('æ›´æ–°å®ä½“æˆåŠŸ:', result);
                return true;
            } catch (error) {
                console.error('æ›´æ–°å®ä½“å¤±è´¥:', error);
                return false;
            }
        }
        
        // åˆ é™¤å®ä½“
        async function deleteEntityAPI(entityId) {
            try {
                const result = await apiCall(`/entities/${entityId}`, 'DELETE');
                console.log('åˆ é™¤å®ä½“æˆåŠŸ:', result);
                return true;
            } catch (error) {
                console.error('åˆ é™¤å®ä½“å¤±è´¥:', error);
                return false;
            }
        }
        
        // åˆ›å»ºå…³ç³»
        async function createRelationship(relationshipData) {
            try {
                const result = await apiCall('/relationships', 'POST', relationshipData);
                console.log('åˆ›å»ºå…³ç³»æˆåŠŸ:', result);
                return result; // è¿”å›APIå“åº”ç»“æœï¼ŒåŒ…å«å…³ç³»ID
            } catch (error) {
                console.error('åˆ›å»ºå…³ç³»å¤±è´¥:', error);
                return false;
            }
        }
        
        // åˆ é™¤å…³ç³»
        async function deleteRelationshipAPI(relationshipId) {
            try {
                console.log('è°ƒç”¨åˆ é™¤å…³ç³»APIï¼ŒID:', relationshipId);
                const result = await apiCall(`/relationships/${relationshipId}`, 'DELETE');
                console.log('åˆ é™¤å…³ç³»æˆåŠŸ:', result);
                return true;
            } catch (error) {
                console.error('åˆ é™¤å…³ç³»å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                return false;
            }
        }
        
        // å¯¼å…¥æ•°æ®
        async function importGraphData(data) {
            try {
                const result = await apiCall('/import', 'POST', {
                    nodes: data.nodes,
                    links: data.links,
                    overwrite: true
                });
                console.log('å¯¼å…¥æ•°æ®æˆåŠŸ:', result);
                return true;
            } catch (error) {
                console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportGraphData() {
            try {
                const result = await apiCall('/export');
                console.log('å¯¼å‡ºæ•°æ®æˆåŠŸ:', result);
                return result.data;
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                return null;
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllDataAPI() {
            try {
                const result = await apiCall('/clear-all', 'POST');
                console.log('æ¸…ç©ºæ•°æ®æˆåŠŸ:', result);
                return result;
            } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                return null;
            }
        }

        // å…¨å±€å˜é‡
        let graphData = { nodes: [], links: [] };
        let svg = null;
        let simulation = null;
        let transform = d3.zoomIdentity;
        let zoom = null; // ç¼©æ”¾è¡Œä¸ºå¯¹è±¡
        let selectedNode = null;
        let selectedLink = null; // å½“å‰é€‰ä¸­çš„å…³ç³»
        let editingEntityId = null; // å½“å‰ç¼–è¾‘çš„å®ä½“ID
        let editingLinkIndex = -1; // å½“å‰ç¼–è¾‘çš„å…³ç³»ç´¢å¼•
        let searchResults = []; // å­˜å‚¨æœç´¢ç»“æœ
        let currentResultIndex = -1; // å½“å‰æ˜¾ç¤ºçš„ç»“æœç´¢å¼•
        let lastSearchKeyword = ''; // ä¸Šä¸€æ¬¡æœç´¢çš„å…³é”®å­—
        let lastSearchType = 'entityName'; // ä¸Šä¸€æ¬¡æœç´¢çš„ç±»å‹
        let linkElements = null; // å­˜å‚¨è¿çº¿å…ƒç´ å¼•ç”¨ï¼Œç”¨äºé«˜äº®
        let linkLabelElements = null; // å­˜å‚¨è¿çº¿æ ‡ç­¾å¼•ç”¨ï¼Œç”¨äºé«˜äº®
        let nodeGroups = null; // å­˜å‚¨èŠ‚ç‚¹ç»„å¼•ç”¨ï¼Œç”¨äºé«˜äº®
        let arrowElements = null; // å­˜å‚¨ç®­å¤´å…ƒç´ å¼•ç”¨
        let currentFilePath = null; // å½“å‰æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„
        let usedRelationTypes = new Set(); // å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹é›†åˆ
        let currentDomain = 'all'; // å½“å‰é€‰ä¸­çš„é¢†åŸŸ
        let allGraphData = { nodes: [], links: [] }; // å­˜å‚¨æ‰€æœ‰æ•°æ®
        let filteredGraphData = { nodes: [], links: [] }; // å­˜å‚¨ç­›é€‰åçš„æ•°æ®
        let searchSuggestions = []; // å­˜å‚¨æœç´¢å»ºè®®
        let searchTimer = null; // æœç´¢é˜²æŠ–å®šæ—¶å™¨

        // DOMå…ƒç´ 
        const entityDomainSelect = document.getElementById('entity-domain');
        const customDomainInput = document.getElementById('custom-domain');
        const entityIdInput = document.getElementById('entity-id');
        const entityNameInput = document.getElementById('entity-name');
        const entityDescInput = document.getElementById('entity-desc');
        const addEntityBtn = document.getElementById('add-entity');
        const updateEntityBtn = document.getElementById('update-entity');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const clearEntityFormBtn = document.getElementById('clear-entity-form');
        const sourceEntityInput = document.getElementById('source-entity');
        const sourceEntityDisplay = document.getElementById('source-entity-display');
        const sourceEntityDropdown = document.getElementById('source-entity-dropdown');
        const targetEntityInput = document.getElementById('target-entity');
        const targetEntityDisplay = document.getElementById('target-entity-display');
        const targetEntityDropdown = document.getElementById('target-entity-dropdown');
        const relationTypeInput = document.getElementById('relation-type');
        const relationTypeDisplay = document.getElementById('relation-type-display');
        const relationTypeDropdown = document.getElementById('relation-type-dropdown');
        const addRelationBtn = document.getElementById('add-relation');
        const clearRelationFormBtn = document.getElementById('clear-relation-form');
        const entitiesContainer = document.getElementById('entities-container');
        const detailView = document.getElementById('detail-view');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchTypeSelect = document.getElementById('search-type');
        const searchResultsInfo = document.getElementById('search-results-info');
        const searchSuggestionsEl = document.getElementById('search-suggestions');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const fitViewBtn = document.getElementById('fit-view');
        const resetViewBtn = document.getElementById('reset-view');
        const entityFormTitle = document.getElementById('entity-form-title');
        const fileUploadInput = document.getElementById('file-upload');
        const saveCurrentDataBtn = document.getElementById('save-current-data');
        const currentFileInfo = document.getElementById('current-file-info');
        const currentFileName = document.getElementById('current-file-name');
        const domainSelect = document.getElementById('domain-select');
        const domainSelectDisplay = document.getElementById('domain-select-display');
        const domainDropdown = document.getElementById('domain-dropdown');
        const currentDomainInfo = document.getElementById('current-domain-info');

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initialize);

        // åˆå§‹åŒ–å‡½æ•°
        async function initialize() {
            console.log('ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹');
            
            // å°è¯•ä»åç«¯åŠ è½½æ•°æ®
            const loadSuccess = await loadGraphData();
            
            if (!loadSuccess) {
                console.log('ä»åç«¯åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                // åˆå§‹åŒ–é»˜è®¤æ•°æ®
                graphData = {
                    nodes: [
                        { id: "1", name: "äººå·¥æ™ºèƒ½", description: "ç ”ç©¶å¦‚ä½•ä½¿æœºå™¨æ¨¡æ‹Ÿäººç±»æ™ºèƒ½çš„ç§‘å­¦", domain: "ai_domain" },
                        { id: "2", name: "æœºå™¨å­¦ä¹ ", description: "äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯", domain: "ai_domain" },
                        { id: "3", name: "æ·±åº¦å­¦ä¹ ", description: "æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯", domain: "ai_domain" },
                        { id: "4", name: "ç¥ç»ç½‘ç»œ", description: "å—äººè„‘ç»“æ„å¯å‘çš„è®¡ç®—æ¨¡å‹", domain: "ai_domain" },
                        { id: "5", name: "è®¡ç®—æœºè§†è§‰", description: "ä½¿è®¡ç®—æœºèƒ½å¤Ÿä»å›¾åƒä¸­è·å–ç†è§£çš„é¢†åŸŸ", domain: "ai_domain" },
                        { id: "6", name: "å¿ƒè„ç—…", description: "å¿ƒè„ç–¾ç—…çš„æ€»ç§°", domain: "medical_domain" },
                        { id: "7", name: "é«˜è¡€å‹", description: "è¡€å‹æŒç»­å‡é«˜çš„ç–¾ç—…", domain: "medical_domain" },
                        { id: "8", name: "ç³–å°¿ç—…", description: "è¡€ç³–ä»£è°¢å¼‚å¸¸çš„ç–¾ç—…", domain: "medical_domain" },
                        { id: "9", name: "è‚¡ç¥¨æŠ•èµ„", description: "è´­ä¹°è‚¡ç¥¨è¿›è¡ŒæŠ•èµ„çš„è¡Œä¸º", domain: "finance_domain" },
                        { id: "10", name: "åŸºé‡‘ç†è´¢", description: "é€šè¿‡åŸºé‡‘è¿›è¡Œç†è´¢æŠ•èµ„", domain: "finance_domain" },
                        { id: "11", name: "åœ¨çº¿æ•™è‚²", description: "é€šè¿‡ç½‘ç»œè¿›è¡Œçš„æ•™è‚²æ´»åŠ¨", domain: "education_domain" },
                        { id: "12", name: "ç¼–ç¨‹è¯­è¨€", description: "ç”¨äºç¼–å†™è®¡ç®—æœºç¨‹åºçš„è¯­è¨€", domain: "tech_domain" }
                    ],
                    links: [
                        { source: "1", target: "2", type: "åŒ…å«", domain: "ai_domain" },
                        { source: "2", target: "3", type: "åŒ…å«", domain: "ai_domain" },
                        { source: "3", target: "4", type: "åŸºäº", domain: "ai_domain" },
                        { source: "1", target: "5", type: "åŒ…å«", domain: "ai_domain" },
                        { source: "5", target: "3", type: "åº”ç”¨", domain: "ai_domain" },
                        { source: "6", target: "7", type: "ç›¸å…³", domain: "medical_domain" },
                        { source: "7", target: "8", type: "å¹¶å‘ç—‡", domain: "medical_domain" },
                        { source: "9", target: "10", type: "æ›¿ä»£", domain: "finance_domain" },
                        { source: "11", target: "12", type: "ä½¿ç”¨", domain: "education_domain" },
                        { source: "1", target: "12", type: "åº”ç”¨", domain: "ai_domain" }
                    ]
                };
            }

            // å¦‚æœä»åç«¯åŠ è½½æ•°æ®å¤±è´¥ï¼Œåˆ™åˆå§‹åŒ–æ•°æ®å­˜å‚¨
            if (!loadSuccess) {
                allGraphData = { 
                    nodes: [...graphData.nodes], 
                    links: [...graphData.links] 
                };
                filteredGraphData = { 
                    nodes: [...graphData.nodes], 
                    links: [...graphData.links] 
                };
                
                console.log('ä½¿ç”¨é»˜è®¤æ•°æ®åˆå§‹åŒ–æ•°æ®å­˜å‚¨:', {
                    allGraphData: allGraphData,
                    graphData: graphData
                });
            } else {
                console.log('ä½¿ç”¨åç«¯æ•°æ®ï¼Œæ•°æ®å­˜å‚¨å·²åœ¨ loadGraphData ä¸­å®Œæˆ');
            }

            // åˆå§‹åŒ–å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹é›†åˆ
            updateUsedRelationTypes();

            updateEntityDropdowns();
            updateRelationTypeDropdown();
            renderEntityList();
            
            // ä½¿ç”¨ä¸switchToPreviewModeç›¸åŒçš„é€»è¾‘åˆå§‹åŒ–å›¾å½¢
            // é‡æ–°å¯ç”¨å³ä¾§é¢æ¿åŠŸèƒ½ï¼ˆè¿™ä¼šè°ƒç”¨resetDomainSelectorå’ŒfilterDataByDomainï¼‰
            enableRightPanel();
            
            // é‡æ–°åˆå§‹åŒ–å›¾å½¢
            if (graphData && graphData.nodes && graphData.nodes.length > 0) {
                // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                console.log('é¡µé¢åˆå§‹åŒ–ï¼Œå½“å‰æ•°æ®:', graphData);
                initializeGraph();
                
                // å»¶è¿Ÿæ‰§è¡Œé€‚é…æ˜¾ç¤ºï¼Œç¡®ä¿å›¾å½¢å·²å®Œå…¨æ¸²æŸ“
                setTimeout(() => {
                    fitView();
                    console.log('é¡µé¢åˆå§‹åŒ–ï¼šå·²æ‰§è¡Œé€‚é…æ˜¾ç¤º');
                }, 500);
            } else {
                console.log('æ²¡æœ‰æ•°æ®ï¼Œé‡æ–°åŠ è½½...');
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé‡æ–°åŠ è½½
                loadGraphData();
            }
            
            setupEventListeners();
            // åˆå§‹åŒ–å®ä½“è¡¨å•é»˜è®¤å€¼
            populateDefaultEntityValues();
            
            // åˆå§‹åŒ–é¢†åŸŸé€‰æ‹©å™¨
            initializeDomainSelector();
            
            // è®¾ç½®åˆå§‹æ˜¾ç¤ºå€¼
            domainSelectDisplay.value = 'æ‰€æœ‰é¢†åŸŸ';
            
            // åˆå§‹åŒ–AIå¼€å…³çŠ¶æ€ï¼ˆé»˜è®¤ä½¿ç”¨å¤–éƒ¨AIï¼‰
            const aiSwitch = document.getElementById('aiSwitch');
            const aiSwitchText = document.getElementById('aiSwitchText');
            aiSwitch.classList.add('active');
            aiSwitchText.textContent = 'å¤–éƒ¨';
            
            // è®¾ç½®JSONç¼–è¾‘å™¨å¿«æ·é”®
            setupJsonEditorShortcuts();
            
            console.log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            console.log('åˆå§‹åŒ–åçš„æ•°æ®çŠ¶æ€:', {
                graphData: {
                    nodes: graphData.nodes.length,
                    links: graphData.links.length,
                    domains: [...new Set(graphData.nodes.map(n => n.domain))]
                },
                allGraphData: {
                    nodes: allGraphData.nodes.length,
                    links: allGraphData.links.length,
                    domains: [...new Set(allGraphData.nodes.map(n => n.domain))]
                }
            });
            
            // é¡µé¢åˆ·æ–°åçš„é¢å¤–é€‚é…æ˜¾ç¤ºï¼Œç¡®ä¿å›¾å½¢æ­£ç¡®æ˜¾ç¤º
            setTimeout(() => {
                if (graphData && graphData.nodes && graphData.nodes.length > 0) {
                    fitView();
                    console.log('é¡µé¢åˆ·æ–°åï¼šå·²æ‰§è¡Œæœ€ç»ˆé€‚é…æ˜¾ç¤º');
                }
            }, 1000);
        }

        // åˆå§‹åŒ–é¢†åŸŸé€‰æ‹©å™¨
        function initializeDomainSelector() {
            // æ›´æ–°é¢†åŸŸä¸‹æ‹‰æ¡†
            updateDomainDropdown(null, '');
            
            // æ›´æ–°é¢†åŸŸä¿¡æ¯æ˜¾ç¤º
            updateDomainInfo();
            
            // æ·»åŠ é¢†åŸŸé€‰æ‹©äº‹ä»¶ç›‘å¬
            domainSelectDisplay.addEventListener('focus', () => {
                domainDropdown.classList.add('visible');
            });

            domainSelectDisplay.addEventListener('input', () => {
                const inputValue = domainSelectDisplay.value.trim();
                const filtered = filterDomains(inputValue);
                updateDomainDropdown(filtered, inputValue);
                domainDropdown.classList.add('visible');
            });

            // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜è‡ªå®šä¹‰è¾“å…¥
            domainSelectDisplay.addEventListener('blur', () => {
                const inputValue = domainSelectDisplay.value.trim();
                if (inputValue) {
                    domainSelect.value = inputValue;
                    currentDomain = inputValue;
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰é¢†åŸŸï¼Œæ›´æ–°æ•°æ®ç­›é€‰
                    filterDataByDomain();
                    updateDomainInfo();
                    setTimeout(() => {
                        domainDropdown.classList.remove('visible');
                    }, 200);
                }
            });

            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.domain-select-container')) {
                    domainDropdown.classList.remove('visible');
                }
            });
        }

        // æ ¹æ®é¢†åŸŸç­›é€‰æ•°æ®
        function filterDataByDomain() {
            console.log('å¼€å§‹é¢†åŸŸç­›é€‰ï¼Œå½“å‰é¢†åŸŸ:', currentDomain);
            console.log('allGraphData åŒ…å«:', {
                nodes: allGraphData.nodes.length,
                links: allGraphData.links.length,
                domains: [...new Set(allGraphData.nodes.map(n => n.domain))]
            });
            
            if (currentDomain === 'all') {
                // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                filteredGraphData = { ...allGraphData };
                console.log('é€‰æ‹©æ‰€æœ‰é¢†åŸŸï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®');
            } else {
                // åªç­›é€‰æŒ‡å®šé¢†åŸŸçš„å®ä½“å’Œå…³ç³»ï¼Œä¸æ˜¾ç¤ºå…¶ä»–é¢†åŸŸçš„å®ä½“
                const filteredNodes = allGraphData.nodes.filter(node => 
                    node.domain === currentDomain
                );
                
                // è·å–ç­›é€‰å‡ºçš„å®ä½“çš„IDé›†åˆ
                const filteredNodeIds = new Set(filteredNodes.map(node => node.id));
                
                // åªè·å–è¯¥é¢†åŸŸå†…å®ä½“ä¹‹é—´çš„å…³ç³»
                const filteredLinks = allGraphData.links.filter(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    // åªæ˜¾ç¤ºä¸¤ä¸ªç«¯ç‚¹éƒ½å±äºè¯¥é¢†åŸŸçš„å…³ç³»
                    return filteredNodeIds.has(sourceId) && filteredNodeIds.has(targetId);
                });
                
                console.log(`ç­›é€‰é¢†åŸŸ "${currentDomain}" çš„æ•°æ®:`, {
                    totalNodes: allGraphData.nodes.length,
                    totalLinks: allGraphData.links.length,
                    filteredNodes: filteredNodes.length,
                    filteredLinks: filteredLinks.length,
                    filteredNodeIds: filteredNodes.map(n => n.id)
                });
                
                filteredGraphData = {
                    nodes: filteredNodes,
                    links: filteredLinks
                };
            }
            
            // æ›´æ–°å½“å‰ä½¿ç”¨çš„æ•°æ®
            graphData = filteredGraphData;
            
            // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹é›†åˆ
            updateUsedRelationTypes();
            
            // æ›´æ–°ç•Œé¢
            updateEntityDropdowns();
            updateRelationTypeDropdown();
            renderEntityList();
            reloadGraph();
            
            // é‡ç½®è¯¦æƒ…è§†å›¾
            detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
            resetSearchState();
            
            console.log(`é¢†åŸŸç­›é€‰å®Œæˆï¼š${currentDomain}ï¼Œå®ä½“æ•°ï¼š${graphData.nodes.length}ï¼Œå…³ç³»æ•°ï¼š${graphData.links.length}`);
        }

        // è·å–å½“å‰æ•°æ®ä¸­çš„æ‰€æœ‰é¢†åŸŸ
        function getAvailableDomains() {
            const domains = new Set();
            
            // ä» allGraphData ä¸­è·å–é¢†åŸŸï¼ˆåŒ…å«æ‰€æœ‰æ•°æ®ï¼‰
            if (allGraphData && allGraphData.nodes) {
                allGraphData.nodes.forEach(node => {
                    if (node.domain) {
                        domains.add(node.domain);
                    }
                });
            }
            
            // ä» allGraphData çš„å…³ç³»ä¸­è·å–é¢†åŸŸ
            if (allGraphData && allGraphData.links) {
                allGraphData.links.forEach(link => {
                    if (link.domain) {
                        domains.add(link.domain);
                    }
                });
            }
            
            const domainList = Array.from(domains).sort();
            console.log('è·å–å¯ç”¨é¢†åŸŸ:', domainList);
            return domainList;
        }

        // è¿‡æ»¤é¢†åŸŸ
        function filterDomains(keyword) {
            const availableDomains = getAvailableDomains();
            
            if (!keyword) {
                return availableDomains;
            }

            const lowerKeyword = keyword.toLowerCase();
            return availableDomains.filter(domain =>
                domain.toLowerCase().includes(lowerKeyword)
            );
        }

        // æ›´æ–°é¢†åŸŸä¸‹æ‹‰æ¡†
        function updateDomainDropdown(filteredDomains = null, inputValue = '') {
            domainDropdown.innerHTML = '';

            const domains = filteredDomains || getAvailableDomains();

            // æ·»åŠ "æ‰€æœ‰é¢†åŸŸ"é€‰é¡¹
            const allItem = document.createElement('div');
            allItem.className = 'dropdown-item';
            allItem.textContent = 'æ‰€æœ‰é¢†åŸŸ';
            allItem.dataset.domain = 'all';
            allItem.addEventListener('click', () => {
                domainSelect.value = 'all';
                domainSelectDisplay.value = 'æ‰€æœ‰é¢†åŸŸ';
                currentDomain = 'all';
                filterDataByDomain();
                updateDomainInfo();
                domainDropdown.classList.remove('visible');
            });
            domainDropdown.appendChild(allItem);

            // 1. è‹¥è¾“å…¥ä¸ä¸ºç©ºä¸”ä¸åœ¨ç°æœ‰é¢†åŸŸä¸­ï¼Œæ·»åŠ "è‡ªå®šä¹‰"é€‰é¡¹
            if (inputValue && inputValue.trim() && !domains.includes(inputValue.trim()) && inputValue.trim() !== 'æ‰€æœ‰é¢†åŸŸ') {
                const customItem = document.createElement('div');
                customItem.className = 'dropdown-item';
                customItem.textContent = `è‡ªå®šä¹‰: ${inputValue.trim()}`;
                customItem.dataset.domain = inputValue.trim();
                customItem.style.color = '#2e7d32'; // é«˜äº®è‡ªå®šä¹‰é€‰é¡¹

                customItem.addEventListener('click', () => {
                    domainSelect.value = inputValue.trim();
                    domainSelectDisplay.value = inputValue.trim();
                    currentDomain = inputValue.trim();
                    filterDataByDomain();
                    updateDomainInfo();
                    domainDropdown.classList.remove('visible');
                });

                domainDropdown.appendChild(customItem);
            }

            // 2. æ·»åŠ è¿‡æ»¤åçš„ç°æœ‰é¢†åŸŸé€‰é¡¹
            if (domains.length === 0 && !inputValue) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'æš‚æ— é¢†åŸŸæ•°æ®';
                emptyItem.style.cursor = 'default';
                emptyItem.style.opacity = '0.7';
                domainDropdown.appendChild(emptyItem);
            } else {
                domains.forEach(domain => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = domain;
                    item.dataset.domain = domain;

                                    item.addEventListener('click', () => {
                    console.log('ç‚¹å‡»é¢†åŸŸé€‰é¡¹:', domain);
                    domainSelect.value = domain;
                    domainSelectDisplay.value = domain;
                    currentDomain = domain;
                    console.log('è®¾ç½®å½“å‰é¢†åŸŸä¸º:', currentDomain);
                    filterDataByDomain();
                    updateDomainInfo();
                    domainDropdown.classList.remove('visible');
                });

                    domainDropdown.appendChild(item);
                });
            }
        }

        // æ›´æ–°é¢†åŸŸä¿¡æ¯æ˜¾ç¤º
        function updateDomainInfo() {
            const domainName = currentDomain === 'all' ? 'æ‰€æœ‰é¢†åŸŸ' : currentDomain;
            currentDomainInfo.textContent = `å½“å‰æ˜¾ç¤ºï¼š${domainName} (${graphData.nodes.length}ä¸ªå®ä½“ï¼Œ${graphData.links.length}ä¸ªå…³ç³»)`;
        }

        // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹é›†åˆ
        function updateUsedRelationTypes() {
            usedRelationTypes.clear();
            graphData.links.forEach(link => {
                usedRelationTypes.add(link.type);
            });
        }

        // æ›´æ–°å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
        function updateRelationTypeDropdown() {
            relationTypeDropdown.innerHTML = '';

            const relationTypes = Array.from(usedRelationTypes).sort();

            if (relationTypes.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'æš‚æ— å…³ç³»ç±»å‹';
                emptyItem.style.cursor = 'default';
                emptyItem.style.opacity = '0.7';
                relationTypeDropdown.appendChild(emptyItem);
                return;
            }

            relationTypes.forEach(type => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = type;
                item.dataset.type = type;

                item.addEventListener('click', () => {
                    relationTypeInput.value = type;
                    relationTypeDisplay.value = type;
                    relationTypeDropdown.classList.remove('visible');
                });

                relationTypeDropdown.appendChild(item);
            });
        }

        // è¿‡æ»¤å…³ç³»ç±»å‹
        function filterRelationTypes(keyword) {
            if (!keyword) {
                return Array.from(usedRelationTypes).sort();
            }

            const lowerKeyword = keyword.toLowerCase();
            return Array.from(usedRelationTypes).filter(type =>
                type.toLowerCase().includes(lowerKeyword)
            );
        }

        // ------------------------------
        // æ–‡ä»¶ä¸Šä¼ ä¸ä¿å­˜åŠŸèƒ½
        // ------------------------------
        function setupFileEventListeners() {
            // ä¸Šä¼ JSONæ–‡ä»¶ - ä¿®å¤çš„å…³é”®éƒ¨åˆ†
            fileUploadInput.addEventListener('change', handleFileUpload);

            // ä¸ºä¸Šä¼ æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè§¦å‘æ–‡ä»¶é€‰æ‹©
            document.querySelector('.file-input-container .btn-secondary').addEventListener('click', () => {
                fileUploadInput.click();
            });

            // ä¿å­˜å½“å‰æ•°æ®åˆ°æœ¬åœ°
            saveCurrentDataBtn.addEventListener('click', saveCurrentData);
        }

        async function handleFileUpload(event) {
            // ç¡®ä¿æœ‰æ–‡ä»¶è¢«é€‰æ‹©
            if (!event.target.files || event.target.files.length === 0) {
                console.log('æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }

            const file = event.target.files[0];
            console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);

            if (!file.name.endsWith('.json')) {
                alert('è¯·ä¸Šä¼ JSONæ ¼å¼çš„æ–‡ä»¶');
                fileUploadInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onloadstart = () => {
                console.log('å¼€å§‹è¯»å–æ–‡ä»¶...');
            };

            reader.onload = async function(e) {
                try {
                    console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¼€å§‹è§£æ');
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.nodes || !importedData.links ||
                        !Array.isArray(importedData.nodes) || !Array.isArray(importedData.links)) {
                        throw new Error('JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œéœ€åŒ…å«nodeså’Œlinksæ•°ç»„');
                    }

                    const validNodes = importedData.nodes.every(node =>
                        node.id !== undefined && node.name !== undefined
                    );
                    if (!validNodes) {
                        throw new Error('èŠ‚ç‚¹æ•°æ®ä¸å®Œæ•´ï¼Œæ¯ä¸ªèŠ‚ç‚¹éœ€åŒ…å«idå’Œnameå­—æ®µ');
                    }

                    const validLinks = importedData.links.every(link =>
                        link.source !== undefined && link.target !== undefined && link.type !== undefined
                    );
                    if (!validLinks) {
                        throw new Error('å…³ç³»æ•°æ®ä¸å®Œæ•´ï¼Œæ¯ä¸ªå…³ç³»éœ€åŒ…å«sourceã€targetå’Œtypeå­—æ®µ');
                    }

                    // å¤„ç†å¯¼å…¥çš„æ•°æ®ï¼Œç¡®ä¿åŒ…å«é¢†åŸŸä¿¡æ¯
                    const processedData = {
                        nodes: importedData.nodes.map(node => ({
                            ...node,
                            domain: node.domain || 'default'
                        })),
                        links: importedData.links.map(link => ({
                            ...link,
                            domain: link.domain || 'default'
                        }))
                    };

                    // è°ƒç”¨åç«¯APIå¯¼å…¥æ•°æ®
                    const success = await importGraphData(processedData);
                    if (success) {
                        // é‡æ–°ä»åç«¯åŠ è½½æ•°æ®
                        await loadGraphData();
                        
                        // æ›´æ–°æ•°æ®å­˜å‚¨
                        allGraphData = { ...graphData };
                        filteredGraphData = { ...graphData };
                        
                        currentFilePath = file.name;
                        currentFileName.textContent = file.name;
                        currentFileInfo.style.display = 'block';

                        // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
                        updateUsedRelationTypes();

                        updateEntityDropdowns();
                        updateRelationTypeDropdown();
                        renderEntityList();
                        reloadGraph();
                        detailView.innerHTML = '<div class="no-data">æ•°æ®å¯¼å…¥æˆåŠŸï¼Œè¯·é€‰æ‹©å®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
                        resetSearchState();
                        // æ›´æ–°å®ä½“è¡¨å•é»˜è®¤å€¼
                        populateDefaultEntityValues();
                        // æ›´æ–°é¢†åŸŸä¿¡æ¯æ˜¾ç¤º
                        updateDomainInfo();
                                    // æ›´æ–°é¢†åŸŸä¸‹æ‹‰æ¡†
            updateDomainDropdown(null, '');
                        alert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${graphData.nodes.length} ä¸ªå®ä½“å’Œ ${graphData.links.length} ä¸ªå…³ç³»`);
                    } else {
                        alert('æ•°æ®å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æå¤±è´¥ï¼š', error);
                    alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
                } finally {
                    // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
                    fileUploadInput.value = '';
                }
            };

            reader.onerror = function() {
                console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', reader.error);
                alert(`æ–‡ä»¶è¯»å–å¤±è´¥: ${reader.error.message}`);
                fileUploadInput.value = '';
            };

            reader.readAsText(file);
        }

        async function saveCurrentData() {
            try {
                // ä»åç«¯å¯¼å‡ºæ•°æ®
                const exportData = await exportGraphData();
                if (!exportData) {
                    alert('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    return;
                }

                // åˆ›å»ºè¾“å…¥æ¡†ç”¨äºè·å–æ–‡ä»¶è·¯å¾„
                const filePath = prompt('è¯·è¾“å…¥ä¿å­˜è·¯å¾„å’Œæ–‡ä»¶åï¼ˆåŒ…å«.jsonæ‰©å±•åï¼‰ï¼š',
                                      currentFilePath || (() => {
                                          const now = new Date();
                                          const year = now.getFullYear();
                                          const month = String(now.getMonth() + 1).padStart(2, '0');
                                          const day = String(now.getDate()).padStart(2, '0');
                                          const hours = String(now.getHours()).padStart(2, '0');
                                          const minutes = String(now.getMinutes()).padStart(2, '0');
                                          const seconds = String(now.getSeconds()).padStart(2, '0');
                                          const timestamp = `${year}${month}${day}_${hours}${minutes}${seconds}`;
                                          return `kg_${timestamp}.json`;
                                      })());

                if (!filePath) {
                    // ç”¨æˆ·å–æ¶ˆè¾“å…¥
                    return;
                }

                // ç¡®ä¿æ–‡ä»¶åä»¥.jsonç»“å°¾
                let fileName = filePath;
                if (!fileName.endsWith('.json')) {
                    fileName += '.json';
                }

                const cleanNodes = exportData.nodes.map(node => ({
                    id: node.id,
                    name: node.name,
                    domain: node.domain || 'default',
                    ...(node.description && node.description.trim() ? { description: node.description } : {})
                }));

                const cleanLinks = exportData.links.map(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;

                    return {
                        source: sourceId,
                        target: targetId,
                        type: link.type,
                        domain: link.domain || 'default'
                    };
                });

                const finalExportData = {
                    nodes: cleanNodes,
                    links: cleanLinks
                };

                const dataStr = JSON.stringify(finalExportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                const link = document.createElement('a');
                link.href = dataUri;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // æ›´æ–°å½“å‰æ–‡ä»¶ä¿¡æ¯
                currentFilePath = fileName;
                currentFileName.textContent = fileName.split(/[\\/]/).pop();
                currentFileInfo.style.display = 'block';

                console.log('å½“å‰æ•°æ®å·²ä¿å­˜åˆ°æ–‡ä»¶');
                alert(`æ•°æ®å·²æˆåŠŸä¿å­˜åˆ° ${fileName}`);
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥ï¼š', error);
                alert(`ä¿å­˜å¤±è´¥ï¼š${error.message}`);
            }
        }

        // ------------------------------
        // å®ä½“ç®¡ç†ï¼ˆæ–°å¢/ä¿®æ”¹/åˆ é™¤ï¼‰
        // ------------------------------

        // ç”Ÿæˆé»˜è®¤çš„å®ä½“IDï¼ˆçŸ­æ•°å­—ï¼‰
        function generateDefaultEntityId() {
            // æŸ¥æ‰¾æœ€å¤§çš„æ•°å­—ID
            let maxId = 0;
            graphData.nodes.forEach(node => {
                const numId = parseInt(node.id, 10);
                if (!isNaN(numId) && numId > maxId) {
                    maxId = numId;
                }
            });
            // è¿”å›ä¸‹ä¸€ä¸ªæ•°å­—ID
            return (maxId + 1).toString();
        }

        // ç”Ÿæˆé»˜è®¤çš„å®ä½“åç§°
        function generateDefaultEntityName() {
            const baseNames = ['å®ä½“', 'æ¦‚å¿µ', 'å¯¹è±¡', 'å…ƒç´ ', 'èŠ‚ç‚¹'];
            const randomName = baseNames[Math.floor(Math.random() * baseNames.length)];
            return `${randomName}${graphData.nodes.length + 1}`;
        }

        // ç”Ÿæˆé»˜è®¤çš„å®ä½“æè¿°
        function generateDefaultEntityDescription() {
            const descriptions = [
                'è¿™æ˜¯ä¸€ä¸ªæ–°å®ä½“',
                'è¯¥å®ä½“çš„åŸºæœ¬æè¿°',
                'ç›¸å…³æ¦‚å¿µçš„è¯´æ˜',
                'æ–°åˆ›å»ºçš„å®ä½“ä¿¡æ¯',
                'å¾…å®Œå–„çš„å®ä½“æè¿°'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        // å¡«å……å®ä½“è¡¨å•çš„é»˜è®¤å€¼
        function populateDefaultEntityValues() {
            if (editingEntityId === null) { // åªæœ‰åœ¨æ·»åŠ æ¨¡å¼ä¸‹æ‰å¡«å……é»˜è®¤å€¼
                entityIdInput.value = generateDefaultEntityId();
                entityNameInput.value = generateDefaultEntityName();
                entityDescInput.value = generateDefaultEntityDescription();
            }
        }

        function updateEntityDropdowns() {
            // æŒ‰æ·»åŠ æ—¶é—´æ’åºï¼Œæœ€è¿‘æ·»åŠ çš„åœ¨å‰é¢
            const sortedEntities = [...graphData.nodes].reverse();

            // æ›´æ–°æºå®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(sourceEntityDropdown, sortedEntities);
            // æ›´æ–°ç›®æ ‡å®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(targetEntityDropdown, sortedEntities);
        }

        function updateEntityDropdown(dropdownElement, entities) {
            dropdownElement.innerHTML = '';

            if (entities.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'æš‚æ— å®ä½“';
                emptyItem.style.cursor = 'default';
                emptyItem.style.opacity = '0.7';
                dropdownElement.appendChild(emptyItem);
                return;
            }

            entities.forEach(entity => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = `${entity.name} (ID: ${entity.id})`;
                item.dataset.id = entity.id;
                item.dataset.name = entity.name;

                item.addEventListener('click', () => {
                    // æ ¹æ®ä¸‹æ‹‰æ¡†ç±»å‹æ›´æ–°å¯¹åº”è¾“å…¥æ¡†
                    if (dropdownElement.id === 'source-entity-dropdown') {
                        sourceEntityInput.value = entity.id;
                        sourceEntityDisplay.value = entity.name;
                        sourceEntityDropdown.classList.remove('visible');
                    } else if (dropdownElement.id === 'target-entity-dropdown') {
                        targetEntityInput.value = entity.id;
                        targetEntityDisplay.value = entity.name;
                        targetEntityDropdown.classList.remove('visible');
                    } else if (dropdownElement.id === 'edit-source-entity-dropdown') {
                        document.getElementById('edit-source-entity').value = entity.id;
                        document.getElementById('edit-source-entity-display').value = entity.name;
                        dropdownElement.classList.remove('visible');
                    } else if (dropdownElement.id === 'edit-target-entity-dropdown') {
                        document.getElementById('edit-target-entity').value = entity.id;
                        document.getElementById('edit-target-entity-display').value = entity.name;
                        dropdownElement.classList.remove('visible');
                    }
                });

                dropdownElement.appendChild(item);
            });
        }

        function filterEntities(keyword) {
            if (!keyword) {
                // å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè¿”å›æŒ‰æ·»åŠ æ—¶é—´æ’åºçš„å®ä½“
                return [...graphData.nodes].reverse();
            }

            const lowerKeyword = keyword.toLowerCase();
            return graphData.nodes.filter(entity =>
                entity.name.toLowerCase().includes(lowerKeyword) ||
                entity.id.toLowerCase().includes(lowerKeyword) ||
                (entity.description && entity.description.toLowerCase().includes(lowerKeyword))
            );
        }

        function renderEntityList() {
            if (graphData.nodes.length === 0) {
                entitiesContainer.innerHTML = '<div class="no-data">æš‚æ— å®ä½“æ•°æ®</div>';
                return;
            }

            entitiesContainer.innerHTML = '';
            graphData.nodes.forEach(node => {
                const entityItem = document.createElement('div');
                entityItem.className = 'entity-item';
                entityItem.innerHTML = `
                    <div class="entity-info">
                        <strong>${node.name}</strong>
                        <span class="entity-domain">[${node.domain || 'default'}]</span>
                        <p>${node.description?.substring(0, 50) || ''}${node.description && node.description.length > 50 ? '...' : ''}</p>
                    </div>
                    <div class="entity-actions">
                        <div class="action-btn edit-btn" title="ç¼–è¾‘" data-id="${node.id}">âœï¸</div>
                        <div class="action-btn copy-btn" title="å¤åˆ¶" data-id="${node.id}">ğŸ“‹</div>
                        <div class="action-btn delete-btn" title="åˆ é™¤" data-id="${node.id}">ğŸ—‘ï¸</div>
                    </div>
                `;
                // æ·»åŠ å®ä½“æŒ‰é’®äº‹ä»¶
                entityItem.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentMode === 'data') {
                        alert('æ•°æ®æ¨¡å¼ä¸‹ç¼–è¾‘åŠŸèƒ½å·²ç¦ç”¨');
                        return;
                    }
                    startEditEntity(node.id);
                });
                // å¤åˆ¶æŒ‰é’®äº‹ä»¶
                entityItem.querySelector('.copy-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentMode === 'data') {
                        alert('æ•°æ®æ¨¡å¼ä¸‹å¤åˆ¶åŠŸèƒ½å·²ç¦ç”¨');
                        return;
                    }
                    copyEntityWithRelation(node.id);
                });
                // åˆ é™¤å®ä½“æŒ‰é’®äº‹ä»¶
                entityItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentMode === 'data') {
                        alert('æ•°æ®æ¨¡å¼ä¸‹åˆ é™¤åŠŸèƒ½å·²ç¦ç”¨');
                        return;
                    }
                    deleteEntity(node.id);
                });
                entityItem.addEventListener('click', () => {
                    if (currentMode === 'data') {
                        alert('æ•°æ®æ¨¡å¼ä¸‹å®ä½“è¯¦æƒ…æŸ¥çœ‹å·²ç¦ç”¨');
                        return;
                    }
                    showEntityDetail(node);
                    centerNodeInView(node.id);
                    resetSearchState();
                    // é«˜äº®é€‰ä¸­çš„å®ä½“
                    clearAllHighlights();
                    nodeGroups.filter(d => d.id === node.id).classed('highlighted', true);
                });
                entitiesContainer.appendChild(entityItem);
            });
            
            // å¦‚æœåœ¨æ•°æ®æ¨¡å¼ä¸‹ï¼Œç¦ç”¨æ‰€æœ‰æ–°ç”Ÿæˆçš„æŒ‰é’®å’Œå®ä½“é¡¹
            if (currentMode === 'data') {
                const actionButtons = entitiesContainer.querySelectorAll('.action-btn');
                actionButtons.forEach(btn => {
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.3';
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'æ•°æ®æ¨¡å¼ä¸‹å·²ç¦ç”¨';
                });
                
                // ç¦ç”¨å®ä½“åˆ—è¡¨é¡¹çš„ç‚¹å‡»
                const entityItems = entitiesContainer.querySelectorAll('.entity-item');
                entityItems.forEach(item => {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.7';
                    item.style.cursor = 'not-allowed';
                });
            }
        }

        function startEditEntity(id) {
            const entity = graphData.nodes.find(n => n.id === id);
            if (!entity) return;

            editingEntityId = id;
            
            // é‡æ–°æ˜¾ç¤ºå®ä½“è¯¦æƒ…ï¼Œè¿™æ¬¡ä¼šåŒ…å«ç¼–è¾‘è¡¨å•
            showEntityDetail(entity);
        }



        function cancelEdit() {
            editingEntityId = null;
            editingLinkIndex = -1;
            entityFormTitle.textContent = 'æ·»åŠ å®ä½“'; // é‡ç½®ä¸ºé»˜è®¤æ ‡é¢˜
            entityIdInput.disabled = false;
            clearEntityForm();
            // é‡æ–°å¡«å……é»˜è®¤å€¼
            populateDefaultEntityValues();

            addEntityBtn.style.display = 'block';
            updateEntityBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
            
            // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„å®ä½“ï¼Œé‡æ–°æ˜¾ç¤ºå…¶è¯¦æƒ…ï¼ˆéç¼–è¾‘çŠ¶æ€ï¼‰
            if (selectedNode) {
                showEntityDetail(selectedNode);
            }
        }

        function clearEntityForm() {
            entityIdInput.value = '';
            entityNameInput.value = '';
            entityDescInput.value = '';
            entityDomainSelect.value = 'default';
            customDomainInput.value = '';
            customDomainInput.style.display = 'none';
        }

        // å±…ä¸­å±•ç¤ºå®ä½“
        function centerOnEntity(entityId) {
            const node = graphData.nodes.find(n => n.id === entityId);
            if (node && simulation) {
                // æ‰¾åˆ°å¯¹åº”çš„D3èŠ‚ç‚¹
                const d3Node = d3.selectAll('.node').filter(d => d.id === entityId);
                if (!d3Node.empty()) {
                    // è·å–èŠ‚ç‚¹ä½ç½®
                    const nodeData = d3Node.datum();
                    if (nodeData.x !== undefined && nodeData.y !== undefined) {
                        // å±…ä¸­åˆ°è¯¥èŠ‚ç‚¹
                        const container = document.getElementById('graph-container');
                        const width = container.clientWidth;
                        const height = container.clientHeight;
                        
                        // è®¡ç®—å±…ä¸­ä½ç½®
                        const centerX = width / 2 - nodeData.x;
                        const centerY = height / 2 - nodeData.y;
                        
                        // åº”ç”¨å˜æ¢
                        svg.select('g').transition()
                            .duration(1000)
                            .attr('transform', `translate(${centerX}, ${centerY})`);
                    }
                }
            }
        }

        // å±…ä¸­å±•ç¤ºå…³ç³»
        function centerOnRelation(sourceId, targetId, type) {
            const link = graphData.links.find(l => {
                const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                return lSourceId === sourceId && lTargetId === targetId && l.type === type;
            });
            
            if (link && simulation) {
                // æ‰¾åˆ°å¯¹åº”çš„D3å…³ç³»
                const d3Link = d3.selectAll('.link').filter(d => {
                    const dSourceId = typeof d.source === 'object' ? d.source.id : d.source;
                    const dTargetId = typeof d.target === 'object' ? d.target.id : d.target;
                    return dSourceId === sourceId && dTargetId === targetId && d.type === type;
                });
                
                if (!d3Link.empty()) {
                    const linkData = d3Link.datum();
                    const sourceNode = typeof linkData.source === 'object' ? linkData.source : graphData.nodes.find(n => n.id === linkData.source);
                    const targetNode = typeof linkData.target === 'object' ? linkData.target : graphData.nodes.find(n => n.id === linkData.target);
                    
                    if (sourceNode && targetNode) {
                        // è®¡ç®—å…³ç³»çš„ä¸­å¿ƒç‚¹
                        const centerX = (sourceNode.x + targetNode.x) / 2;
                        const centerY = (sourceNode.y + targetNode.y) / 2;
                        
                        // å±…ä¸­åˆ°å…³ç³»ä¸­å¿ƒ
                        const container = document.getElementById('graph-container');
                        const width = container.clientWidth;
                        const height = container.clientHeight;
                        
                        const centerOffsetX = width / 2 - centerX;
                        const centerOffsetY = height / 2 - centerY;
                        
                        svg.select('g').transition()
                            .duration(1000)
                            .attr('transform', `translate(${centerOffsetX}, ${centerOffsetY})`);
                    }
                }
            }
        }

        // å±…ä¸­å±•ç¤ºä½ç½®ï¼ˆç”¨äºåˆ é™¤æ“ä½œï¼‰
        function centerOnPosition(x, y) {
            if (simulation) {
                const container = document.getElementById('graph-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                const centerOffsetX = width / 2 - x;
                const centerOffsetY = height / 2 - y;
                
                svg.select('g').transition()
                    .duration(1000)
                    .attr('transform', `translate(${centerOffsetX}, ${centerOffsetY})`);
            }
        }

        // å±€éƒ¨æ›´æ–°å›¾è¡¨æ•°æ®è€Œä¸é‡æ–°åŠ è½½
        function updateGraphDataLocally() {
            // æ›´æ–°æ•°æ®å­˜å‚¨
            allGraphData = { ...graphData };
            filteredGraphData = { ...graphData };
            
            // æ›´æ–°ç•Œé¢å…ƒç´ 
            updateEntityDropdowns();
            renderEntityList();
            updateUsedRelationTypes();
            updateRelationTypeDropdown();
            updateDomainInfo();
            
            // æ¸…é™¤æœç´¢ç¼“å­˜ï¼Œç¡®ä¿æœç´¢åŠŸèƒ½ä¸æœ€æ–°æ•°æ®åŒæ­¥
            resetSearchState();
            updateDomainDropdown(null, '');
            
            // é‡æ–°æ¸²æŸ“å›¾è¡¨ï¼ˆä¿æŒå½“å‰è§†å›¾ï¼‰
            reloadGraph();
        }

        async function addEntity() {
            const id = entityIdInput.value.trim();
            const name = entityNameInput.value.trim();
            const description = entityDescInput.value.trim();
            
            // è·å–é¢†åŸŸä¿¡æ¯
            let domain = entityDomainSelect.value;
            if (domain === 'custom') {
                domain = customDomainInput.value.trim();
                if (!domain) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰é¢†åŸŸåç§°');
                    return;
                }
            }

            if (!id || !name) {
                alert('å®ä½“IDå’Œåç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            if (allGraphData.nodes.some(node => node.id === id)) {
                alert('å®ä½“IDå·²å­˜åœ¨');
                // è‡ªåŠ¨ç”Ÿæˆæ–°çš„ID
                entityIdInput.value = generateDefaultEntityId();
                return;
            }

            const newEntity = { id, name, domain };
            if (description) newEntity.description = description;

            // è°ƒç”¨åç«¯APIåˆ›å»ºå®ä½“
            const success = await createEntity(newEntity);
            if (success) {
                // å°†æ–°å®ä½“æ·»åŠ åˆ°æœ¬åœ°æ•°æ®ä¸­
                graphData.nodes.push(newEntity);
                
                // å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();
                
                // æ¸…ç©ºè¡¨å•å¹¶å¡«å……æ–°çš„é»˜è®¤å€¼
                clearEntityForm();
                populateDefaultEntityValues();
                
                // å»¶è¿Ÿä¸€ä¸‹ç­‰å¾…å›¾è¡¨é‡æ–°æ¸²æŸ“å®Œæˆåå±…ä¸­å±•ç¤ºæ–°å®ä½“
                setTimeout(() => {
                    centerOnEntity(newEntity.id);
                }, 100);
                
                alert('å®ä½“æ·»åŠ æˆåŠŸ');
                
                // å°†æ–°å¢çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = name;
                }
            } else {
                alert('å®ä½“æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        async function updateEntity() {
            if (!editingEntityId) return;

            const entity = graphData.nodes.find(n => n.id === editingEntityId);
            if (!entity) {
                alert('å®ä½“ä¸å­˜åœ¨');
                cancelEdit();
                return;
            }

            const name = entityNameInput.value.trim();
            const description = entityDescInput.value.trim();
            
            // è·å–é¢†åŸŸä¿¡æ¯
            let domain = entityDomainSelect.value;
            if (domain === 'custom') {
                domain = customDomainInput.value.trim();
                if (!domain) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰é¢†åŸŸåç§°');
                    return;
                }
            }

            if (!name) {
                alert('å®ä½“åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            const updateData = { name, domain };
            if (description) {
                updateData.description = description;
            }

            // è°ƒç”¨åç«¯APIæ›´æ–°å®ä½“
            const success = await updateEntityAPI(editingEntityId, updateData);
            if (success) {
                // æ›´æ–°æœ¬åœ°æ•°æ®
                Object.assign(entity, updateData);
                
                // å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();
                
                // å»¶è¿Ÿä¸€ä¸‹ç­‰å¾…å›¾è¡¨é‡æ–°æ¸²æŸ“å®Œæˆåå±…ä¸­å±•ç¤ºæ›´æ–°åçš„å®ä½“
                setTimeout(() => {
                    centerOnEntity(editingEntityId);
                }, 100);
                
                alert('å®ä½“æ›´æ–°æˆåŠŸ');

                if (selectedNode && selectedNode.id === editingEntityId) {
                    showEntityDetail(graphData.nodes.find(n => n.id === editingEntityId));
                }

                cancelEdit();
            } else {
                alert('å®ä½“æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å¤åˆ¶å®ä½“åŠŸèƒ½
        async function copyEntity(sourceId) {
            const sourceEntity = graphData.nodes.find(n => n.id === sourceId);
            if (!sourceEntity) return;

            // ç”Ÿæˆæ–°çš„å”¯ä¸€IDï¼ˆåŸºäºåŸIDè§„åˆ™ï¼Œç¡®ä¿ä¸é‡å¤ï¼‰
            const newId = generateUniqueEntityId(sourceEntity.id);
            // ç”Ÿæˆæ–°çš„å®ä½“åç§°ï¼ˆæ·»åŠ "å‰¯æœ¬"åç¼€ï¼‰
            const newName = `${sourceEntity.name}ï¼ˆå‰¯æœ¬ï¼‰`;

            // åˆ›å»ºå¤åˆ¶çš„å®ä½“å¯¹è±¡
            const copiedEntity = {
                id: newId,
                name: newName,
                domain: sourceEntity.domain || 'default',
                ...(sourceEntity.description ? { description: sourceEntity.description } : {})
            };

            // è°ƒç”¨åç«¯APIåˆ›å»ºå¤åˆ¶çš„å®ä½“
            const success = await createEntity(copiedEntity);
            if (success) {
                // å°†æ–°å®ä½“æ·»åŠ åˆ°æœ¬åœ°æ•°æ®ä¸­
                graphData.nodes.push(copiedEntity);
                
                // å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();

                // æ˜¾ç¤ºæ–°å¤åˆ¶å®ä½“çš„è¯¦æƒ…é¡µï¼ˆä¸è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼‰
                // ç¡®ä¿ä¸è®¾ç½®ç¼–è¾‘çŠ¶æ€
                editingEntityId = null;
                showEntityDetail(copiedEntity);

                // ç­‰å¾…D3.js simulationç¨³å®šåå±…ä¸­æ”¾å¤§å±•ç¤ºåŸå®ä½“ï¼ˆæºå®ä½“ï¼‰
                const waitForSimulation = () => {
                    if (simulation && simulation.alpha() > 0.01) {
                        // simulationè¿˜åœ¨è¿è¡Œï¼Œç»§ç»­ç­‰å¾…
                        setTimeout(waitForSimulation, 50);
                    } else {
                        // simulationå·²ç¨³å®šï¼Œæ‰§è¡Œå±…ä¸­æ”¾å¤§
                        setTimeout(() => {
                            // æ¸…é™¤æ‰€æœ‰é«˜äº®
                            clearAllHighlights();
                            
                            // é«˜äº®åŸå®ä½“
                            const sourceNodeGroup = d3.selectAll('.node').filter(d => d.id === sourceId);
                            if (!sourceNodeGroup.empty()) {
                                sourceNodeGroup.classed('highlighted', true);
                            }
                            
                            // å±…ä¸­æ”¾å¤§æ˜¾ç¤º
                            centerNodeInView(sourceId);
                        }, 100);
                    }
                };
                waitForSimulation();

                alert(`å®ä½“å¤åˆ¶æˆåŠŸï¼æ–°å®ä½“IDï¼š${newId}`);
                
                // å°†å¤åˆ¶çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = newName;
                }
            } else {
                alert('å®ä½“å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ç”Ÿæˆä¸é‡å¤çš„å®ä½“ID
        function generateUniqueEntityId(originalId) {
            // ç”Ÿæˆæ—¶é—´æˆ³ä½œä¸ºIDï¼Œç¡®ä¿å”¯ä¸€æ€§
            const timestamp = Date.now();
            let newId = `${timestamp}`;
            
            // å¦‚æœæ—¶é—´æˆ³å·²å­˜åœ¨ï¼Œæ·»åŠ éšæœºæ•°
            while (allGraphData.nodes.some(node => node.id === newId)) {
                newId = `${timestamp}_${Math.floor(Math.random() * 1000)}`;
            }
            return newId;
        }

        // å¤åˆ¶åè‡ªåŠ¨è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ä¸ºæ˜¾ç¤ºè¯¦æƒ…é¡µï¼‰
        function startEditCopiedEntity(entity) {
            // è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸å†ä½¿ç”¨ï¼Œæ”¹ä¸ºç›´æ¥æ˜¾ç¤ºè¯¦æƒ…é¡µ
            showEntityDetail(entity);
        }

        // å¤åˆ¶å®ä½“å¹¶å»ºç«‹å…³ç³»åŠŸèƒ½
        async function copyEntityWithRelation(sourceId) {
            const sourceEntity = graphData.nodes.find(n => n.id === sourceId);
            if (!sourceEntity) {
                alert('æºå®ä½“ä¸å­˜åœ¨');
                return;
            }

            // ç”Ÿæˆæ–°çš„å”¯ä¸€ID
            const newId = generateUniqueEntityId(sourceEntity.id);
            // ç”Ÿæˆæ–°çš„å®ä½“åç§°ï¼ˆæ·»åŠ "å‰¯æœ¬"åç¼€ï¼‰
            const newName = `${sourceEntity.name}ï¼ˆå‰¯æœ¬ï¼‰`;

            // åˆ›å»ºå¤åˆ¶çš„å®ä½“å¯¹è±¡
            const copiedEntity = {
                id: newId,
                name: newName,
                domain: sourceEntity.domain || 'default',
                ...(sourceEntity.description ? { description: sourceEntity.description } : {})
            };

            try {
                // 1. è°ƒç”¨åç«¯APIåˆ›å»ºå¤åˆ¶çš„å®ä½“
                const entitySuccess = await createEntity(copiedEntity);
                if (!entitySuccess) {
                    alert('å®ä½“å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    return;
                }

                // 2. åˆ›å»ºä»å¤åˆ¶å®ä½“æŒ‡å‘åŸå®ä½“çš„å…³ç³»
                const relationData = {
                    source: newId,
                    target: sourceId,
                    type: 'å¤åˆ¶è‡ª',
                    description: `ä»å®ä½“"${sourceEntity.name}"å¤åˆ¶è€Œæ¥`,
                    domain: sourceEntity.domain || 'default'
                };

                const relationResult = await createRelationship(relationData);
                if (!relationResult) {
                    alert('å®ä½“å¤åˆ¶æˆåŠŸï¼Œä½†å…³ç³»åˆ›å»ºå¤±è´¥');
                    // å³ä½¿å…³ç³»åˆ›å»ºå¤±è´¥ï¼Œå®ä½“å·²ç»åˆ›å»ºæˆåŠŸï¼Œæ‰€ä»¥ç»§ç»­
                }

                // 3. æ›´æ–°æœ¬åœ°æ•°æ®
                graphData.nodes.push(copiedEntity);
                
                if (relationResult && relationResult.data && relationResult.data.id) {
                    // æ·»åŠ å…³ç³»åˆ°æœ¬åœ°æ•°æ®ï¼ŒåŒ…å«ä»åç«¯è¿”å›çš„å…³ç³»ID
                    const newRelation = {
                        id: relationResult.data.id, // ä»åç«¯å“åº”çš„data.idä¸­è·å–å…³ç³»ID
                        source: newId,
                        target: sourceId,
                        type: 'å¤åˆ¶è‡ª',
                        description: relationData.description,
                        domain: relationData.domain
                    };
                    graphData.links.push(newRelation);
                }

                // 4. å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();

                // 5. æ˜¾ç¤ºæ–°å¤åˆ¶å®ä½“çš„è¯¦æƒ…é¡µï¼ˆä¸è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼‰
                // ç¡®ä¿ä¸è®¾ç½®ç¼–è¾‘çŠ¶æ€
                editingEntityId = null;
                showEntityDetail(copiedEntity);

                // 6. ç­‰å¾…D3.js simulationç¨³å®šåå±…ä¸­æ”¾å¤§å±•ç¤ºåŸå®ä½“ï¼ˆæºå®ä½“ï¼‰
                const waitForSimulation = () => {
                    if (simulation && simulation.alpha() > 0.01) {
                        // simulationè¿˜åœ¨è¿è¡Œï¼Œç»§ç»­ç­‰å¾…
                        setTimeout(waitForSimulation, 50);
                    } else {
                        // simulationå·²ç¨³å®šï¼Œæ‰§è¡Œå±…ä¸­æ”¾å¤§
                        setTimeout(() => {
                            // æ¸…é™¤æ‰€æœ‰é«˜äº®
                            clearAllHighlights();
                            
                            // é«˜äº®åŸå®ä½“
                            const sourceNodeGroup = d3.selectAll('.node').filter(d => d.id === sourceId);
                            if (!sourceNodeGroup.empty()) {
                                sourceNodeGroup.classed('highlighted', true);
                            }
                            
                            // å±…ä¸­æ”¾å¤§æ˜¾ç¤º
                            centerNodeInView(sourceId);
                        }, 100);
                    }
                };
                waitForSimulation();

                const successMsg = relationResult 
                    ? `å®ä½“å¤åˆ¶æˆåŠŸï¼æ–°å®ä½“IDï¼š${newId}ï¼Œå·²å»ºç«‹ä¸åŸå®ä½“çš„å…³ç³»`
                    : `å®ä½“å¤åˆ¶æˆåŠŸï¼æ–°å®ä½“IDï¼š${newId}`;
                alert(successMsg);
                
                // å°†å¤åˆ¶çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = newName;
                }

            } catch (error) {
                console.error('å¤åˆ¶å®ä½“æ—¶å‘ç”Ÿé”™è¯¯:', error);
                alert('å¤åˆ¶å®ä½“æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        async function deleteEntity(id) {
            // è·å–è¦åˆ é™¤çš„å®ä½“åŠå…¶å…³ç³»ä¿¡æ¯
            const entityToDelete = allGraphData.nodes.find(node => node.id === id);
            if (!entityToDelete) {
                alert('å®ä½“ä¸å­˜åœ¨');
                return;
            }
            
            // åœ¨åˆ é™¤å‰å°†å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = entityToDelete.name;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å®ä½“å—ï¼Ÿå…³è”çš„å…³ç³»ä¹Ÿå°†è¢«åˆ é™¤')) return;

            // æŸ¥æ‰¾ä¸è¢«åˆ é™¤å®ä½“ç›¸å…³çš„æ‰€æœ‰å…³ç³»
            const relatedLinks = allGraphData.links.filter(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                return sourceId === id || targetId === id;
            });

            // è·å–ä¸è¢«åˆ é™¤å®ä½“æœ‰å…³ç³»çš„å…¶ä»–å®ä½“ID
            const relatedEntityIds = new Set();
            relatedLinks.forEach(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                if (sourceId !== id) relatedEntityIds.add(sourceId);
                if (targetId !== id) relatedEntityIds.add(targetId);
            });

            const relatedEntities = Array.from(relatedEntityIds);

            // è°ƒç”¨åç«¯APIåˆ é™¤å®ä½“
            const success = await deleteEntityAPI(id);
            if (success) {
                // ä»å®Œæ•´æ•°æ®ä¸­åˆ é™¤å®ä½“
                allGraphData.nodes = allGraphData.nodes.filter(node => node.id !== id);
                allGraphData.links = allGraphData.links.filter(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    return sourceId !== id && targetId !== id;
                });
                
                // ä»å½“å‰è¿‡æ»¤æ•°æ®ä¸­åˆ é™¤å®ä½“
                graphData.nodes = graphData.nodes.filter(node => node.id !== id);
                graphData.links = graphData.links.filter(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    return sourceId !== id && targetId !== id;
                });
                
                // å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();

                // å¦‚æœåˆ é™¤çš„å®ä½“æ˜¯å½“å‰é€‰ä¸­çš„æºå®ä½“æˆ–ç›®æ ‡å®ä½“ï¼Œåˆ™æ¸…ç©º
                if (sourceEntityInput.value === id) {
                    sourceEntityInput.value = '';
                    sourceEntityDisplay.value = '';
                }
                if (targetEntityInput.value === id) {
                    targetEntityInput.value = '';
                    targetEntityDisplay.value = '';
                }

                if (selectedNode && selectedNode.id === id) {
                    selectedNode = null;
                    detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
                }

                // å°†åˆ é™¤çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = entityToDelete.name;
                }
                
                resetSearchState();

                // æ ¹æ®å…³ç³»æ•°é‡å†³å®šåˆ é™¤åçš„æ˜¾ç¤ºé€»è¾‘
                if (relatedEntities.length === 0) {
                    // æ— ä»»ä½•å…³ç³»ï¼šé€‚é…æ˜¾ç¤º
                    setTimeout(() => {
                        // é‡ç½®è§†å›¾åˆ°é»˜è®¤çŠ¶æ€
                        if (svg && zoom) {
                            const container = document.getElementById('graph-container');
                            const containerWidth = container.clientWidth;
                            const containerHeight = container.clientHeight;
                            
                            svg.transition()
                                .duration(800)
                                .ease(d3.easeCubic)
                                .call(zoom.transform,
                                    d3.zoomIdentity
                                        .translate(containerWidth / 2, containerHeight / 2)
                                        .scale(1.0)
                                );
                        }
                    }, 300);
                } else if (relatedEntities.length === 1) {
                    // åªä¸ä¸€ä¸ªå®ä½“æœ‰å…³ç³»ï¼šå±…ä¸­æ˜¾ç¤ºè¯¥å®ä½“
                    const relatedEntityId = relatedEntities[0];
                    setTimeout(() => {
                        // æ¸…é™¤æ‰€æœ‰é«˜äº®
                        clearAllHighlights();
                        
                        // é«˜äº®ç›¸å…³å®ä½“
                        const relatedNodeGroup = d3.selectAll('.node').filter(d => d.id === relatedEntityId);
                        if (!relatedNodeGroup.empty()) {
                            relatedNodeGroup.classed('highlighted', true);
                        }
                        
                        // å±…ä¸­æ”¾å¤§æ˜¾ç¤ºç›¸å…³å®ä½“
                        centerNodeInView(relatedEntityId);
                    }, 300);
                } else {
                    // ä¸å¤šä¸ªå®ä½“æœ‰å…³ç³»ï¼šå±…ä¸­æ˜¾ç¤ºä»»æ„å…¶ä¸­ä¸€ä¸ªå®ä½“
                    const randomRelatedEntityId = relatedEntities[Math.floor(Math.random() * relatedEntities.length)];
                    setTimeout(() => {
                        // æ¸…é™¤æ‰€æœ‰é«˜äº®
                        clearAllHighlights();
                        
                        // é«˜äº®é€‰ä¸­çš„ç›¸å…³å®ä½“
                        const relatedNodeGroup = d3.selectAll('.node').filter(d => d.id === randomRelatedEntityId);
                        if (!relatedNodeGroup.empty()) {
                            relatedNodeGroup.classed('highlighted', true);
                        }
                        
                        // å±…ä¸­æ”¾å¤§æ˜¾ç¤ºé€‰ä¸­çš„ç›¸å…³å®ä½“
                        centerNodeInView(randomRelatedEntityId);
                    }, 300);
                }

                alert('å®ä½“åˆ é™¤æˆåŠŸ');
            } else {
                alert('å®ä½“åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ------------------------------
        // å…³ç³»ç®¡ç†ï¼ˆæ·»åŠ /ä¿®æ”¹/åˆ é™¤ï¼‰
        // ------------------------------
        async function addRelation() {
            const sourceId = sourceEntityInput.value;
            const targetId = targetEntityInput.value;
            const type = relationTypeInput.value.trim();
            const edgeType = document.getElementById('edge-type').value;

            if (!sourceId || !targetId || !type) {
                alert('è¯·å®Œå–„å…³ç³»ä¿¡æ¯');
                return;
            }

            if (sourceId === targetId) {
                alert('æºå®ä½“å’Œç›®æ ‡å®ä½“ä¸èƒ½ç›¸åŒ');
                return;
            }

            const relationExists = graphData.links.some(link => {
                const linkSourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const linkTargetId = typeof link.target === 'object' ? link.target.id : link.target;
                return linkSourceId === sourceId && linkTargetId === targetId && link.type === type;
            });

            if (relationExists) {
                alert('æ­¤å…³ç³»å·²å­˜åœ¨');
                return;
            }

            // è·å–æºå®ä½“çš„é¢†åŸŸä¿¡æ¯
            const sourceEntity = graphData.nodes.find(n => n.id === sourceId);
            const targetEntity = graphData.nodes.find(n => n.id === targetId);
            const domain = sourceEntity?.domain || targetEntity?.domain || 'default';

            // è°ƒç”¨åç«¯APIåˆ›å»ºå…³ç³»
            const result = await createRelationship({
                source: sourceId,
                target: targetId,
                type: type,
                edgeType: edgeType,
                domain: domain
            });

            if (result && result.data && result.data.id) {
                // å°†æ–°å…³ç³»æ·»åŠ åˆ°æœ¬åœ°æ•°æ®ä¸­ï¼ŒåŒ…å«å…³ç³»ID
                const newLink = {
                    id: result.data.id, // ä»åç«¯å“åº”çš„data.idä¸­è·å–å…³ç³»ID
                    source: sourceId,
                    target: targetId,
                    type: type,
                    edgeType: edgeType,
                    domain: domain
                };
                graphData.links.push(newLink);
                
                // å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();
                
                clearRelationForm();

                if (selectedNode && (selectedNode.id === sourceId || selectedNode.id === targetId)) {
                    showEntityDetail(selectedNode);
                }

                resetSearchState();

                // å»¶è¿Ÿä¸€ä¸‹ç­‰å¾…å›¾è¡¨é‡æ–°æ¸²æŸ“å®Œæˆåå±…ä¸­å±•ç¤ºæ–°å…³ç³»
                setTimeout(() => {
                    centerOnRelation(sourceId, targetId, type);
                }, 100);

                alert('å…³ç³»æ·»åŠ æˆåŠŸ');
            } else {
                alert('å…³ç³»æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å¼€å§‹ç¼–è¾‘å…³ç³»
        function startEditRelation(linkIndex) {
            if (linkIndex < 0 || linkIndex >= graphData.links.length) return;

            const link = graphData.links[linkIndex];
            editingLinkIndex = linkIndex;

            // è·å–æºå®ä½“å’Œç›®æ ‡å®ä½“çš„IDï¼ˆå¤„ç†å¯¹è±¡å¼•ç”¨çš„æƒ…å†µï¼‰
            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;

            // å¡«å……è¡¨å•
            sourceEntityInput.value = sourceId;
            const sourceEntity = graphData.nodes.find(n => n.id === sourceId);
            sourceEntityDisplay.value = sourceEntity ? sourceEntity.name : '';

            targetEntityInput.value = targetId;
            const targetEntity = graphData.nodes.find(n => n.id === targetId);
            targetEntityDisplay.value = targetEntity ? targetEntity.name : '';

            relationTypeInput.value = link.type;
            relationTypeDisplay.value = link.type;

            // æ˜¾ç¤ºå…³ç³»è¯¦æƒ…è§†å›¾
            showRelationDetail(link);
        }

        // æ›´æ–°å…³ç³»
        function updateRelation() {
            if (editingLinkIndex < 0 || editingLinkIndex >= graphData.links.length) return;

            const originalLink = graphData.links[editingLinkIndex];
            const originalSourceId = typeof originalLink.source === 'object' ? originalLink.source.id : originalLink.source;
            const originalTargetId = typeof originalLink.target === 'object' ? originalLink.target.id : originalLink.target;

            const newSourceId = sourceEntityInput.value;
            const newTargetId = targetEntityInput.value;
            const newType = relationTypeInput.value.trim();

            if (!newSourceId || !newTargetId || !newType) {
                alert('è¯·å®Œå–„å…³ç³»ä¿¡æ¯');
                return;
            }

            if (newSourceId === newTargetId) {
                alert('æºå®ä½“å’Œç›®æ ‡å®ä½“ä¸èƒ½ç›¸åŒ');
                return;
            }

            // æ£€æŸ¥æ›´æ–°åçš„å…³ç³»æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ’é™¤è‡ªèº«ï¼‰
            const relationExists = graphData.links.some((link, index) => {
                if (index === editingLinkIndex) return false; // è·³è¿‡è‡ªèº«

                const linkSourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const linkTargetId = typeof link.target === 'object' ? link.target.id : link.target;
                return linkSourceId === newSourceId && linkTargetId === newTargetId && link.type === newType;
            });

            if (relationExists) {
                alert('æ­¤å…³ç³»å·²å­˜åœ¨');
                return;
            }

            // è®°å½•æ—§çš„å…³ç³»ç±»å‹ï¼Œç”¨äºæ›´æ–°å…³ç³»ç±»å‹é›†åˆ
            const oldType = originalLink.type;

            // æ›´æ–°å…³ç³»æ•°æ®
            graphData.links[editingLinkIndex] = {
                source: newSourceId,
                target: newTargetId,
                type: newType
            };

            // æ›´æ–°å·²ä½¿ç”¨çš„å…³ç³»ç±»å‹
            updateUsedRelationTypes();
            updateRelationTypeDropdown();

            // åˆ·æ–°ç•Œé¢
            reloadGraph();
            clearRelationForm();
            editingLinkIndex = -1;

            // æ›´æ–°è¯¦æƒ…è§†å›¾
            showRelationDetail(graphData.links[editingLinkIndex]);

            alert('å…³ç³»æ›´æ–°æˆåŠŸ');
        }

        function clearRelationForm() {
            sourceEntityInput.value = '';
            sourceEntityDisplay.value = '';
            targetEntityInput.value = '';
            targetEntityDisplay.value = '';
            relationTypeInput.value = '';
            relationTypeDisplay.value = '';
        }

        async function deleteRelation(sourceId, targetId, type) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å…³ç³»ã€Œ${type}ã€å—ï¼Ÿ`)) return;

            const source = typeof sourceId === 'object' ? sourceId.id : sourceId;
            const target = typeof targetId === 'object' ? targetId.id : targetId;

            // æ‰¾åˆ°è¦åˆ é™¤çš„å…³ç³»
            const linkToDelete = graphData.links.find(link => {
                const linkSource = typeof link.source === 'object' ? link.source.id : link.source;
                const linkTarget = typeof link.target === 'object' ? link.target.id : link.target;
                return linkSource === source && linkTarget === target && link.type === type;
            });

            if (!linkToDelete) {
                alert('æœªæ‰¾åˆ°è¯¥å…³ç³»');
                return;
            }

            // è®°å½•è¦åˆ é™¤çš„å…³ç³»çš„ä½ç½®
            let deletePosition = null;
            if (simulation) {
                const sourceNode = graphData.nodes.find(n => n.id === source);
                const targetNode = graphData.nodes.find(n => n.id === target);
                if (sourceNode && targetNode) {
                    // è®¡ç®—å…³ç³»çš„ä¸­å¿ƒç‚¹
                    deletePosition = {
                        x: (sourceNode.x + targetNode.x) / 2,
                        y: (sourceNode.y + targetNode.y) / 2
                    };
                }
            }

            // è·å–å…³ç³»ID
            const relationshipId = linkToDelete.id;
            
            console.log('è¦åˆ é™¤çš„å…³ç³»:', linkToDelete);
            console.log('å…³ç³»ID:', relationshipId);
            
            if (!relationshipId) {
                // å¦‚æœå…³ç³»IDä¸å­˜åœ¨ï¼Œå°è¯•é€šè¿‡APIè·å–å…³ç³»åˆ—è¡¨æ¥æ‰¾åˆ°ID
                console.log('å…³ç³»IDä¸å­˜åœ¨ï¼Œå°è¯•é€šè¿‡APIè·å–å…³ç³»ID...');
                try {
                    const response = await fetch('/api/kg/relationships');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.ret === 0 && result.data) {
                            const relationship = result.data.find(rel => 
                                rel.source === source && rel.target === target && rel.type === type
                            );
                            if (relationship) {
                                relationshipId = relationship.id;
                                console.log('é€šè¿‡APIæ‰¾åˆ°å…³ç³»ID:', relationshipId);
                            } else {
                                alert('æ— æ³•æ‰¾åˆ°å…³ç³»IDï¼Œåˆ é™¤å¤±è´¥');
                                return;
                            }
                        } else {
                            alert('è·å–å…³ç³»åˆ—è¡¨å¤±è´¥');
                            return;
                        }
                    } else {
                        alert('è·å–å…³ç³»åˆ—è¡¨å¤±è´¥');
                        return;
                    }
                } catch (error) {
                    console.error('è·å–å…³ç³»åˆ—è¡¨å¤±è´¥:', error);
                    alert('è·å–å…³ç³»åˆ—è¡¨å¤±è´¥');
                    return;
                }
            }

            // è°ƒç”¨åç«¯APIåˆ é™¤å…³ç³»
            const success = await deleteRelationshipAPI(relationshipId);
            if (success) {
                // ä»æœ¬åœ°æ•°æ®ä¸­åˆ é™¤å…³ç³»
            graphData.links = graphData.links.filter(link => {
                const linkSource = typeof link.source === 'object' ? link.source.id : link.source;
                const linkTarget = typeof link.target === 'object' ? link.target.id : link.target;
                return !(linkSource === source && linkTarget === target && link.type === type);
            });

                // å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();

                if (selectedNode && (selectedNode.id === source || selectedNode.id === target)) {
                    showEntityDetail(selectedNode);
                }

                if (selectedLink &&
                    (typeof selectedLink.source === 'object' ? selectedLink.source.id : selectedLink.source) === source &&
                    (typeof selectedLink.target === 'object' ? selectedLink.target.id : selectedLink.target) === target &&
                    selectedLink.type === type) {
                selectedLink = null;
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
            }

                resetSearchState();

                // å»¶è¿Ÿä¸€ä¸‹ç­‰å¾…å›¾è¡¨é‡æ–°æ¸²æŸ“å®Œæˆåå±…ä¸­åˆ°åˆ é™¤ä½ç½®
                if (deletePosition) {
                    setTimeout(() => {
                        centerOnPosition(deletePosition.x, deletePosition.y);
                    }, 100);
                }

                alert('å…³ç³»åˆ é™¤æˆåŠŸ');
            } else {
                alert('å…³ç³»åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ------------------------------
        // å›¾è°±å¯è§†åŒ–ä¸äº¤äº’
        // ------------------------------
        function initializeGraph() {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            d3.select('#graph-container').select('svg').remove();

            svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', [0, 0, width, height])
                .on('click', handleSvgClick); // æ·»åŠ ç©ºç™½å¤„ç‚¹å‡»äº‹ä»¶

            // å®šä¹‰ç®­å¤´æ ‡è®°ï¼Œä¸ºæ¯ä¸ªç®­å¤´æ·»åŠ å”¯ä¸€ID
            const defs = svg.append('defs');
            graphData.links.forEach((link, index) => {
                const edgeType = link.edgeType || 'solid-arrow';
                const marker = defs.append('marker')
                    .attr('id', `arrow-${index}`)
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 45) // ç®­å¤´ä½ç½®è°ƒæ•´ï¼Œé€‚åº”å¤§èŠ‚ç‚¹
                    .attr('refY', 0)
                    .attr('markerWidth', 6)
                    .attr('markerHeight', 6)
                    .attr('orient', 'auto')
                    .attr('data-link-index', index);

                // æ ¹æ®è¾¹ç±»å‹åˆ›å»ºä¸åŒçš„æ ‡è®°
                switch (edgeType) {
                    case 'solid-arrow':
                        marker.append('path')
                            .attr('d', 'M0,-5L10,0L0,5Z')
                            .attr('class', 'arrowhead')
                            .attr('fill', '#000000')
                            .attr('stroke', '#000000')
                            .attr('stroke-width', 1);
                        break;
                    case 'solid-triangle':
                        marker.append('path')
                            .attr('d', 'M0,-5L10,0L0,5Z')
                            .attr('class', 'arrowhead')
                            .attr('fill', 'none')
                            .attr('stroke', '#666')
                            .attr('stroke-width', 1.5);
                        break;
                    case 'dashed-triangle':
                        marker.append('path')
                            .attr('d', 'M0,-5L10,0L0,5Z')
                            .attr('class', 'arrowhead')
                            .attr('fill', 'none')
                            .attr('stroke', '#666')
                            .attr('stroke-width', 1.5);
                        break;
                    case 'hollow-diamond':
                        marker.append('path')
                            .attr('d', 'M0,0L5,-5L10,0L5,5Z')
                            .attr('class', 'arrowhead')
                            .attr('fill', 'none')
                            .attr('stroke', '#666')
                            .attr('stroke-width', 1.5);
                        break;
                    case 'solid-diamond':
                        marker.append('path')
                            .attr('d', 'M0,0L5,-5L10,0L5,5Z')
                            .attr('class', 'arrowhead')
                            .attr('fill', '#000000')
                            .attr('stroke', '#000000')
                            .attr('stroke-width', 1);
                        break;
                    case 'dashed-arrow':
                        marker.append('path')
                            .attr('d', 'M0,-5L10,0L0,5Z')
                            .attr('class', 'arrowhead')
                            .attr('fill', '#000000')
                            .attr('stroke', '#000000')
                            .attr('stroke-width', 1);
                        break;
                    default:
                        marker.append('path')
                            .attr('d', 'M0,-5L10,0L0,5Z')
                            .attr('class', 'arrowhead')
                            .attr('fill', '#666')
                            .attr('stroke', 'none');
                }

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.on('click', function(event) {
                    event.stopPropagation();
                    const linkIndex = parseInt(d3.select(this).attr('data-link-index'));
                    const link = graphData.links[linkIndex];
                    if (link) {
                        selectedLink = link;
                        clearAllHighlights();
                        highlightRelationAndEntities(link);
                        showRelationDetail(link);
                        centerRelationInView(link);
                        resetSearchState();
                    }
                });
            });

            zoom = d3.zoom()
                .scaleExtent([0.1, 5])
                .on('zoom', (event) => {
                    transform = event.transform;
                    g.attr('transform', transform);
                });

            svg.call(zoom);

            const g = svg.append('g');

            // è°ƒæ•´åŠ›å¯¼å‘å‚æ•°ï¼Œé€‚åº”å¤§èŠ‚ç‚¹
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(200)) // å¢åŠ èŠ‚ç‚¹é—´è·
                .force('charge', d3.forceManyBody().strength(-600)) // å¢åŠ æ’æ–¥åŠ›
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(70)); // å¢åŠ ç¢°æ’æ£€æµ‹åŠå¾„

            // ç»˜åˆ¶è¿çº¿å¹¶æ·»åŠ ç®­å¤´ï¼Œä¸ºæ¯æ¡çº¿åˆ†é…å¯¹åº”çš„ç®­å¤´ID
            linkElements = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(graphData.links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke-width', 2)
                .attr('data-link-index', (d, i) => i)
                .attr('marker-end', (d, i) => `url(#arrow-${i})`) // ä¸ºæ¯æ¡çº¿åˆ†é…å¯¹åº”çš„ç®­å¤´
                .attr('stroke-dasharray', function(d) {
                    const edgeType = d.edgeType || 'solid-arrow';
                    return (edgeType === 'dashed-triangle' || edgeType === 'dashed-arrow') ? '5,5' : null;
                })
                .on('click', (event, d) => {
                    // ç‚¹å‡»å…³ç³»è¾¹æ˜¾ç¤ºè¯¦æƒ…
                    event.stopPropagation();
                    selectedLink = d;
                    clearAllHighlights();

                    // é«˜äº®å½“å‰å…³ç³»åŠç›¸å…³å®ä½“å’Œç®­å¤´
                    highlightRelationAndEntities(d);

                    showRelationDetail(d);
                    centerRelationInView(d);
                    resetSearchState();
                })
                .on('contextmenu', function(event, d) {
                    event.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
                    
                    // ç¡®ä¿å…³ç³»è¢«é€‰ä¸­
                    selectedLink = d;
                    clearAllHighlights();
                    
                    // é«˜äº®å½“å‰å…³ç³»åŠç›¸å…³å®ä½“å’Œç®­å¤´
                    highlightRelationAndEntities(d);
                    
                    // æ˜¾ç¤ºå…³ç³»å³é”®èœå•
                    showRelationContextMenu(event, d);
                });

            // ç»˜åˆ¶è¿çº¿æ ‡ç­¾
            linkLabelElements = g.append('g')
                .attr('class', 'link-labels')
                .selectAll('text')
                .data(graphData.links)
                .enter()
                .append('text')
                .attr('class', 'link-label')
                .attr('data-link-index', (d, i) => i)
                .text(d => d.type)
                .on('click', (event, d) => {
                    // ç‚¹å‡»å…³ç³»æ ‡ç­¾æ˜¾ç¤ºè¯¦æƒ…
                    event.stopPropagation();
                    selectedLink = d;
                    clearAllHighlights();

                    // é«˜äº®å½“å‰å…³ç³»åŠç›¸å…³å®ä½“å’Œç®­å¤´
                    highlightRelationAndEntities(d);

                    showRelationDetail(d);
                    centerRelationInView(d);
                    resetSearchState();
                });

            // ç»˜åˆ¶èŠ‚ç‚¹
            nodeGroups = g.append('g')
                .attr('class', 'nodes')
                .selectAll('g')
                .data(graphData.nodes)
                .enter()
                .append('g')
                .attr('data-id', d => d.id)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // å¤§å®å¿ƒåœ†èŠ‚ç‚¹
            nodeGroups.append('circle')
                .attr('r', 25) // å¤§èŠ‚ç‚¹åŠå¾„
                .attr('fill', '#66bb6a');

            // èŠ‚ç‚¹å†…éƒ¨æ–‡å­—ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
            nodeGroups.append('text')
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .text(d => {
                    // é•¿åç§°è‡ªåŠ¨æˆªæ–­æ˜¾ç¤º
                    if (d.name.length > 5) {
                        return d.name.substring(0, 5) + '...';
                    }
                    return d.name;
                })
                .attr('fill', '#ffffff'); // ç™½è‰²æ–‡å­—ï¼Œä¸èŠ‚ç‚¹å½¢æˆå¯¹æ¯”

            nodeGroups.on('click', (event, d) => {
                event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°SVG
                selectedNode = d;
                selectedLink = null;
                clearAllHighlights();
                
                // æ¸…é™¤æ‰€æœ‰èŠ‚ç‚¹çš„é€‰ä¸­çŠ¶æ€
                nodeGroups.classed('selected', false);
                // è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºé€‰ä¸­çŠ¶æ€
                d3.select(event.currentTarget).classed('selected', true);
                
                d3.select(event.currentTarget).classed('highlighted', true);
                showEntityDetail(d);
                centerNodeInView(d.id);
                resetSearchState();
            });

            // æ–°å¢ï¼šé¼ æ ‡äº‹ä»¶ç»‘å®šï¼ˆæ‚¬æµ®æ˜¾ç¤º/éšè—ä¿¡æ¯ï¼‰
            // èŠ‚ç‚¹ç»„çš„é¼ æ ‡äº‹ä»¶ç»‘å®šï¼ˆæ›¿æ¢åŸæœ‰ä»£ç ï¼‰
            nodeGroups
                .on('mouseover', function(event, d) {
                    // è®¾ç½®æ‚¬æµ®çª—å£åº”è¯¥æ˜¾ç¤º
                    tooltipShouldShow = true;
                    
                    const tooltip = document.getElementById('entity-tooltip');
                    const titleEl = document.getElementById('tooltip-title');
                    const idEl = document.getElementById('tooltip-id');
                    const domainEl = document.getElementById('tooltip-domain');
                    const descEl = document.getElementById('tooltip-desc');

                    // 1. å¡«å……å®ä½“ä¿¡æ¯
                    titleEl.textContent = d.name;
                    idEl.textContent = d.id;
                    domainEl.textContent = d.domain || 'default';
                    // å¤„ç†æè¿°ä¸­çš„æ¢è¡Œç¬¦
                    const description = d.description || 'æ— ';
                    descEl.textContent = description;

                    // 2. è·å–èŠ‚ç‚¹åœ¨SVGä¸­çš„å®é™…ä½ç½®
                    const nodeElement = d3.select(this);
                    const nodeRect = nodeElement.node().getBoundingClientRect();
                    
                    // 3. è®¡ç®—èŠ‚ç‚¹ä¸­å¿ƒä½ç½®ï¼ˆæ›´ç²¾ç¡®çš„è®¡ç®—ï¼‰
                    const nodeCenterX = nodeRect.left + nodeRect.width / 2;
                    const nodeCenterY = nodeRect.top + nodeRect.height / 2;
                    
                    // 4. è·å–å¯è§†åŒ–é¢æ¿çš„æ»šåŠ¨åç§»
                    const visualizationPanel = document.querySelector('.visualization-panel');
                    const panelRect = visualizationPanel.getBoundingClientRect();
                    
                    // 5. è®¾ç½®tooltipä½ç½®ï¼ˆåŸºäºèŠ‚ç‚¹ä½ç½®ï¼Œé¿å…è¶…å‡ºå±å¹•ï¼‰
                    let tooltipX = nodeCenterX + 15; // èŠ‚ç‚¹å³ä¾§15px
                    let tooltipY = nodeCenterY - 200; // èŠ‚ç‚¹ä¸­å¿ƒä¸Šæ–¹200pxï¼ˆtooltipé«˜åº¦çš„ä¸€åŠï¼‰
                    
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå³è¾¹ç•Œ
                    if (tooltipX + 280 > window.innerWidth) {
                        tooltipX = nodeCenterX - 295; // èŠ‚ç‚¹å·¦ä¾§
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºä¸Šè¾¹ç•Œ
                    if (tooltipY < 0) {
                        tooltipY = nodeCenterY + 15; // èŠ‚ç‚¹ä¸‹æ–¹
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºä¸‹è¾¹ç•Œ
                    if (tooltipY + 400 > window.innerHeight) {
                        tooltipY = nodeCenterY - 400; // èŠ‚ç‚¹ä¸Šæ–¹
                    }
                    
                    tooltip.style.left = `${tooltipX}px`;
                    tooltip.style.top = `${tooltipY}px`;
                    tooltip.style.display = 'block';
                    tooltip.classList.add('visible');
                    
                    // æ‚¬æµ®çª—å£çš„é¼ æ ‡äº‹ä»¶å¤„ç†ï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
                    if (!tooltip.hasAttribute('data-events-added')) {
                        tooltip.addEventListener('mouseenter', function() {
                            tooltipShouldShow = true;
                        });
                        
                        tooltip.addEventListener('mouseleave', function() {
                            tooltipShouldShow = false;
                            hideTooltip();
                        });
                        
                        tooltip.setAttribute('data-events-added', 'true');
                    }
                    
                    // ä¸æ˜¾ç¤ºèƒŒæ™¯é®ç½©ï¼Œåªåœ¨èŠ‚ç‚¹ä¸Šæ˜¾ç¤ºæ‚¬æµ®çª—å£
                })
                .on('mousemove', function(event, d) {
                    // é¼ æ ‡ç§»åŠ¨æ—¶ä¿æŒtooltipä½ç½®ï¼ˆåŸºäºèŠ‚ç‚¹ä½ç½®ï¼‰
                    const tooltip = document.getElementById('entity-tooltip');
                    
                    // è·å–èŠ‚ç‚¹åœ¨SVGä¸­çš„ä½ç½®
                    const nodeElement = d3.select(this);
                    const nodeRect = nodeElement.node().getBoundingClientRect();
                    
                    // è®¡ç®—èŠ‚ç‚¹ä¸­å¿ƒä½ç½®
                    const nodeCenterX = nodeRect.left + nodeRect.width / 2;
                    const nodeCenterY = nodeRect.top + nodeRect.height / 2;
                    
                    // è®¾ç½®tooltipä½ç½®ï¼ˆåŸºäºèŠ‚ç‚¹ä½ç½®ï¼Œé¿å…è¶…å‡ºå±å¹•ï¼‰
                    let tooltipX = nodeCenterX + 15; // èŠ‚ç‚¹å³ä¾§15px
                    let tooltipY = nodeCenterY - 200; // èŠ‚ç‚¹ä¸­å¿ƒä¸Šæ–¹200px
                    
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå³è¾¹ç•Œ
                    if (tooltipX + 280 > window.innerWidth) {
                        tooltipX = nodeCenterX - 295; // èŠ‚ç‚¹å·¦ä¾§
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºä¸Šè¾¹ç•Œ
                    if (tooltipY < 0) {
                        tooltipY = nodeCenterY + 15; // èŠ‚ç‚¹ä¸‹æ–¹
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºä¸‹è¾¹ç•Œ
                    if (tooltipY + 400 > window.innerHeight) {
                        tooltipY = nodeCenterY - 400; // èŠ‚ç‚¹ä¸Šæ–¹
                    }
                    
                    tooltip.style.left = `${tooltipX}px`;
                    tooltip.style.top = `${tooltipY}px`;
                })
                .on('mouseout', function() {
                    // è®¾ç½®æ‚¬æµ®çª—å£ä¸åº”è¯¥æ˜¾ç¤º
                    tooltipShouldShow = false;
                    
                    // ç«‹å³éšè—tooltip
                    const tooltip = document.getElementById('entity-tooltip');
                    if (tooltip) {
                        tooltip.classList.remove('visible');
                    }
                })
                .on('contextmenu', function(event, d) {
                    event.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
                    
                    // ç¡®ä¿èŠ‚ç‚¹è¢«é€‰ä¸­
                    selectedNode = d;
                    clearAllHighlights();
                    nodeGroups.classed('selected', false);
                    d3.select(event.currentTarget).classed('selected', true);
                    
                    // æ˜¾ç¤ºå³é”®èœå•
                    showContextMenu(event, d);
                });

            // å­˜å‚¨ç®­å¤´å…ƒç´ å¼•ç”¨ï¼Œæ·»åŠ æ•°æ®å±æ€§æ ‡è¯†å¯¹åº”çš„å…³ç³»ç´¢å¼•
            arrowElements = svg.selectAll('.arrowhead');

            simulation.on('tick', () => {
                // è®¡ç®—åŒå‘è¾¹çš„åç§»
                const linkOffsets = calculateLinkOffsets();
                
                linkElements
                    .attr('x1', (d, i) => d.source.x + (linkOffsets[i] ? linkOffsets[i].x1 : 0))
                    .attr('y1', (d, i) => d.source.y + (linkOffsets[i] ? linkOffsets[i].y1 : 0))
                    .attr('x2', (d, i) => d.target.x + (linkOffsets[i] ? linkOffsets[i].x2 : 0))
                    .attr('y2', (d, i) => d.target.y + (linkOffsets[i] ? linkOffsets[i].y2 : 0));

                linkLabelElements
                    .attr('x', (d, i) => {
                        const offset = linkOffsets[i];
                        if (offset) {
                            return (d.source.x + d.target.x) / 2 + offset.labelX;
                        }
                        return (d.source.x + d.target.x) / 2;
                    })
                    .attr('y', (d, i) => {
                        const offset = linkOffsets[i];
                        if (offset) {
                            return (d.source.y + d.target.y) / 2 + offset.labelY;
                        }
                        return (d.source.y + d.target.y) / 2;
                    });

                nodeGroups.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            console.log('å›¾è°±åˆå§‹åŒ–å®Œæˆï¼ŒèŠ‚ç‚¹æ•°ï¼š', graphData.nodes.length);
        }

        // è®¡ç®—åŒå‘è¾¹çš„åç§»é‡
        function calculateLinkOffsets() {
            const offsets = new Array(graphData.links.length).fill(null);
            const offsetDistance = 8; // å¹³è¡Œè¾¹çš„é—´è·
            
            // éå†æ‰€æœ‰è¿çº¿ï¼Œæ‰¾å‡ºåŒå‘è¾¹
            for (let i = 0; i < graphData.links.length; i++) {
                const link1 = graphData.links[i];
                const source1 = typeof link1.source === 'object' ? link1.source.id : link1.source;
                const target1 = typeof link1.target === 'object' ? link1.target.id : link1.target;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åå‘çš„è¾¹
                for (let j = i + 1; j < graphData.links.length; j++) {
                    const link2 = graphData.links[j];
                    const source2 = typeof link2.source === 'object' ? link2.source.id : link2.source;
                    const target2 = typeof link2.target === 'object' ? link2.target.id : link2.target;
                    
                    // å¦‚æœæ‰¾åˆ°åŒå‘è¾¹
                    if (source1 === target2 && target1 === source2) {
                        // è®¡ç®—è¾¹çš„æ–¹å‘å‘é‡
                        const node1 = graphData.nodes.find(n => n.id === source1);
                        const node2 = graphData.nodes.find(n => n.id === target1);
                        
                        if (node1 && node2) {
                            const dx = node2.x - node1.x;
                            const dy = node2.y - node1.y;
                            const length = Math.sqrt(dx * dx + dy * dy);
                            
                            if (length > 0) {
                                // è®¡ç®—å‚ç›´åç§»å‘é‡
                                const perpX = -dy / length * offsetDistance;
                                const perpY = dx / length * offsetDistance;
                                
                                // ä¸ºç¬¬ä¸€æ¡è¾¹è®¾ç½®åç§»
                                offsets[i] = {
                                    x1: perpX,
                                    y1: perpY,
                                    x2: perpX,
                                    y2: perpY,
                                    labelX: perpX,
                                    labelY: perpY
                                };
                                
                                // ä¸ºç¬¬äºŒæ¡è¾¹è®¾ç½®åå‘åç§»
                                offsets[j] = {
                                    x1: -perpX,
                                    y1: -perpY,
                                    x2: -perpX,
                                    y2: -perpY,
                                    labelX: -perpX,
                                    labelY: -perpY
                                };
                            }
                        }
                        break;
                    }
                }
            }
            
            return offsets;
        }

        // é«˜äº®å…³ç³»åŠç›¸å…³å®ä½“å’Œç®­å¤´
        function highlightRelationAndEntities(link) {
            // æ‰¾åˆ°å½“å‰å…³ç³»åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
            const linkIndex = graphData.links.indexOf(link);
            if (linkIndex === -1) return;

            // è·å–æºå®ä½“å’Œç›®æ ‡å®ä½“çš„ID
            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;

            // é«˜äº®å…³ç³»çº¿
            linkElements.filter((l, i) => i === linkIndex).classed('link-highlighted', true);

            // é«˜äº®ç®­å¤´ - ä¿®å¤çš„å…³é”®éƒ¨åˆ†
            d3.select(`#arrow-${linkIndex}`).select('path').classed('arrow-highlighted', true);

            // é«˜äº®å…³ç³»æ ‡ç­¾
            linkLabelElements.filter((l, i) => i === linkIndex).classed('link-label-highlighted', true);

            // é«˜äº®æºå®ä½“å’Œç›®æ ‡å®ä½“
            nodeGroups.filter(d => d.id === sourceId || d.id === targetId)
                .classed('relation-entity-highlighted', true);
        }

        // å¤„ç†SVGç©ºç™½å¤„ç‚¹å‡»äº‹ä»¶
        function handleSvgClick(event) {
            // åªæœ‰ç‚¹å‡»ç©ºç™½å¤„æ‰è§¦å‘
            if (event.target === svg.node()) {
                clearAllHighlights();
                selectedNode = null;
                selectedLink = null;
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
                resetSearchState();
                
                // ç‚¹å‡»ç©ºç™½å¤„æ—¶éšè—æ‚¬æµ®çª—å£å¹¶é‡ç½®çŠ¶æ€
                hideTooltip();
                tooltipShouldShow = false;
            }
        }

        // æ¸…é™¤æ‰€æœ‰é«˜äº®æ•ˆæœ
        function clearAllHighlights() {
            if (!svg) return;
            // æ¸…é™¤èŠ‚ç‚¹é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (nodeGroups) {
                nodeGroups
                    .classed('highlighted', false)
                    .classed('search-highlighted', false)
                    .classed('relation-entity-highlighted', false)
                    .classed('faded', false);
            }
            // æ¸…é™¤è¿çº¿é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (linkElements) {
                linkElements
                    .classed('search-highlighted-link', false)
                    .classed('link-highlighted', false)
                    .classed('faded', false);
            }
            // æ¸…é™¤è¿çº¿æ ‡ç­¾é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (linkLabelElements) {
                linkLabelElements
                    .classed('search-highlighted-link-label', false)
                    .classed('link-label-highlighted', false)
                    .classed('faded', false);
            }
            // æ¸…é™¤ç®­å¤´é«˜äº®å’Œæ·¡åŒ–æ•ˆæœ
            if (arrowElements) {
                arrowElements
                    .classed('search-highlighted-arrow', false)
                    .classed('arrow-highlighted', false)
                    .classed('faded', false);
            }
        }

        // èŠ‚ç‚¹æ‹–æ‹½äº¤äº’å‡½æ•°
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function reloadGraph() {
            console.log('é‡æ–°åŠ è½½å›¾è°±ï¼ŒèŠ‚ç‚¹æ•°ï¼š', graphData.nodes.length);
            graphData.links.forEach(link => {
                if (typeof link.source !== 'string') link.source = link.source.id;
                if (typeof link.target !== 'string') link.target = link.target.id;
            });
            initializeGraph();
        }


        
        // è·å–Cookieçš„è¾…åŠ©å‡½æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // æè¿°æ¡†æ§åˆ¶åŠŸèƒ½
        function toggleDescription() {
            const descriptionBox = document.getElementById('entity-description');
            const descriptionText = document.getElementById('description-text');
            const expandBtn = document.querySelector('#entity-description .expand-btn');
            
            if (descriptionBox && descriptionText) {
                const isExpanded = descriptionBox.classList.contains('expanded');
                
                if (isExpanded) {
                    // æ”¶èµ·ï¼šæˆªæ–­æ–‡æœ¬
                    descriptionBox.classList.remove('expanded');
                    expandBtn.textContent = 'å±•å¼€';
                    
                    // å¦‚æœæ–‡æœ¬è¶…è¿‡100ä¸ªå­—ç¬¦ï¼Œæˆªæ–­æ˜¾ç¤º
                    const fullText = descriptionText.getAttribute('data-full-text');
                    if (fullText && fullText.length > 100) {
                        const truncatedText = fullText.substring(0, 100) + '...';
                        descriptionText.innerHTML = truncatedText.replace(/\n/g, '<br>');
                    }
                } else {
                    // å±•å¼€ï¼šæ˜¾ç¤ºå®Œæ•´æ–‡æœ¬
                    descriptionBox.classList.add('expanded');
                    expandBtn.textContent = 'æ”¶èµ·';
                    
                    // æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬
                    const fullText = descriptionText.getAttribute('data-full-text');
                    if (fullText) {
                        descriptionText.innerHTML = fullText.replace(/\n/g, '<br>');
                    }
                }
            }
        }
        
        function copyDescription() {
            const descriptionText = document.getElementById('description-text');
            if (descriptionText) {
                // å§‹ç»ˆå¤åˆ¶å®Œæ•´å†…å®¹
                const fullText = descriptionText.getAttribute('data-full-text') || descriptionText.textContent;
                navigator.clipboard.writeText(fullText).then(() => {
                    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                    const copyBtn = document.querySelector('#entity-description .copy-btn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'å·²å¤åˆ¶';
                    copyBtn.style.background = '#4caf50';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = '#2196f3';
                    }, 1000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                });
            }
        }

        // è§†å›¾æ§åˆ¶åŠŸèƒ½
        // éšè—æ‚¬æµ®çª—å£çš„å‡½æ•°
        function hideTooltip() {
            const tooltip = document.getElementById('entity-tooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
                tooltip.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(event, nodeData) {
            const contextMenu = document.getElementById('context-menu');
            if (!contextMenu) return;

            // è®¾ç½®èœå•ä½ç½®
            const x = event.clientX;
            const y = event.clientY;
            
            // ç¡®ä¿èœå•ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
            const menuWidth = 160;
            const menuHeight = 120;
            const finalX = x + menuWidth > window.innerWidth ? x - menuWidth : x;
            const finalY = y + menuHeight > window.innerHeight ? y - menuHeight : y;

            contextMenu.style.left = `${finalX}px`;
            contextMenu.style.top = `${finalY}px`;
            contextMenu.classList.add('visible');

            // è®¾ç½®åˆ é™¤æŒ‰é’®ä¸ºå±é™©æ ·å¼
            const deleteItem = document.getElementById('delete-entity-menu');
            if (deleteItem) {
                deleteItem.classList.add('danger');
            }
        }

        // æ˜¾ç¤ºå…³ç³»å³é”®èœå•
        function showRelationContextMenu(event, linkData) {
            const relationContextMenu = document.getElementById('relation-context-menu');
            if (!relationContextMenu) return;

            // è®¾ç½®èœå•ä½ç½®
            const x = event.clientX;
            const y = event.clientY;
            
            // ç¡®ä¿èœå•ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
            const menuWidth = 160;
            const menuHeight = 80;
            const finalX = x + menuWidth > window.innerWidth ? x - menuWidth : x;
            const finalY = y + menuHeight > window.innerHeight ? y - menuHeight : y;

            relationContextMenu.style.left = `${finalX}px`;
            relationContextMenu.style.top = `${finalY}px`;
            relationContextMenu.classList.add('visible');

            // è®¾ç½®åˆ é™¤æŒ‰é’®ä¸ºå±é™©æ ·å¼
            const deleteItem = document.getElementById('delete-relation-menu');
            if (deleteItem) {
                deleteItem.classList.add('danger');
            }
        }

        // éšè—å³é”®èœå•
        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            if (contextMenu) {
                contextMenu.classList.remove('visible');
            }
        }

        // éšè—å…³ç³»å³é”®èœå•
        function hideRelationContextMenu() {
            const relationContextMenu = document.getElementById('relation-context-menu');
            if (relationContextMenu) {
                relationContextMenu.classList.remove('visible');
            }
        }

        // ä»å³é”®èœå•æ–°å¢å®ä½“
        async function addNewEntityFromContext() {
            if (!selectedNode) return;
            
            try {
                // ç”Ÿæˆæ–°å®ä½“çš„åˆç†å±æ€§
                const baseId = selectedNode.id;
                const baseName = selectedNode.name;
                const baseDomain = selectedNode.domain || 'default';
                
                // ç”Ÿæˆæ–°çš„IDï¼ˆé¿å…é‡å¤ï¼‰
                let newId = `${baseId}_new`;
                let counter = 1;
                while (allGraphData.nodes.some(node => node.id === newId)) {
                    newId = `${baseId}_new_${counter}`;
                    counter++;
                }
                
                // ç”Ÿæˆæ–°çš„åç§°
                const newName = `${baseName}ç›¸å…³å®ä½“`;
                
                // åˆ›å»ºæ–°å®ä½“
                const newEntity = {
                    id: newId,
                    name: newName,
                    type: selectedNode.type || '',
                    description: `åŸºäº${baseName}åˆ›å»ºçš„æ–°å®ä½“`,
                    domain: baseDomain
                };
                
                // 1. å…ˆä¿å­˜å®ä½“åˆ°æ•°æ®åº“
                const entityResponse = await fetch('/api/kg/entities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newEntity)
                });
                
                if (!entityResponse.ok) {
                    throw new Error(`ä¿å­˜å®ä½“å¤±è´¥: ${entityResponse.status}`);
                }
                
                const entityResult = await entityResponse.json();
                if (entityResult.ret !== 0) {
                    throw new Error(`ä¿å­˜å®ä½“å¤±è´¥: ${entityResult.msg}`);
                }
                
                // 2. åˆ›å»ºä¸åŸå®ä½“çš„å…³ç³»
                const newRelation = {
                    source: selectedNode.id,
                    target: newId,
                    type: 'ç›¸å…³',
                    description: 'åŸºäºå³é”®èœå•åˆ›å»ºçš„å…³ç³»',
                    domain: baseDomain
                };
                
                // ä¿å­˜å…³ç³»åˆ°æ•°æ®åº“
                const relationResponse = await fetch('/api/kg/relationships', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newRelation)
                });
                
                if (!relationResponse.ok) {
                    throw new Error(`ä¿å­˜å…³ç³»å¤±è´¥: ${relationResponse.status}`);
                }
                
                const relationResult = await relationResponse.json();
                if (relationResult.ret !== 0) {
                    throw new Error(`ä¿å­˜å…³ç³»å¤±è´¥: ${relationResult.msg}`);
                }
                
                // 3. æ›´æ–°æœ¬åœ°æ•°æ®
                graphData.nodes.push(newEntity);
                graphData.links.push(newRelation);
                
                // 4. æ›´æ–°ç•Œé¢
                renderEntityList();
                updateEntityDropdowns();
                updateRelationTypeDropdown();
                initializeGraph();
                
                console.log('æ–°å¢å®ä½“æˆåŠŸ:', newEntity);
                console.log('æ–°å¢å…³ç³»æˆåŠŸ:', newRelation);
                
                // 5. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`æ–°å¢å®ä½“"${newName}"æˆåŠŸï¼\n\nå·²åŒæ­¥åˆ°æ•°æ®åº“ã€‚`);
                
                // å°†æ–°å¢çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = newName;
                }
                
            } catch (error) {
                console.error('æ–°å¢å®ä½“å¤±è´¥:', error);
                alert(`æ–°å¢å®ä½“å¤±è´¥: ${error.message}`);
            }
        }

        // ä»å³é”®èœå•åˆ é™¤å®ä½“
        async function deleteEntityFromContext() {
            if (!selectedNode) return;
            
            const entityId = selectedNode.id;
            const entityName = selectedNode.name;
            
            // åœ¨åˆ é™¤å‰å°†å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = entityName;
            }
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å®ä½“"${entityName}"å—ï¼Ÿ\n\nè¿™å°†åŒæ—¶åˆ é™¤æ‰€æœ‰ä¸è¯¥å®ä½“ç›¸å…³çš„å…³ç³»ã€‚`)) {
                return;
            }
            
            try {
                // 1. è·å–è¦åˆ é™¤çš„å…³ç³»æ•°é‡ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                const relationsToDelete = graphData.links.filter(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    return sourceId === entityId || targetId === entityId;
                });
                
                // 2. ä»æ•°æ®åº“åˆ é™¤å®ä½“ï¼ˆä¼šè‡ªåŠ¨çº§è”åˆ é™¤ç›¸å…³å…³ç³»ï¼‰
                const entityResponse = await fetch(`/api/kg/entities/${entityId}`, {
                    method: 'DELETE'
                });
                
                if (!entityResponse.ok) {
                    throw new Error(`åˆ é™¤å®ä½“å¤±è´¥: ${entityResponse.status}`);
                }
                
                const entityResult = await entityResponse.json();
                if (entityResult.ret !== 0) {
                    throw new Error(`åˆ é™¤å®ä½“å¤±è´¥: ${entityResult.msg}`);
                }
                
                // 3. æ›´æ–°æœ¬åœ°æ•°æ®
                // ä»å®Œæ•´æ•°æ®ä¸­åˆ é™¤å®ä½“
                allGraphData.nodes = allGraphData.nodes.filter(node => node.id !== entityId);
                allGraphData.links = allGraphData.links.filter(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    return sourceId !== entityId && targetId !== entityId;
                });
                
                // ä»å½“å‰è¿‡æ»¤æ•°æ®ä¸­åˆ é™¤å®ä½“
                graphData.nodes = graphData.nodes.filter(node => node.id !== entityId);
                graphData.links = graphData.links.filter(link => {
                    const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                    const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                    return sourceId !== entityId && targetId !== entityId;
                });
                
                // 4. æ¸…é™¤é€‰ä¸­çŠ¶æ€
                selectedNode = null;
                
                // 5. æ›´æ–°ç•Œé¢
                renderEntityList();
                updateEntityDropdowns();
                updateRelationTypeDropdown();
                initializeGraph();
                
                // å°†åˆ é™¤çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = entityName;
                }
                
                // æ¸…é™¤æœç´¢ç¼“å­˜
                resetSearchState();
                
                console.log(`åˆ é™¤å®ä½“"${entityName}"æˆåŠŸï¼ŒåŒæ—¶åˆ é™¤äº†${relationsToDelete.length}ä¸ªå…³ç³»`);
                
                // 6. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`åˆ é™¤å®ä½“"${entityName}"æˆåŠŸï¼\n\nå·²ä»æ•°æ®åº“åŒæ­¥åˆ é™¤ã€‚`);
                
            } catch (error) {
                console.error('åˆ é™¤å®ä½“å¤±è´¥:', error);
                alert(`åˆ é™¤å®ä½“å¤±è´¥: ${error.message}`);
            }
        }

        // ä»å³é”®èœå•ç¼–è¾‘å®ä½“
        function editEntityFromContext() {
            if (!selectedNode) return;
            
            // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
            if (currentMode !== 'preview') {
                switchToPreviewMode();
            }
            
            // å¼€å§‹ç¼–è¾‘é€‰ä¸­çš„å®ä½“
            startEditEntity(selectedNode.id);
        }

        // ä»å³é”®èœå•æ–°å¢å…³ç³»
        function addRelationFromContext() {
            if (!selectedNode) return;
            
            // è‡ªåŠ¨è®¾ç½®æºå®ä½“ä¸ºå½“å‰é€‰ä¸­çš„å®ä½“
            const sourceEntityInput = document.getElementById('source-entity');
            if (sourceEntityInput) {
                sourceEntityInput.value = selectedNode.id;
            }
            
            // æ›´æ–°æºå®ä½“æ˜¾ç¤º
            const sourceEntityDisplay = document.getElementById('source-entity-display');
            if (sourceEntityDisplay) {
                sourceEntityDisplay.value = selectedNode.name;
            }
            
            // æ»šåŠ¨åˆ°å…³ç³»è¡¨å•åŒºåŸŸ
            const relationForm = document.querySelector('.form-section');
            if (relationForm) {
                relationForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // ä»å³é”®èœå•å¤åˆ¶å®ä½“
        async function copyEntityFromContext() {
            if (!selectedNode) return;
            
            try {
                const originalEntity = selectedNode;
                const baseId = originalEntity.id;
                const baseName = originalEntity.name;
                const baseDomain = originalEntity.domain || 'default';
                
                // ç”Ÿæˆæ–°çš„IDï¼ˆé¿å…é‡å¤ï¼‰
                let newId = `${baseId}_copy`;
                let counter = 1;
                while (allGraphData.nodes.some(node => node.id === newId)) {
                    newId = `${baseId}_copy_${counter}`;
                    counter++;
                }
                
                // ç”Ÿæˆæ–°çš„åç§°
                const newName = `${baseName}å‰¯æœ¬`;
                
                // åˆ›å»ºå¤åˆ¶çš„å®ä½“
                const copiedEntity = {
                    id: newId,
                    name: newName,
                    type: originalEntity.type || '',
                    description: `åŸºäº${baseName}å¤åˆ¶çš„å®ä½“`,
                    domain: baseDomain
                };
                
                // 1. å…ˆä¿å­˜å¤åˆ¶çš„å®ä½“åˆ°æ•°æ®åº“
                const entityResponse = await fetch('/api/kg/entities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(copiedEntity)
                });
                
                if (!entityResponse.ok) {
                    throw new Error(`ä¿å­˜å¤åˆ¶å®ä½“å¤±è´¥: ${entityResponse.status}`);
                }
                
                const entityResult = await entityResponse.json();
                if (entityResult.ret !== 0) {
                    throw new Error(`ä¿å­˜å¤åˆ¶å®ä½“å¤±è´¥: ${entityResult.msg}`);
                }
                
                // 2. åˆ›å»ºä¸åŸå®ä½“çš„å…³ç³»
                const copyRelation = {
                    source: originalEntity.id,
                    target: newId,
                    type: 'å…³è”',
                    description: 'åŸºäºå³é”®èœå•å¤åˆ¶çš„å®ä½“',
                    domain: baseDomain
                };
                
                // ä¿å­˜å¤åˆ¶å…³ç³»åˆ°æ•°æ®åº“
                const relationResponse = await fetch('/api/kg/relationships', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(copyRelation)
                });
                
                if (!relationResponse.ok) {
                    throw new Error(`ä¿å­˜å¤åˆ¶å…³ç³»å¤±è´¥: ${relationResponse.status}`);
                }
                
                const relationResult = await relationResponse.json();
                if (relationResult.ret !== 0) {
                    throw new Error(`ä¿å­˜å¤åˆ¶å…³ç³»å¤±è´¥: ${relationResult.msg}`);
                }
                
                // 3. æ›´æ–°æœ¬åœ°æ•°æ®
                graphData.nodes.push(copiedEntity);
                graphData.links.push(copyRelation);
                
                // 4. æ›´æ–°ç•Œé¢
                renderEntityList();
                updateEntityDropdowns();
                updateRelationTypeDropdown();
                initializeGraph();
                
                console.log('å¤åˆ¶å®ä½“æˆåŠŸ:', copiedEntity);
                console.log('åˆ›å»ºå¤åˆ¶å…³ç³»æˆåŠŸ:', copyRelation);
                
                // 5. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`å¤åˆ¶å®ä½“"${newName}"æˆåŠŸï¼\n\nå·²åŒæ­¥åˆ°æ•°æ®åº“ã€‚`);
                
                // å°†å¤åˆ¶çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = newName;
                }
                
            } catch (error) {
                console.error('å¤åˆ¶å®ä½“å¤±è´¥:', error);
                alert(`å¤åˆ¶å®ä½“å¤±è´¥: ${error.message}`);
            }
        }

        // ä»å³é”®èœå•å¤åˆ¶5ä¸ªå®ä½“
        async function copy5EntitiesFromContext() {
            if (!selectedNode) return;
            
            try {
                const originalEntity = selectedNode;
                const baseId = originalEntity.id;
                const baseName = originalEntity.name;
                const baseDomain = originalEntity.domain || 'default';
                
                const copiedEntities = [];
                const copiedRelations = [];
                
                // å¤åˆ¶5ä¸ªå®ä½“
                for (let i = 1; i <= 5; i++) {
                    // ç”Ÿæˆæ–°çš„IDï¼ˆé¿å…é‡å¤ï¼‰
                    let newId = `${baseId}_copy_${i}`;
                    let counter = 1;
                    while (allGraphData.nodes.some(node => node.id === newId)) {
                        newId = `${baseId}_copy_${i}_${counter}`;
                        counter++;
                    }
                    
                    // ç”Ÿæˆæ–°çš„åç§°
                    const newName = `${baseName}å‰¯æœ¬${i}`;
                    
                    // åˆ›å»ºå¤åˆ¶çš„å®ä½“
                    const copiedEntity = {
                        id: newId,
                        name: newName,
                        type: originalEntity.type || '',
                        description: `åŸºäº${baseName}å¤åˆ¶çš„å®ä½“${i}`,
                        domain: baseDomain
                    };
                    
                    // 1. å…ˆä¿å­˜å¤åˆ¶çš„å®ä½“åˆ°æ•°æ®åº“
                    const entityResponse = await fetch('/api/kg/entities', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(copiedEntity)
                    });
                    
                    if (!entityResponse.ok) {
                        throw new Error(`ä¿å­˜å¤åˆ¶å®ä½“${i}å¤±è´¥: ${entityResponse.status}`);
                    }
                    
                    const entityResult = await entityResponse.json();
                    if (entityResult.ret !== 0) {
                        throw new Error(`ä¿å­˜å¤åˆ¶å®ä½“${i}å¤±è´¥: ${entityResult.msg}`);
                    }
                    
                    // 2. åˆ›å»ºä¸åŸå®ä½“çš„å…³ç³»
                    const copyRelation = {
                        source: originalEntity.id,
                        target: newId,
                        type: 'å…³è”',
                        description: `åŸºäºå³é”®èœå•å¤åˆ¶çš„å®ä½“${i}`,
                        domain: baseDomain
                    };
                    
                    // ä¿å­˜å¤åˆ¶å…³ç³»åˆ°æ•°æ®åº“
                    const relationResponse = await fetch('/api/kg/relationships', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(copyRelation)
                    });
                    
                    if (!relationResponse.ok) {
                        throw new Error(`ä¿å­˜å¤åˆ¶å…³ç³»${i}å¤±è´¥: ${relationResponse.status}`);
                    }
                    
                    const relationResult = await relationResponse.json();
                    if (relationResult.ret !== 0) {
                        throw new Error(`ä¿å­˜å¤åˆ¶å…³ç³»${i}å¤±è´¥: ${relationResult.msg}`);
                    }
                    
                    // æ”¶é›†å¤åˆ¶çš„å®ä½“å’Œå…³ç³»
                    copiedEntities.push(copiedEntity);
                    copiedRelations.push(copyRelation);
                }
                
                // 3. æ›´æ–°æœ¬åœ°æ•°æ®
                graphData.nodes.push(...copiedEntities);
                graphData.links.push(...copiedRelations);
                
                // 4. æ›´æ–°ç•Œé¢
                renderEntityList();
                updateEntityDropdowns();
                updateRelationTypeDropdown();
                initializeGraph();
                
                console.log('å¤åˆ¶5ä¸ªå®ä½“æˆåŠŸ:', copiedEntities);
                console.log('åˆ›å»ºå¤åˆ¶å…³ç³»æˆåŠŸ:', copiedRelations);
                
                // 5. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`æˆåŠŸå¤åˆ¶5ä¸ªå®ä½“ï¼\n\nå·²åŒæ­¥åˆ°æ•°æ®åº“ã€‚\nå¤åˆ¶çš„å®ä½“ï¼š\n${copiedEntities.map(e => `- ${e.name}`).join('\n')}`);
                
                // å°†æœ€åä¸€ä¸ªå¤åˆ¶çš„å®ä½“åç§°å¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = copiedEntities[copiedEntities.length - 1].name;
                }
                
            } catch (error) {
                console.error('å¤åˆ¶5ä¸ªå®ä½“å¤±è´¥:', error);
                alert(`å¤åˆ¶5ä¸ªå®ä½“å¤±è´¥: ${error.message}`);
            }
        }

        // ä»å³é”®èœå•ç¼–è¾‘å…³ç³»
        function editRelationFromContext() {
            if (!selectedLink) return;
            
            // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
            if (currentMode !== 'preview') {
                switchToPreviewMode();
            }
            
            // æ‰¾åˆ°å…³ç³»çš„ç´¢å¼•
            const linkIndex = graphData.links.findIndex(link => 
                link.id === selectedLink.id || 
                (link.source === selectedLink.source && link.target === selectedLink.target && link.type === selectedLink.type)
            );
            
            if (linkIndex >= 0) {
                // å¼€å§‹ç¼–è¾‘é€‰ä¸­çš„å…³ç³»
                startEditRelation(linkIndex);
            } else {
                alert('æ— æ³•æ‰¾åˆ°è¦ç¼–è¾‘çš„å…³ç³»');
            }
        }

        // ä»å³é”®èœå•åˆ é™¤å…³ç³»
        async function deleteRelationFromContext() {
            if (!selectedLink) return;
            
            const relationId = selectedLink.id;
            const relationType = selectedLink.type;
            const sourceName = typeof selectedLink.source === 'object' ? selectedLink.source.name : 
                              graphData.nodes.find(n => n.id === selectedLink.source)?.name || selectedLink.source;
            const targetName = typeof selectedLink.target === 'object' ? selectedLink.target.name : 
                              graphData.nodes.find(n => n.id === selectedLink.target)?.name || selectedLink.target;
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å…³ç³»"${relationType}"å—ï¼Ÿ\n\nä»"${sourceName}"åˆ°"${targetName}"`)) {
                return;
            }
            
            try {
                // è°ƒç”¨åç«¯APIåˆ é™¤å…³ç³»
                const success = await deleteRelationshipAPI(relationId);
                if (success) {
                    // ä»æœ¬åœ°æ•°æ®ä¸­åˆ é™¤å…³ç³»
                    graphData.links = graphData.links.filter(link => link.id !== relationId);
                    
                    // æ›´æ–°å›¾å½¢æ˜¾ç¤º
                    updateGraphDataLocally();
                    
                    // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                    selectedLink = null;
                    clearAllHighlights();
                    
                    console.log('å…³ç³»åˆ é™¤æˆåŠŸ');
                } else {
                    alert('å…³ç³»åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å…³ç³»å¤±è´¥:', error);
                alert(`åˆ é™¤å…³ç³»å¤±è´¥: ${error.message}`);
            }
        }

        // æ‚¬æµ®çª—å£æ˜¾ç¤ºçŠ¶æ€æ§åˆ¶
        let tooltipShouldShow = false;

        function zoomIn() {
            if (!svg || !zoom) return;
            hideTooltip(); // ç¼©æ”¾æ—¶éšè—æ‚¬æµ®çª—å£
            tooltipShouldShow = false; // é‡ç½®æ‚¬æµ®çª—å£çŠ¶æ€
            svg.transition().duration(300).call(
                zoom.scaleBy, 1.3
            );
        }

        function zoomOut() {
            if (!svg || !zoom) return;
            hideTooltip(); // ç¼©æ”¾æ—¶éšè—æ‚¬æµ®çª—å£
            tooltipShouldShow = false; // é‡ç½®æ‚¬æµ®çª—å£çŠ¶æ€
            svg.transition().duration(300).call(
                zoom.scaleBy, 0.77
            );
        }

        function fitView() {
            if (!svg || !zoom || graphData.nodes.length === 0) return;
            hideTooltip(); // é€‚é…æ˜¾ç¤ºæ—¶éšè—æ‚¬æµ®çª—å£
            tooltipShouldShow = false; // é‡ç½®æ‚¬æµ®çª—å£çŠ¶æ€

            const nodes = graphData.nodes;
            const minX = Math.min(...nodes.map(d => d.x));
            const maxX = Math.max(...nodes.map(d => d.x));
            const minY = Math.min(...nodes.map(d => d.y));
            const maxY = Math.max(...nodes.map(d => d.y));

            const width = maxX - minX;
            const height = maxY - minY;

            const container = document.getElementById('graph-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            const scaleX = containerWidth / (width * 1.1);
            const scaleY = containerHeight / (height * 1.1);
            const scale = Math.min(scaleX, scaleY, 1);

            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;

            svg.transition().duration(700).call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(containerWidth / 2, containerHeight / 2)
                    .scale(scale)
                    .translate(-centerX, -centerY)
            );
        }

        function resetLayout() {
            if (!simulation) return;
            hideTooltip(); // é‡ç½®å¸ƒå±€æ—¶éšè—æ‚¬æµ®çª—å£
            tooltipShouldShow = false; // é‡ç½®æ‚¬æµ®çª—å£çŠ¶æ€

            simulation.alpha(0.3).restart();

            if (svg && zoom) {
                svg.transition().duration(300).call(
                    zoom.transform,
                    transform
                );
            }
        }

        function centerNodeInView(nodeId) {
            if (!svg || !zoom) return;

            // é¦–å…ˆå°è¯•ä»å½“å‰graphDataä¸­æŸ¥æ‰¾èŠ‚ç‚¹
            let node = graphData.nodes.find(n => n.id === nodeId);
            
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»allGraphDataä¸­æŸ¥æ‰¾
            if (!node && allGraphData && allGraphData.nodes) {
                node = allGraphData.nodes.find(n => n.id === nodeId);
            }
            
            if (!node) {
                console.warn(`æœªæ‰¾åˆ°èŠ‚ç‚¹: ${nodeId}`);
                return;
            }

            // å¦‚æœèŠ‚ç‚¹æ²¡æœ‰ä½ç½®ä¿¡æ¯ï¼Œå°è¯•ä»D3.jsçš„simulationä¸­è·å–
            if (node.x === undefined || node.y === undefined) {
                const d3Node = d3.selectAll('.node').filter(d => d.id === nodeId);
                if (!d3Node.empty()) {
                    const nodeData = d3Node.datum();
                    if (nodeData.x !== undefined && nodeData.y !== undefined) {
                        node.x = nodeData.x;
                        node.y = nodeData.y;
                    } else {
                        console.warn(`èŠ‚ç‚¹ ${nodeId} åœ¨D3.jsä¸­æ²¡æœ‰ä½ç½®ä¿¡æ¯`);
                        return;
                    }
                } else {
                    console.warn(`æœªæ‰¾åˆ°èŠ‚ç‚¹ ${nodeId} çš„D3.jså…ƒç´ `);
                    return;
                }
            }

            const container = document.getElementById('graph-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            // å‡å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å±…ä¸­æ”¾å¤§æ•ˆæœæ›´å°
            let scale = 1.0;
            if (graphData.nodes.length > 10) {
                scale = 1.3;
            } else if (graphData.nodes.length <= 3) {
                scale = 0.8;
            }

            scale = Math.min(scale, 3); // é™åˆ¶æœ€å¤§ç¼©æ”¾æ¯”ä¾‹

            svg.transition()
                .duration(800)
                .ease(d3.easeCubic)
                .call(zoom.transform,
                    d3.zoomIdentity
                        .translate(containerWidth / 2, containerHeight / 2)
                        .scale(scale)
                        .translate(-node.x, -node.y)
                );
        }

        // ä¸ºæœç´¢åˆ°çš„å®ä½“æ·»åŠ é»„è‰²é«˜äº®ï¼Œå¹¶æ·¡åŒ–å…¶ä»–å®ä½“å’Œå…³ç³»
        function highlightSearchEntity(nodeId) {
            clearAllHighlights();

            // é«˜äº®åŒ¹é…çš„å®ä½“
            nodeGroups.filter(d => d.id === nodeId)
                .classed('search-highlighted', true);

            // æ·¡åŒ–æ‰€æœ‰å…¶ä»–å®ä½“
            nodeGroups.filter(d => d.id !== nodeId)
                .classed('faded', true);

            // æ·¡åŒ–æ‰€æœ‰å…³ç³»
            if (linkElements) {
                linkElements.classed('faded', true);
            }
            if (linkLabelElements) {
                linkLabelElements.classed('faded', true);
            }
            if (arrowElements) {
                arrowElements.classed('faded', true);
            }
        }

        // ä¸ºæœç´¢åˆ°çš„å…³ç³»æ·»åŠ é»„è‰²é«˜äº®ï¼Œå¹¶æ·¡åŒ–å…¶ä»–å®ä½“å’Œå…³ç³»
        function highlightSearchRelation(link) {
            clearAllHighlights();

            // æ‰¾åˆ°å½“å‰å…³ç³»åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
            const linkIndex = graphData.links.findIndex(l => {
                const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                return lSourceId === sourceId && lTargetId === targetId && l.type === link.type;
            });

            if (linkIndex === -1) return; // æœªæ‰¾åˆ°å…³ç³»ï¼Œé€€å‡º

            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;
            const relationType = link.type;

            // é«˜äº®ç›¸å…³èŠ‚ç‚¹
            nodeGroups.filter(d => d.id === sourceId || d.id === targetId)
                .classed('search-highlighted', true);

            // æ·¡åŒ–å…¶ä»–èŠ‚ç‚¹
            nodeGroups.filter(d => d.id !== sourceId && d.id !== targetId)
                .classed('faded', true);

            // é«˜äº®åŒ¹é…çš„å…³ç³»è¿çº¿
            if (linkElements) {
                linkElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return lSourceId === sourceId && lTargetId === targetId && l.type === relationType;
                }).classed('search-highlighted-link', true)
                  .classed('faded', false);

                // æ·¡åŒ–å…¶ä»–å…³ç³»
                linkElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return !(lSourceId === sourceId && lTargetId === targetId && l.type === relationType);
                }).classed('faded', true);
            }

            // é«˜äº®åŒ¹é…çš„å…³ç³»æ ‡ç­¾
            if (linkLabelElements) {
                linkLabelElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return lSourceId === sourceId && lTargetId === targetId && l.type === relationType;
                }).classed('search-highlighted-link-label', true)
                  .classed('faded', false);

                // æ·¡åŒ–å…¶ä»–å…³ç³»æ ‡ç­¾
                linkLabelElements.filter(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return !(lSourceId === sourceId && lTargetId === targetId && l.type === relationType);
                }).classed('faded', true);
            }

            // é«˜äº®åŒ¹é…å…³ç³»çš„ç®­å¤´
            if (arrowElements) {
                // æ‰¾åˆ°å½“å‰å…³ç³»å¯¹åº”çš„ç®­å¤´å¹¶é«˜äº®
                arrowElements.filter(`[data-link-index="${linkIndex}"]`)
                    .classed('search-highlighted-arrow', true)
                    .classed('faded', false);

                // æ·¡åŒ–å…¶ä»–ç®­å¤´
                arrowElements.filter(`[data-link-index!="${linkIndex}"]`)
                    .classed('faded', true);
            }
        }

        function centerRelationInView(link) {
            if (!svg || !zoom || !link) return;

            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;

            const sourceNode = graphData.nodes.find(n => n.id === sourceId);
            const targetNode = graphData.nodes.find(n => n.id === targetId);
            if (!sourceNode || !targetNode) return;

            // è®¡ç®—å…³ç³»ä¸­ç‚¹
            const midX = (sourceNode.x + targetNode.x) / 2;
            const midY = (sourceNode.y + targetNode.y) / 2;

            // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œç”¨äºåŠ¨æ€è°ƒæ•´ç¼©æ”¾çº§åˆ«
            const distance = Math.sqrt(
                Math.pow(sourceNode.x - targetNode.x, 2) +
                Math.pow(sourceNode.y - targetNode.y, 2)
            );

            const container = document.getElementById('graph-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            // å‡å°ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿å±…ä¸­æ”¾å¤§æ•ˆæœæ›´å°
            let scale = Math.min(containerWidth / (distance * 2.0), 2);
            scale = Math.max(scale, 0.5); // ç¡®ä¿ç¼©æ”¾ä¸ä¼šå¤ªå°

            svg.transition()
                .duration(800)
                .ease(d3.easeCubic)
                .call(zoom.transform,
                    d3.zoomIdentity
                        .translate(containerWidth / 2, containerHeight / 2)
                        .scale(scale)
                        .translate(-midX, -midY)
                );
        }

        // ------------------------------
        // è¯¦æƒ…å±•ç¤ºä¸ç¼–è¾‘åŠŸèƒ½
        // ------------------------------
        function showEntityDetail(entity) {
            selectedNode = entity;
            selectedLink = null;

            // æ£€æŸ¥æ˜¯å¦å¤„äºç¼–è¾‘çŠ¶æ€
            const isEditing = editingEntityId === entity.id;

            // å¦‚æœæ˜¯ç¼–è¾‘çŠ¶æ€ï¼Œæ˜¾ç¤ºç¼–è¾‘é¡µé¢
            if (isEditing) {
                showEntityEditPage(entity);
                return;
            }

            const relatedLinks = graphData.links.filter(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                return sourceId === entity.id || targetId === entity.id;
            });

            let relationsHtml = '';
            relatedLinks.forEach((link, index) => {
                const isSource = (typeof link.source === 'object' ? link.source.id : link.source) === entity.id;
                const otherNodeId = isSource
                    ? (typeof link.target === 'object' ? link.target.id : link.target)
                    : (typeof link.source === 'object' ? link.source.id : link.source);
                const otherNode = graphData.nodes.find(n => n.id === otherNodeId);

                const sourceId = isSource ? entity.id : otherNodeId;
                const targetId = isSource ? otherNodeId : entity.id;
                const linkIndex = graphData.links.findIndex(l => {
                    const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return lSourceId === sourceId && lTargetId === targetId && l.type === link.type;
                });

                relationsHtml += `
                    <div class="relation-item">
                        <strong>${isSource ? 'â†’ ' : 'â† '}${link.type}</strong>
                        <div>${otherNode ? otherNode.name : 'æœªçŸ¥å®ä½“'}</div>
                        <div class="entity-actions" style="margin-top: 5px;">
                            <div class="action-btn edit-btn"
                                onclick="startEditRelation(${linkIndex})">
                                ç¼–è¾‘
                            </div>
                            <div class="action-btn delete-btn"
                                onclick="deleteRelation('${sourceId}', '${targetId}', '${link.type}')">
                                åˆ é™¤
                            </div>
                        </div>
                    </div>
                `;
            });

            detailView.innerHTML = `
                <div class="detail-header">å®ä½“è¯¦æƒ…</div>
                <div class="detail-section">
                    <h3>å®ä½“ID</h3>
                    <div class="detail-content">${entity.id}</div>
                </div>
                <div class="detail-section">
                    <h3>å®ä½“åç§°</h3>
                    <div class="detail-content">${entity.name}</div>
                </div>
                <div class="detail-section">
                    <h3>å›¾è°±é¢†åŸŸ</h3>
                    <div class="detail-content">${entity.domain || 'default'}</div>
                </div>
                <div class="detail-section">
                    <h3>å®ä½“æè¿°</h3>
                    <div class="detail-content resizable-description" id="entity-description">
                        <div class="description-text" id="description-text">${(entity.description || 'æ— æè¿°').replace(/\n/g, '<br>')}</div>
                        <div class="description-controls" style="display: ${entity.description && entity.description !== 'æ— æè¿°' ? 'flex' : 'none'}">
                            <button class="copy-btn" onclick="copyDescription()">å¤åˆ¶</button>
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>æ“ä½œ</h3>
                    <div class="entity-actions">
                        <div class="action-btn edit-btn" onclick="startEditEntity('${entity.id}')">
                            ç¼–è¾‘å®ä½“
                        </div>
                        <div class="action-btn copy-btn" onclick="copyEntityWithRelation('${entity.id}')">
                            å¤åˆ¶å®ä½“
                        </div>
                        <div class="action-btn delete-btn" onclick="deleteEntity('${entity.id}')">
                            åˆ é™¤å®ä½“
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>å…³è”å…³ç³» (${relatedLinks.length})</h3>
                    <div class="detail-content">
                        ${relationsHtml || 'æ— å…³è”å…³ç³»'}
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºå…³ç³»è¯¦æƒ…å¹¶æä¾›ç¼–è¾‘åŠŸèƒ½
        function showRelationDetail(link) {
            selectedLink = link;
            selectedNode = null;

            const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
            const targetId = typeof link.target === 'object' ? link.target.id : link.target;
            const sourceEntity = graphData.nodes.find(n => n.id === sourceId);
            const targetEntity = graphData.nodes.find(n => n.id === targetId);

            // æ‰¾åˆ°å…³ç³»åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
            const linkIndex = graphData.links.findIndex(l => {
                const lSourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const lTargetId = typeof l.target === 'object' ? l.target.id : l.target;
                return lSourceId === sourceId && lTargetId === targetId && l.type === link.type;
            });

            // æ£€æŸ¥æ˜¯å¦å¤„äºç¼–è¾‘çŠ¶æ€
            const isEditing = editingLinkIndex === linkIndex;

            detailView.innerHTML = `
                <div class="detail-header">å…³ç³»è¯¦æƒ…</div>
                <div class="detail-section">
                    <h3>å…³ç³»ç±»å‹</h3>
                    <div class="detail-content">${link.type}</div>
                </div>
                <div class="detail-section">
                    <h3>å…³ç³»æè¿°</h3>
                    <div class="detail-content">${link.description || 'æ— æè¿°'}</div>
                </div>
                <div class="detail-section">
                    <h3>æºå®ä½“</h3>
                    <div class="detail-content" onclick="showEntityDetail(${JSON.stringify(sourceEntity)})"
                         style="cursor: pointer; text-decoration: underline;">
                        ${sourceEntity?.name || 'æœªçŸ¥å®ä½“'} (ID: ${sourceId})
                    </div>
                </div>
                <div class="detail-section">
                    <h3>ç›®æ ‡å®ä½“</h3>
                    <div class="detail-content" onclick="showEntityDetail(${JSON.stringify(targetEntity)})"
                         style="cursor: pointer; text-decoration: underline;">
                        ${targetEntity?.name || 'æœªçŸ¥å®ä½“'} (ID: ${targetId})
                    </div>
                </div>
                <div class="detail-section">
                    <h3>æ“ä½œ</h3>
                    <div class="entity-actions">
                        <div class="action-btn edit-btn" onclick="startEditRelation(${linkIndex})">
                            ç¼–è¾‘å…³ç³»
                        </div>
                        <div class="action-btn delete-btn"
                            onclick="deleteRelation('${sourceId}', '${targetId}', '${link.type}')">
                            åˆ é™¤å…³ç³»
                        </div>
                    </div>
                </div>

                ${isEditing ? `
                <!-- å…³ç³»ç¼–è¾‘è¡¨å• -->
                <div class="relation-edit-form">
                    <h3 class="list-title">ç¼–è¾‘å…³ç³»</h3>
                    <div class="form-group">
                        <label for="edit-source-entity-display">æºå®ä½“</label>
                        <div class="entity-select-container">
                            <input type="text" id="edit-source-entity-display"
                                   value="${sourceEntity?.name || ''}"
                                   placeholder="é€‰æ‹©æˆ–æœç´¢æºå®ä½“">
                            <input type="hidden" id="edit-source-entity" value="${sourceId}">
                            <div class="entity-dropdown" id="edit-source-entity-dropdown"></div>
                        </div>
                    </div>
                    
                    <!-- äº’æ¢å€¼æŒ‰é’® -->
                    <div class="swap-entities-container">
                        <button type="button" class="btn-swap" onclick="swapEntities()" title="äº’æ¢æºå®ä½“å’Œç›®æ ‡å®ä½“">
                            â‡„ äº’æ¢
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-target-entity-display">ç›®æ ‡å®ä½“</label>
                        <div class="entity-select-container">
                            <input type="text" id="edit-target-entity-display"
                                   value="${targetEntity?.name || ''}"
                                   placeholder="é€‰æ‹©æˆ–æœç´¢ç›®æ ‡å®ä½“">
                            <input type="hidden" id="edit-target-entity" value="${targetId}">
                            <div class="entity-dropdown" id="edit-target-entity-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-relation-type-display">å…³ç³»ç±»å‹</label>
                        <div class="relation-type-select-container">
                            <input type="text" id="edit-relation-type-display"
                                   value="${link.type}"
                                   placeholder="è¾“å…¥æˆ–é€‰æ‹©å…³ç³»ç±»å‹">

                            <input type="hidden" id="edit-relation-type" value="${link.type}">
                            <div class="relation-type-dropdown" id="edit-relation-type-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-relation-description">å…³ç³»æè¿°</label>
                        <textarea id="edit-relation-description" rows="3" placeholder="è¾“å…¥å…³ç³»æè¿°">${link.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-edge-type">è¾¹ç±»å‹</label>
                        <select id="edit-edge-type" class="form-control">
                            <option value="solid-arrow" ${link.edgeType === 'solid-arrow' ? 'selected' : ''}>å®çº¿ + å®å¿ƒé»‘è‰²ä¸‰è§’ç®­å¤´</option>
                            <option value="dashed-arrow" ${link.edgeType === 'dashed-arrow' ? 'selected' : ''}>è™šçº¿ + å®å¿ƒé»‘è‰²ä¸‰è§’ç®­å¤´</option>
                            <option value="solid-triangle" ${link.edgeType === 'solid-triangle' ? 'selected' : ''}>å®çº¿ + ç©ºå¿ƒä¸‰è§’ç®­å¤´</option>
                            <option value="dashed-triangle" ${link.edgeType === 'dashed-triangle' ? 'selected' : ''}>è™šçº¿ + ç©ºå¿ƒä¸‰è§’ç®­å¤´</option>
                            <option value="hollow-diamond" ${link.edgeType === 'hollow-diamond' ? 'selected' : ''}>å®çº¿ + ç©ºå¿ƒè±å½¢</option>
                            <option value="solid-diamond" ${link.edgeType === 'solid-diamond' ? 'selected' : ''}>å®çº¿ + å®å¿ƒé»‘è‰²è±å½¢</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="save-relation-edit" class="btn-primary"
                            onclick="saveRelationEdit(${linkIndex})">ä¿å­˜ä¿®æ”¹</button>
                        <button class="btn-secondary" onclick="cancelRelationEdit()">å–æ¶ˆ</button>
                    </div>
                </div>
                ` : ''}
            `;

            // åªæœ‰åœ¨ç¼–è¾‘çŠ¶æ€ä¸‹æ‰åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
            if (isEditing) {
            // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å®ä½“é€‰æ‹©ä¸‹æ‹‰æ¡†
            initEditRelationDropdowns();

            // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
            initEditRelationTypeDropdown();
            }
        }

        // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å®ä½“é€‰æ‹©ä¸‹æ‹‰æ¡†
        function initEditRelationDropdowns() {
            const editSourceDisplay = document.getElementById('edit-source-entity-display');
            const editSourceInput = document.getElementById('edit-source-entity');
            const editSourceDropdown = document.getElementById('edit-source-entity-dropdown');

            const editTargetDisplay = document.getElementById('edit-target-entity-display');
            const editTargetInput = document.getElementById('edit-target-entity');
            const editTargetDropdown = document.getElementById('edit-target-entity-dropdown');

            // æŒ‰æ·»åŠ æ—¶é—´æ’åºï¼Œæœ€è¿‘æ·»åŠ çš„åœ¨å‰é¢
            const sortedEntities = [...graphData.nodes].reverse();

            // å¡«å……æºå®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(editSourceDropdown, sortedEntities);

            // å¡«å……ç›®æ ‡å®ä½“ä¸‹æ‹‰æ¡†
            updateEntityDropdown(editTargetDropdown, sortedEntities);

            // ä¸ºæºå®ä½“è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            editSourceDisplay.addEventListener('focus', () => {
                editSourceDropdown.classList.add('visible');
            });

            editSourceDisplay.addEventListener('input', () => {
                const filtered = filterEntities(editSourceDisplay.value);
                updateEntityDropdown(editSourceDropdown, filtered);
                editSourceDropdown.classList.add('visible');
            });

            // ä¸ºç›®æ ‡å®ä½“è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            editTargetDisplay.addEventListener('focus', () => {
                editTargetDropdown.classList.add('visible');
            });

            editTargetDisplay.addEventListener('input', () => {
                const filtered = filterEntities(editTargetDisplay.value);
                updateEntityDropdown(editTargetDropdown, filtered);
                editTargetDropdown.classList.add('visible');
            });

            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†çš„äº‹ä»¶
            document.addEventListener('click', (e) => {
                if (!editSourceDisplay.contains(e.target) && !editSourceDropdown.contains(e.target)) {
                    editSourceDropdown.classList.remove('visible');
                }
                if (!editTargetDisplay.contains(e.target) && !editTargetDropdown.contains(e.target)) {
                    editTargetDropdown.classList.remove('visible');
                }
            });
        }

        // åˆå§‹åŒ–ç¼–è¾‘å…³ç³»æ—¶çš„å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
        function initEditRelationTypeDropdown() {
            const editRelationTypeDisplay = document.getElementById('edit-relation-type-display');
            const editRelationTypeInput = document.getElementById('edit-relation-type');
            const editRelationTypeDropdown = document.getElementById('edit-relation-type-dropdown');

            // å¡«å……å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
            updateRelationTypeDropdownForEdit(editRelationTypeDropdown);

            // ä¸ºå…³ç³»ç±»å‹è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            editRelationTypeDisplay.addEventListener('focus', () => {
                editRelationTypeDropdown.classList.add('visible');
            });

            editRelationTypeDisplay.addEventListener('input', () => {
                const inputValue = editRelationTypeDisplay.value.trim();
                const filtered = filterRelationTypes(inputValue);
                // æ¸…ç©ºä¸‹æ‹‰æ¡†
                editRelationTypeDropdown.innerHTML = '';

                // 1. æ·»åŠ è‡ªå®šä¹‰è¾“å…¥é€‰é¡¹ï¼ˆè‹¥è¾“å…¥ä¸ä¸ºç©ºä¸”æœªåŒ¹é…ç°æœ‰ç±»å‹ï¼‰
                if (inputValue && !filtered.includes(inputValue)) {
                    const customItem = document.createElement('div');
                    customItem.className = 'dropdown-item';
                    customItem.textContent = `è‡ªå®šä¹‰: ${inputValue}`;
                    customItem.dataset.type = inputValue;
                    customItem.style.color = '#2e7d32';

                    customItem.addEventListener('click', () => {
                        editRelationTypeInput.value = inputValue;
                        editRelationTypeDisplay.value = inputValue;
                        editRelationTypeDropdown.classList.remove('visible');
                    });

                    editRelationTypeDropdown.appendChild(customItem);
                }

                // 2. æ·»åŠ è¿‡æ»¤åçš„ç°æœ‰ç±»å‹
                if (filtered.length === 0 && !inputValue) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'dropdown-item';
                    emptyItem.textContent = 'æ— åŒ¹é…çš„å…³ç³»ç±»å‹';
                    emptyItem.style.cursor = 'default';
                    emptyItem.style.opacity = '0.7';
                    editRelationTypeDropdown.appendChild(emptyItem);
            } else {
                    filtered.forEach(type => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = type;
                        item.dataset.type = type;

                        item.addEventListener('click', () => {
                            editRelationTypeInput.value = type;
                            editRelationTypeDisplay.value = type;
                            editRelationTypeDropdown.classList.remove('visible');
                        });

                        editRelationTypeDropdown.appendChild(item);
                    });
                }
                editRelationTypeDropdown.classList.add('visible');
            });

            // 3. å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜è‡ªå®šä¹‰è¾“å…¥
            editRelationTypeDisplay.addEventListener('blur', () => {
                const inputValue = editRelationTypeDisplay.value.trim();
                if (inputValue) {
                    editRelationTypeInput.value = inputValue;
                    setTimeout(() => {
                        editRelationTypeDropdown.classList.remove('visible');
                    }, 200);
                }
            });

            // ä¸ºå…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†ä¸­çš„é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            editRelationTypeDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    editRelationTypeInput.value = item.dataset.type;
                    editRelationTypeDisplay.value = item.dataset.type;
                    editRelationTypeDropdown.classList.remove('visible');
                });
            });
        }

        // æ›´æ–°ç¼–è¾‘å…³ç³»æ—¶çš„å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
        function updateRelationTypeDropdownForEdit(dropdownElement, types) {
            dropdownElement.innerHTML = '';

            const relationTypes = types || Array.from(usedRelationTypes).sort();

            if (relationTypes.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'dropdown-item';
                emptyItem.textContent = 'æš‚æ— å…³ç³»ç±»å‹';
                emptyItem.style.cursor = 'default';
                emptyItem.style.opacity = '0.7';
                dropdownElement.appendChild(emptyItem);
                return;
            }

            relationTypes.forEach(type => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = type;
                item.dataset.type = type;

                dropdownElement.appendChild(item);
            });
        }

        // ä¿å­˜å…³ç³»ç¼–è¾‘
        async function saveRelationEdit(linkIndex) {
            if (linkIndex < 0 || linkIndex >= graphData.links.length) return;

            const sourceId = document.getElementById('edit-source-entity').value;
            const targetId = document.getElementById('edit-target-entity').value;
            const type = document.getElementById('edit-relation-type').value.trim();
            const description = document.getElementById('edit-relation-description').value.trim();
            const edgeType = document.getElementById('edit-edge-type').value;

            if (!sourceId || !targetId || !type) {
                alert('è¯·å®Œå–„å…³ç³»ä¿¡æ¯');
                return;
            }

            if (sourceId === targetId) {
                alert('æºå®ä½“å’Œç›®æ ‡å®ä½“ä¸èƒ½ç›¸åŒ');
                return;
            }

            // æ£€æŸ¥æ›´æ–°åçš„å…³ç³»æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ’é™¤è‡ªèº«ï¼‰
            const relationExists = graphData.links.some((link, index) => {
                if (index === linkIndex) return false;

                const lSourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const lTargetId = typeof link.target === 'object' ? link.target.id : link.target;
                return lSourceId === sourceId && lTargetId === targetId && link.type === type;
            });

            if (relationExists) {
                alert('æ­¤å…³ç³»å·²å­˜åœ¨');
                return;
            }

            // è·å–åŸå§‹å…³ç³»æ•°æ®ç”¨äºAPIè°ƒç”¨
            const originalLink = graphData.links[linkIndex];
            const originalSourceId = typeof originalLink.source === 'object' ? originalLink.source.id : originalLink.source;
            const originalTargetId = typeof originalLink.target === 'object' ? originalLink.target.id : originalLink.target;
            const originalType = originalLink.type;

            try {
                // ä»æœ¬åœ°æ•°æ®ä¸­è·å–å…³ç³»ID
                let relationshipId = originalLink.id;
                console.log('æœ¬åœ°å…³ç³»ID:', relationshipId);
                
                if (!relationshipId) {
                    // å¦‚æœæœ¬åœ°æ•°æ®ä¸­æ²¡æœ‰IDï¼Œå°è¯•é€šè¿‡APIè·å–
                    console.log('æœ¬åœ°æ•°æ®ä¸­æ²¡æœ‰å…³ç³»IDï¼Œå°è¯•é€šè¿‡APIè·å–...');
                    const relationshipResponse = await fetch('/api/kg/data');
                    if (!relationshipResponse.ok) {
                        throw new Error(`Failed to fetch relationship data: ${relationshipResponse.status}`);
                    }
                    const relationshipData = await relationshipResponse.json();
                    
                    if (!relationshipData.data || !relationshipData.data.links) {
                        throw new Error('Invalid data structure: missing data.links');
                    }
                    
                    const relationshipToUpdate = relationshipData.data.links.find(link => 
                        link.source === originalSourceId && 
                        link.target === originalTargetId && 
                        link.type === originalType
                    );
                    
                    if (!relationshipToUpdate) {
                        throw new Error('Relationship not found in API data');
                    }
                    
                    relationshipId = relationshipToUpdate.id;
                    console.log('é€šè¿‡APIè·å–çš„å…³ç³»ID:', relationshipId);
                }
                
                // è°ƒç”¨åç«¯APIæ›´æ–°å…³ç³»
                const updateData = {
                    source: sourceId,
                    target: targetId,
                    type: type,
                    description: description
                };
                
                console.log('å‘é€æ›´æ–°æ•°æ®:', updateData);
                console.log('API URL:', `/api/kg/relationships/${relationshipId}`);
                
                const response = await fetch(`/api/kg/relationships/${relationshipId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });

                console.log('APIå“åº”çŠ¶æ€:', response.status);
                console.log('APIå“åº”å¤´:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
                }

                const result = await response.json();
                console.log('APIå“åº”ç»“æœ:', result);
                
                if (result.success || result.ret === 0) {
                    // æ›´æ–°æœ¬åœ°æ•°æ®ï¼Œä¿ç•™å…³ç³»ID
                    graphData.links[linkIndex] = {
                        source: sourceId,
                        target: targetId,
                        type: type,
                        description: description,  // æ·»åŠ å…³ç³»æè¿°
                        edgeType: edgeType,  // æ·»åŠ è¾¹ç±»å‹
                        id: relationshipId,  // ä¿ç•™å…³ç³»ID
                        domain: originalLink.domain || 'default'  // ä¿ç•™é¢†åŸŸä¿¡æ¯
                    };

                    // å±€éƒ¨æ›´æ–°æ•°æ®
                    updateGraphDataLocally();

            alert('å…³ç³»æ›´æ–°æˆåŠŸ');

            // é‡æ–°æ˜¾ç¤ºæ›´æ–°åçš„å…³ç³»è¯¦æƒ…
            showRelationDetail(graphData.links[linkIndex]);
                    
                    // é‡ç½®ç¼–è¾‘çŠ¶æ€
                    editingLinkIndex = -1;

                    // å»¶è¿Ÿä¸€ä¸‹ç­‰å¾…å›¾è¡¨é‡æ–°æ¸²æŸ“å®Œæˆåå±…ä¸­å±•ç¤ºæ›´æ–°åçš„å…³ç³»
                    setTimeout(() => {
                        centerOnRelation(sourceId, targetId, type);
                    }, 100);
                } else {
                    alert('å…³ç³»æ›´æ–°å¤±è´¥: ' + (result.message || result.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ›´æ–°å…³ç³»å¤±è´¥:', error);
                alert('å…³ç³»æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        // å–æ¶ˆå…³ç³»ç¼–è¾‘
        function cancelRelationEdit() {
            // é‡ç½®ç¼–è¾‘çŠ¶æ€
            editingLinkIndex = -1;
            
            // æ¸…ç©ºå…³ç³»è¡¨å•
            clearRelationForm();
            
            // å¦‚æœä¹‹å‰æœ‰é€‰ä¸­çš„å…³ç³»ï¼Œé‡æ–°æ˜¾ç¤ºå…¶è¯¦æƒ…
            if (selectedLink) {
                showRelationDetail(selectedLink);
            } else {
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
            }
            
            console.log('å…³ç³»ç¼–è¾‘å·²å–æ¶ˆ');
        }

        // æ˜¾ç¤ºå®ä½“ç¼–è¾‘é¡µé¢
        function showEntityEditPage(entity) {
            detailView.innerHTML = `
                <div class="detail-header">ç¼–è¾‘å®ä½“</div>
                <div class="entity-edit-form">
                    <div class="form-group">
                        <label for="edit-entity-id">å®ä½“ID</label>
                        <input type="text" id="edit-entity-id" value="${entity.id}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-entity-name">å®ä½“åç§°</label>
                        <input type="text" id="edit-entity-name" value="${entity.name}" placeholder="è¾“å…¥å®ä½“åç§°">
                    </div>
                    <div class="form-group">
                        <label for="edit-entity-domain">å›¾è°±é¢†åŸŸ</label>
                        <select id="edit-entity-domain">
                            <option value="default" ${entity.domain === 'default' ? 'selected' : ''}>é»˜è®¤é¢†åŸŸ</option>
                            <option value="technology" ${entity.domain === 'technology' ? 'selected' : ''}>æŠ€æœ¯é¢†åŸŸ</option>
                            <option value="medicine" ${entity.domain === 'medicine' ? 'selected' : ''}>åŒ»å­¦é¢†åŸŸ</option>
                            <option value="finance" ${entity.domain === 'finance' ? 'selected' : ''}>é‡‘èé¢†åŸŸ</option>
                            <option value="education" ${entity.domain === 'education' ? 'selected' : ''}>æ•™è‚²é¢†åŸŸ</option>
                            <option value="culture" ${entity.domain === 'culture' ? 'selected' : ''}>æ–‡åŒ–é¢†åŸŸ</option>
                            <option value="custom" ${!['default', 'technology', 'medicine', 'finance', 'education', 'culture'].includes(entity.domain) ? 'selected' : ''}>è‡ªå®šä¹‰é¢†åŸŸ</option>
                        </select>
                        <input type="text" id="edit-custom-domain" placeholder="è¾“å…¥è‡ªå®šä¹‰é¢†åŸŸåç§°" style="display: none; margin-top: 5px; width: 100%;" value="${!['default', 'technology', 'medicine', 'finance', 'education', 'culture'].includes(entity.domain) ? entity.domain : ''}">
                    </div>
                    <div class="form-group">
                        <label for="edit-entity-desc">å®ä½“æè¿°</label>
                        <textarea id="edit-entity-desc" rows="3" placeholder="è¾“å…¥å®ä½“æè¿°">${entity.description || ''}</textarea>
                    </div>
                    <div class="btn-group">
                        <button id="save-entity-edit" class="btn-primary" onclick="saveEntityEdit()">æ›´æ–°å®ä½“</button>
                        <button class="btn-secondary" onclick="cancelEntityEdit()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;

            // åˆå§‹åŒ–ç¼–è¾‘è¡¨å•äº‹ä»¶
            initEntityEditForm();
        }

        // åˆå§‹åŒ–å®ä½“ç¼–è¾‘è¡¨å•
        function initEntityEditForm() {
            const editEntityDomain = document.getElementById('edit-entity-domain');
            const editCustomDomain = document.getElementById('edit-custom-domain');

            // é¢†åŸŸé€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
            editEntityDomain.addEventListener('change', function() {
                if (this.value === 'custom') {
                    editCustomDomain.style.display = 'block';
                    editCustomDomain.focus();
                } else {
                    editCustomDomain.style.display = 'none';
                    editCustomDomain.value = '';
                }
            });

            // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è‡ªå®šä¹‰é¢†åŸŸï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡†
            if (editEntityDomain.value === 'custom') {
                editCustomDomain.style.display = 'block';
            }
        }

        // ä¿å­˜å®ä½“ç¼–è¾‘
        async function saveEntityEdit() {
            if (!editingEntityId) return;

            const entity = graphData.nodes.find(n => n.id === editingEntityId);
            if (!entity) {
                alert('å®ä½“ä¸å­˜åœ¨');
                cancelEntityEdit();
                return;
            }

            const name = document.getElementById('edit-entity-name').value.trim();
            const description = document.getElementById('edit-entity-desc').value.trim();
            
            // è·å–é¢†åŸŸä¿¡æ¯
            let domain = document.getElementById('edit-entity-domain').value;
            if (domain === 'custom') {
                domain = document.getElementById('edit-custom-domain').value.trim();
                if (!domain) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰é¢†åŸŸåç§°');
                    return;
                }
            }

            if (!name) {
                alert('å®ä½“åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            const updateData = { name, domain };
            if (description) {
                updateData.description = description;
            }

            // è°ƒç”¨åç«¯APIæ›´æ–°å®ä½“
            const success = await updateEntityAPI(editingEntityId, updateData);
            if (success) {
                // æ›´æ–°æœ¬åœ°æ•°æ®
                Object.assign(entity, updateData);
                
                // å±€éƒ¨æ›´æ–°æ•°æ®
                updateGraphDataLocally();
                
                // æ›´æ–°è¯¦æƒ…è§†å›¾
                const updatedEntity = graphData.nodes.find(n => n.id === editingEntityId);
                if (updatedEntity) {
                    // ä¿å­˜å®ä½“IDç”¨äºå±…ä¸­å±•ç¤º
                    const entityIdToCenter = editingEntityId;
                    
                    // é‡ç½®ç¼–è¾‘çŠ¶æ€å¹¶æ˜¾ç¤ºè¯¦æƒ…é¡µ
                    editingEntityId = null;
                    showEntityDetail(updatedEntity);
                    
                    // ç­‰å¾…D3.js simulationç¨³å®šåå±…ä¸­æ”¾å¤§å±•ç¤ºæ›´æ–°åçš„å®ä½“
                    const waitForSimulation = () => {
                        if (simulation && simulation.alpha() > 0.01) {
                            // simulationè¿˜åœ¨è¿è¡Œï¼Œç»§ç»­ç­‰å¾…
                            setTimeout(waitForSimulation, 50);
                        } else {
                            // simulationå·²ç¨³å®šï¼Œæ‰§è¡Œå±…ä¸­æ”¾å¤§
                            setTimeout(() => {
                                // æ¸…é™¤æ‰€æœ‰é«˜äº®
                                clearAllHighlights();
                                
                                // é«˜äº®æ›´æ–°åçš„å®ä½“
                                const updatedNodeGroup = d3.selectAll('.node').filter(d => d.id === entityIdToCenter);
                                if (!updatedNodeGroup.empty()) {
                                    updatedNodeGroup.classed('highlighted', true);
                                }
                                
                                // å±…ä¸­æ”¾å¤§æ˜¾ç¤º
                                centerNodeInView(entityIdToCenter);
                            }, 100);
                        }
                    };
                    waitForSimulation();
                }

                alert('å®ä½“æ›´æ–°æˆåŠŸ');
                
                // å°†æ›´æ–°åçš„å®ä½“åå¡«å……åˆ°æœç´¢æ¡†
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = name;
                }
            } else {
                alert('å®ä½“æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å–æ¶ˆå®ä½“ç¼–è¾‘
        function cancelEntityEdit() {
            // é‡ç½®ç¼–è¾‘çŠ¶æ€
            editingEntityId = null;
            
            // å¦‚æœä¹‹å‰æœ‰é€‰ä¸­çš„å®ä½“ï¼Œé‡æ–°æ˜¾ç¤ºå…¶è¯¦æƒ…
            if (selectedNode) {
                showEntityDetail(selectedNode);
            } else {
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
            }
            
            console.log('å®ä½“ç¼–è¾‘å·²å–æ¶ˆ');
        }

        // æœç´¢å»ºè®®åŠŸèƒ½
        function handleSearchInput(e) {
            const keyword = e.target.value.trim();
            
            if (searchTimer) {
                clearTimeout(searchTimer);
            }
            
            searchTimer = setTimeout(() => {
                if (keyword.length > 0) {
                    generateSearchSuggestions(keyword);
                } else {
                    hideSearchSuggestions();
                }
            }, 300);
        }

        function generateSearchSuggestions(keyword) {
            const searchType = searchTypeSelect.value;
            const suggestions = [];
            
            if (searchType === 'entityName') {
                // æœç´¢å®ä½“åç§°
                graphData.nodes.forEach(node => {
                    const name = node.name ? node.name.toLowerCase() : '';
                    if (name.includes(keyword.toLowerCase())) {
                        suggestions.push({
                            text: node.name,
                            displayText: node.name,
                            type: 'entity',
                            data: node
                        });
                    }
                });
            } else if (searchType === 'entityId') {
                // æœç´¢å®ä½“ID
                graphData.nodes.forEach(node => {
                    const id = node.id ? node.id.toLowerCase() : '';
                    if (id.includes(keyword.toLowerCase())) {
                        suggestions.push({
                            text: node.id, // é€‰æ‹©åå¡«å…¥ID
                            displayText: node.name || node.id, // æ˜¾ç¤ºå®ä½“åç§°
                            type: 'entity',
                            data: node
                        });
                    }
                });
            } else if (searchType === 'entityDesc') {
                // æœç´¢å®ä½“æè¿°ï¼Œä½†æ˜¾ç¤ºå®ä½“åç§°
                graphData.nodes.forEach(node => {
                    const desc = node.description ? node.description.toLowerCase() : '';
                    if (desc.includes(keyword.toLowerCase())) {
                        suggestions.push({
                            text: node.name, // é€‰æ‹©åå¡«å…¥å®ä½“åç§°
                            displayText: node.name,
                            type: 'description',
                            data: node
                        });
                    }
                });
            } else if (searchType === 'relation') {
                // æœç´¢å…³ç³»ç±»å‹
                const relationTypes = new Set();
                graphData.links.forEach(link => {
                    if (link.type && link.type.toLowerCase().includes(keyword.toLowerCase())) {
                        relationTypes.add(link.type);
                    }
                });
                
                relationTypes.forEach(type => {
                    suggestions.push({
                        text: type,
                        displayText: type,
                        type: 'relation',
                        data: { type: type }
                    });
                });
            }
            
            displaySearchSuggestions(suggestions.slice(0, 10)); // é™åˆ¶æ˜¾ç¤º10ä¸ªå»ºè®®
        }

        function displaySearchSuggestions(suggestions) {
            if (suggestions.length === 0) {
                hideSearchSuggestions();
                return;
            }
            
            searchSuggestionsEl.innerHTML = suggestions.map(suggestion => {
                const kw = searchInput.value;
                const highlightedText = highlightText(String(suggestion.displayText || ''), kw);
                let subtitle = '';
                if (suggestion.type === 'entity') {
                    const node = suggestion.data || {};
                    const idInfo = node.id ? `ID: ${node.id}` : '';
                    const domainInfo = node.domain ? `é¢†åŸŸ: ${node.domain}` : '';
                    subtitle = [idInfo, domainInfo].filter(Boolean).join(' Â· ');
                } else if (suggestion.type === 'description') {
                    const node = suggestion.data || {};
                    const desc = node.description ? (node.description.length > 50 ? node.description.substring(0, 50) + '...' : node.description) : '';
                    subtitle = `æè¿°: ${desc}`;
                } else {
                    subtitle = 'å…³ç³»ç±»å‹';
                }
                return `<div class=\"search-suggestion-item\" data-text=\"${String(suggestion.text || '').replace(/\"/g, '&quot;')}\">\
                    <div>${highlightedText}</div>\
                    <small style=\"color: #666;\">${subtitle}</small>\
                </div>`;
            }).join('');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            searchSuggestionsEl.querySelectorAll('.search-suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const text = item.getAttribute('data-text');
                    searchInput.value = text;
                    hideSearchSuggestions();
                    searchAndLocate();
                });
            });
            
            searchSuggestionsEl.style.display = 'block';
        }

        function highlightText(text, keyword) {
            if (!keyword) return text;
            const regex = new RegExp(`(${keyword})`, 'gi');
            return text.replace(regex, '<span class="search-suggestion-highlight">$1</span>');
        }

        function showSearchSuggestions() {
            if (searchInput.value.trim().length > 0) {
                generateSearchSuggestions(searchInput.value.trim());
            }
        }

        function hideSearchSuggestions() {
            searchSuggestionsEl.style.display = 'none';
        }

        // é‡ç½®æœç´¢çŠ¶æ€
        function resetSearchState() {
            searchResults = [];
            currentResultIndex = -1;
            lastSearchKeyword = '';
            lastSearchType = searchTypeSelect.value;
            searchResultsInfo.textContent = '';
        }

        // ------------------------------
        // æœç´¢ä¸è½®è¯¢æ˜¾ç¤ºåŠŸèƒ½ - æŒ‰ç±»å‹æœç´¢
        // ------------------------------
        function searchAndLocate() {
            const keyword = searchInput.value.trim().toLowerCase();
            const searchType = searchTypeSelect.value;

            if (!keyword) {
                resetSearchState();
                return;
            }

            const isNewSearch = keyword !== lastSearchKeyword || searchType !== lastSearchType;

            if (isNewSearch) {
                lastSearchKeyword = keyword;
                lastSearchType = searchType;
                searchResults = [];

                // æ ¹æ®é€‰æ‹©çš„æœç´¢ç±»å‹è¿›è¡Œæœç´¢
                switch(searchType) {
                    case 'entityId':
                        // æŒ‰å®ä½“IDæœç´¢ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
                        const idMatch = graphData.nodes.find(node => node.id === keyword);
                        if (idMatch) {
                            searchResults.push({
                                type: 'entity',
                                data: idMatch
                            });
                        }
                        break;

                    case 'entityName':
                        // æŒ‰å®ä½“åç§°æœç´¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        graphData.nodes.forEach(node => {
                            if (node.name.toLowerCase().includes(keyword)) {
                                searchResults.push({
                                    type: 'entity',
                                    data: node
                                });
                            }
                        });
                        break;

                    case 'entityDesc':
                        // æŒ‰å®ä½“æè¿°æœç´¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        graphData.nodes.forEach(node => {
                            if (node.description && node.description.toLowerCase().includes(keyword)) {
                                searchResults.push({
                                    type: 'entity',
                                    data: node
                                });
                            }
                        });
                        break;

                    case 'relation':
                        // æŒ‰å…³ç³»ç±»å‹æœç´¢ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        graphData.links.forEach(link => {
                            if (link.type.toLowerCase().includes(keyword)) {
                                searchResults.push({
                                    type: 'relation',
                                    data: link
                                });
                            }
                        });
                        break;
                }

                currentResultIndex = 0;
            } else {
                if (searchResults.length > 0) {
                    currentResultIndex = (currentResultIndex + 1) % searchResults.length;
                }
            }

            if (searchResults.length === 0) {
                const searchTypeName = document.querySelector(`#search-type option[value="${searchType}"]`).text;
                searchResultsInfo.textContent = `æœªæ‰¾åˆ°åŒ¹é…"${searchTypeName}"çš„ç»“æœ`;
                detailView.innerHTML = `<div class="no-data">æœªæ‰¾åˆ°åŒ¹é…"${searchTypeName}"çš„å®ä½“æˆ–å…³ç³»</div>`;
                clearAllHighlights();
                return;
            }

            const searchTypeName = document.querySelector(`#search-type option[value="${searchType}"]`).text;
            searchResultsInfo.textContent = `æ‰¾åˆ° ${searchResults.length} ä¸ªåŒ¹é…"${searchTypeName}"çš„ç»“æœï¼Œæ˜¾ç¤ºç¬¬ ${currentResultIndex + 1} ä¸ª`;

            const currentResult = searchResults[currentResultIndex];
            if (currentResult.type === 'entity') {
                const entity = currentResult.data;
                showEntityDetail(entity);
                centerNodeInView(entity.id);
                highlightSearchEntity(entity.id);
            } else if (currentResult.type === 'relation') {
                const link = currentResult.data;
                showRelationDetail(link);
                centerRelationInView(link);
                highlightSearchRelation(link);
            }
        }

        // ------------------------------
        // äº‹ä»¶ç›‘å¬ç»‘å®š
        // ------------------------------
        function setupEventListeners() {
            setupFileEventListeners();

            // é¢†åŸŸé€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
            entityDomainSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDomainInput.style.display = 'block';
                    customDomainInput.focus();
                } else {
                    customDomainInput.style.display = 'none';
                    customDomainInput.value = '';
                }
            });

            addEntityBtn.addEventListener('click', addEntity);
            updateEntityBtn.addEventListener('click', updateEntity);
            cancelEditBtn.addEventListener('click', cancelEdit);
            clearEntityFormBtn.addEventListener('click', () => {
                clearEntityForm();
                // é‡æ–°å¡«å……é»˜è®¤å€¼
                populateDefaultEntityValues();
            });

            addRelationBtn.addEventListener('click', addRelation);
            clearRelationFormBtn.addEventListener('click', clearRelationForm);

            // æ¸…ç©ºæ‰€æœ‰æ•°æ®æŒ‰é’®äº‹ä»¶
            const clearAllDataBtn = document.getElementById('clear-all-data');
            if (clearAllDataBtn) {
                clearAllDataBtn.addEventListener('click', clearAllData);
            }

            searchBtn.addEventListener('click', searchAndLocate);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    hideSearchSuggestions();
                    searchAndLocate();
                }
            });
            
            // æœç´¢å»ºè®®åŠŸèƒ½
            searchInput.addEventListener('input', handleSearchInput);
            searchInput.addEventListener('focus', showSearchSuggestions);
            searchInput.addEventListener('blur', (e) => {
                // å»¶è¿Ÿéšè—ï¼Œè®©ç‚¹å‡»äº‹ä»¶å…ˆè§¦å‘
                setTimeout(() => hideSearchSuggestions(), 200);
            });
            // åˆ‡æ¢æœç´¢ç±»å‹æ—¶ï¼Œä¾æ®å½“å‰è¾“å…¥å³æ—¶åˆ·æ–°ä¸‹æ‹‰
            searchTypeSelect.addEventListener('change', () => {
                const kw = searchInput.value.trim();
                if (kw) {
                    generateSearchSuggestions(kw);
                } else {
                    hideSearchSuggestions();
                }
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢å»ºè®®
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchSuggestionsEl.contains(e.target)) {
                    hideSearchSuggestions();
                }
            });
            
            // æ‚¬æµ®çª—å£é¼ æ ‡äº‹ä»¶
            const tooltip = document.getElementById('entity-tooltip');
            
            if (tooltip) {
                tooltip.addEventListener('mouseenter', function() {
                    // é¼ æ ‡è¿›å…¥tooltipæ—¶ä¿æŒæ˜¾ç¤º
                    this.classList.add('visible');
                });
                
                tooltip.addEventListener('mouseleave', function() {
                    // é¼ æ ‡ç¦»å¼€tooltipæ—¶éšè—
                    this.classList.remove('visible');
                });
            }

            // å®ä½“å³é”®èœå•äº‹ä»¶ç›‘å¬å™¨
            const editEntityMenu = document.getElementById('edit-entity-menu');
            const deleteEntityMenu = document.getElementById('delete-entity-menu');
            const copyEntityMenu = document.getElementById('copy-entity-menu');

            if (editEntityMenu) {
                editEntityMenu.addEventListener('click', () => {
                    hideContextMenu();
                    editEntityFromContext();
                });
            }

            if (deleteEntityMenu) {
                deleteEntityMenu.addEventListener('click', () => {
                    hideContextMenu();
                    deleteEntityFromContext();
                });
            }

            if (copyEntityMenu) {
                copyEntityMenu.addEventListener('click', () => {
                    hideContextMenu();
                    copyEntityFromContext();
                });
            }

            // å¤åˆ¶5ä¸ªå®ä½“èœå•äº‹ä»¶ç›‘å¬å™¨
            const copy5EntitiesMenu = document.getElementById('copy-5-entities-menu');
            if (copy5EntitiesMenu) {
                copy5EntitiesMenu.addEventListener('click', () => {
                    hideContextMenu();
                    copy5EntitiesFromContext();
                });
            }

            // æ–°å¢å…³ç³»èœå•äº‹ä»¶ç›‘å¬å™¨
            const addRelationMenu = document.getElementById('add-relation-menu');
            if (addRelationMenu) {
                addRelationMenu.addEventListener('click', () => {
                    hideContextMenu();
                    addRelationFromContext();
                });
            }

            // å…³ç³»å³é”®èœå•äº‹ä»¶ç›‘å¬å™¨
            const editRelationMenu = document.getElementById('edit-relation-menu');
            const deleteRelationMenu = document.getElementById('delete-relation-menu');

            if (editRelationMenu) {
                editRelationMenu.addEventListener('click', () => {
                    hideRelationContextMenu();
                    editRelationFromContext();
                });
            }

            if (deleteRelationMenu) {
                deleteRelationMenu.addEventListener('click', () => {
                    hideRelationContextMenu();
                    deleteRelationFromContext();
                });
            }

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å³é”®èœå•
            document.addEventListener('click', (event) => {
                const contextMenu = document.getElementById('context-menu');
                const relationContextMenu = document.getElementById('relation-context-menu');
                
                if (contextMenu && !contextMenu.contains(event.target)) {
                    hideContextMenu();
                }
                
                if (relationContextMenu && !relationContextMenu.contains(event.target)) {
                    hideRelationContextMenu();
                }
            });

            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            fitViewBtn.addEventListener('click', fitView);
            resetViewBtn.addEventListener('click', resetLayout);

            // æºå®ä½“é€‰æ‹©æ¡†äº‹ä»¶
            sourceEntityDisplay.addEventListener('focus', () => {
                sourceEntityDropdown.classList.add('visible');
                sourceEntityDropdown.classList.add('visible');
            });

            sourceEntityDisplay.addEventListener('input', () => {
                const filtered = filterEntities(sourceEntityDisplay.value);
                updateEntityDropdown(sourceEntityDropdown, filtered);
                sourceEntityDropdown.classList.add('visible');
            });

            // ç›®æ ‡å®ä½“é€‰æ‹©æ¡†äº‹ä»¶
            targetEntityDisplay.addEventListener('focus', () => {
                targetEntityDropdown.classList.add('visible');
            });

            targetEntityDisplay.addEventListener('input', () => {
                const filtered = filterEntities(targetEntityDisplay.value);
                updateEntityDropdown(targetEntityDropdown, filtered);
                targetEntityDropdown.classList.add('visible');
            });

            // å…³ç³»ç±»å‹é€‰æ‹©æ¡†äº‹ä»¶
            relationTypeDisplay.addEventListener('focus', () => {
                relationTypeDropdown.classList.add('visible');
            });

            relationTypeDisplay.addEventListener('input', () => {
                const inputValue = relationTypeDisplay.value.trim();
                const filtered = filterRelationTypes(inputValue);
                // æ›´æ–°å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
                relationTypeDropdown.innerHTML = '';

                // 1. è‹¥è¾“å…¥ä¸ä¸ºç©ºï¼Œæ·»åŠ "è‡ªå®šä¹‰è¾“å…¥"é€‰é¡¹
                if (inputValue && !filtered.includes(inputValue)) {
                    const customItem = document.createElement('div');
                    customItem.className = 'dropdown-item';
                    customItem.textContent = `è‡ªå®šä¹‰: ${inputValue}`;
                    customItem.dataset.type = inputValue;
                    customItem.style.color = '#2e7d32'; // é«˜äº®è‡ªå®šä¹‰é€‰é¡¹

                    customItem.addEventListener('click', () => {
                        relationTypeInput.value = inputValue;
                        relationTypeDisplay.value = inputValue;
                        relationTypeDropdown.classList.remove('visible');
                    });

                    relationTypeDropdown.appendChild(customItem);
                }

                // 2. æ·»åŠ è¿‡æ»¤åçš„ç°æœ‰å…³ç³»ç±»å‹
                if (filtered.length === 0 && !inputValue) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'dropdown-item';
                    emptyItem.textContent = 'æ— åŒ¹é…çš„å…³ç³»ç±»å‹';
                    emptyItem.style.cursor = 'default';
                    emptyItem.style.opacity = '0.7';
                    relationTypeDropdown.appendChild(emptyItem);
                } else {
                    filtered.forEach(type => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = type;
                        item.dataset.type = type;

                        item.addEventListener('click', () => {
                            relationTypeInput.value = type;
                            relationTypeDisplay.value = type;
                            relationTypeDropdown.classList.remove('visible');
                        });

                        relationTypeDropdown.appendChild(item);
                    });
                }
                relationTypeDropdown.classList.add('visible');
            });

            // 3. å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜è‡ªå®šä¹‰è¾“å…¥ï¼ˆè‹¥æœªé€‰æ‹©ä¸‹æ‹‰é¡¹ï¼‰
            relationTypeDisplay.addEventListener('blur', () => {
                const inputValue = relationTypeDisplay.value.trim();
                if (inputValue) {
                    // ç›´æ¥å°†è¾“å…¥å€¼è®¾ä¸ºå…³ç³»ç±»å‹ï¼ˆæ— éœ€ä¾èµ–ä¸‹æ‹‰æ¡†é€‰æ‹©ï¼‰
                    relationTypeInput.value = inputValue;
                    // å…³é—­ä¸‹æ‹‰æ¡†
                    setTimeout(() => {
                        relationTypeDropdown.classList.remove('visible');
                    }, 200);
                }
            });

            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.entity-select-container') &&
                    !event.target.closest('.relation-type-select-container')) {
                    sourceEntityDropdown.classList.remove('visible');
                    targetEntityDropdown.classList.remove('visible');
                    relationTypeDropdown.classList.remove('visible');

                    // å…³é—­ç¼–è¾‘å…³ç³»æ—¶çš„ä¸‹æ‹‰æ¡†
                    const editSourceDropdown = document.getElementById('edit-source-entity-dropdown');
                    const editTargetDropdown = document.getElementById('edit-target-entity-dropdown');
                    const editRelationTypeDropdown = document.getElementById('edit-relation-type-dropdown');

                    if (editSourceDropdown) editSourceDropdown.classList.remove('visible');
                    if (editTargetDropdown) editTargetDropdown.classList.remove('visible');
                    if (editRelationTypeDropdown) editRelationTypeDropdown.classList.remove('visible');
                }
            });

            // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å›¾è°±
            window.addEventListener('resize', () => {
                if (graphData.nodes.length > 0) {
                    reloadGraph();
                    fitView();
                }
            });
            
            // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»ä»»ä½•åœ°æ–¹éƒ½éšè—æ‚¬æµ®çª—å£
            document.addEventListener('click', function(event) {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å®ä½“èŠ‚ç‚¹å’Œæ‚¬æµ®çª—å£æœ¬èº«ï¼Œéšè—æ‚¬æµ®çª—å£
                if (!event.target.closest('.nodes circle') && !event.target.closest('.entity-tooltip')) {
                    hideTooltip();
                    tooltipShouldShow = false;
                }
            });
        }

        // å…¨å±€å‡½æ•°ï¼Œç”¨äºå…³ç³»ç¼–è¾‘æ“ä½œ
        window.startEditRelation = startEditRelation;
        window.deleteRelation = deleteRelation;
        window.startEditEntity = startEditEntity;
        window.deleteEntity = deleteEntity;
        window.showEntityDetail = showEntityDetail;
        window.saveRelationEdit = saveRelationEdit;
        window.cancelRelationEdit = cancelRelationEdit;
        window.saveEntityEdit = saveEntityEdit;
        window.cancelEntityEdit = cancelEntityEdit;
        window.toggleDescription = toggleDescription;
        window.copyDescription = copyDescription;
        window.copyEntityWithRelation = copyEntityWithRelation;

        // AIèŠå¤©æœºå™¨äººåŠŸèƒ½
        let aiChatOpen = false;

        // åˆ‡æ¢AIèŠå¤©çª—å£
        function toggleAIChat() {
            const chatWindow = document.getElementById('aiChatWindow');
            aiChatOpen = !aiChatOpen;
            
            if (aiChatOpen) {
                chatWindow.style.display = 'flex';
                document.getElementById('aiInputField').focus();
            } else {
                chatWindow.style.display = 'none';
            }
        }

        // å¤„ç†AIè¾“å…¥æ¡†å›è½¦é”®
        function handleAIKeyPress(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        // å‘é€AIæ¶ˆæ¯
        async function sendAIMessage() {
            const inputField = document.getElementById('aiInputField');
            const sendBtn = document.getElementById('aiSendBtn');
            const message = inputField.value.trim();
            
            if (!message) return;

            // ç¦ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
            inputField.disabled = true;
            sendBtn.disabled = true;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addAIMessage(message, 'user');
            inputField.value = '';

            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
            showAITyping();

            try {
                // è°ƒç”¨AIé—®ç­”API
                const response = await getAIResponse(message);
                hideAITyping();
                addAIMessage(response, 'bot');
            } catch (error) {
                hideAITyping();
                addAIMessage('æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚', 'bot');
                console.error('AIå“åº”é”™è¯¯:', error);
            }

            // é‡æ–°å¯ç”¨è¾“å…¥å’Œå‘é€æŒ‰é’®
            inputField.disabled = false;
            sendBtn.disabled = false;
            inputField.focus();
        }

        // æ·»åŠ AIæ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addAIMessage(content, sender) {
            const messagesContainer = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'ai-message-avatar';
            
            if (sender === 'user') {
                avatar.textContent = 'æˆ‘';
            } else {
                // ä¸ºAIæ¶ˆæ¯åˆ›å»ºå²åŠªæ¯”å¤´åƒ
                avatar.innerHTML = `
                    <div class="snoopy-avatar">
                        <div class="snoopy-head"></div>
                        <div class="snoopy-ears">
                            <div class="ear left-ear"></div>
                            <div class="ear right-ear"></div>
                        </div>
                        <div class="snoopy-eyes">
                            <div class="eye left-eye"></div>
                            <div class="eye right-eye"></div>
                        </div>
                        <div class="snoopy-nose"></div>
                    </div>
                `;
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'ai-message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
        function showAITyping() {
            document.getElementById('aiTyping').style.display = 'block';
            const messagesContainer = document.getElementById('aiChatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // éšè—AIæ­£åœ¨è¾“å…¥
        function hideAITyping() {
            document.getElementById('aiTyping').style.display = 'none';
        }

        // è·å–AIå“åº”
        async function getAIResponse(userMessage) {
            try {
                // è·å–AIå¼€å…³çŠ¶æ€
                const useExternalAI = document.getElementById('aiSwitch').classList.contains('active');
                
                // å‡†å¤‡ä¸Šä¸‹æ–‡æ•°æ®
                const contextData = {
                    message: userMessage,
                    graphData: {
                        nodes: graphData.nodes || [],
                        links: graphData.links || []
                    },
                    currentDomain: currentDomain,
                    selectedNode: selectedNode,
                    selectedLink: selectedLink,
                    useExternalAI: useExternalAI  // æ·»åŠ AIå¼€å…³çŠ¶æ€
                };

                // è°ƒç”¨åç«¯AIé—®ç­”API
                const response = await fetch('/api/kg/ai-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(contextData)
                });

                if (!response.ok) {
                    throw new Error('AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨');
                }

                const result = await response.json();
                return result.response || 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ç†è§£æ‚¨çš„é—®é¢˜ã€‚';
            } catch (error) {
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°æ™ºèƒ½å›å¤
                return generateLocalAIResponse(userMessage);
            }
        }

        // AIå¼€å…³åˆ‡æ¢å‡½æ•°
        function toggleAISwitch() {
            const aiSwitch = document.getElementById('aiSwitch');
            const aiSwitchText = document.getElementById('aiSwitchText');
            
            if (aiSwitch.classList.contains('active')) {
                // åˆ‡æ¢åˆ°æœ¬åœ°AI
                aiSwitch.classList.remove('active');
                aiSwitchText.textContent = 'æœ¬åœ°';
                aiSwitchText.style.color = 'white';
            } else {
                // åˆ‡æ¢åˆ°å¤–éƒ¨AI
                aiSwitch.classList.add('active');
                aiSwitchText.textContent = 'å¤–éƒ¨';
                aiSwitchText.style.color = 'white';
            }
        }

        // æœ¬åœ°æ™ºèƒ½å›å¤ï¼ˆå½“åç«¯AIæœåŠ¡ä¸å¯ç”¨æ—¶ï¼‰
        function generateLocalAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            // æ¨¡ç³Šæœç´¢å®ä½“
            function fuzzySearchEntities(query) {
                const results = [];
                const queryLower = query.toLowerCase();
                for (const node of graphData.nodes) {
                    const nodeName = node.name.toLowerCase();
                    const nodeId = node.id.toLowerCase();
                    const nodeDesc = (node.description || '').toLowerCase();
                    
                    if (queryLower.includes(nodeName) || 
                        queryLower.includes(nodeId) || 
                        queryLower.includes(nodeDesc)) {
                        results.push(node);
                    }
                }
                return results;
            }
            
            // å®ä½“ç›¸å…³æŸ¥è¯¢
            if (message.includes('å®ä½“') || message.includes('èŠ‚ç‚¹') || message.includes('ä»€ä¹ˆ') || message.includes('å“ªäº›') || message.includes('è°') || message.includes('å“ªé‡Œ')) {
                // æ¨¡ç³Šæœç´¢
                const searchResults = fuzzySearchEntities(message);
                if (searchResults.length > 0) {
                    if (searchResults.length === 1) {
                        const node = searchResults[0];
                        const relatedLinks = graphData.links.filter(l => 
                            (typeof l.source === 'object' ? l.source.id : l.source) === node.id ||
                            (typeof l.target === 'object' ? l.target.id : l.target) === node.id
                        );
                        return `æˆ‘æ‰¾åˆ°äº†å®ä½“ï¼š${node.name}ï¼ˆ${node.domain || 'default'}é¢†åŸŸï¼‰ï¼Œæœ‰ ${relatedLinks.length} ä¸ªç›¸å…³å…³ç³»ã€‚`;
                    } else {
                        const names = searchResults.slice(0, 5).map(n => n.name);
                        return `æˆ‘æ‰¾åˆ°äº†${searchResults.length}ä¸ªç›¸å…³å®ä½“ï¼š${names.join('ã€')}`;
                    }
                }
                
                if (message.includes('æ•°é‡') || message.includes('å¤šå°‘ä¸ª')) {
                    return `å½“å‰çŸ¥è¯†å›¾è°±ä¸­å…±æœ‰ ${graphData.nodes.length} ä¸ªå®ä½“ã€‚`;
                }
                if (message.includes('åˆ—è¡¨') || message.includes('æ‰€æœ‰')) {
                    const entityNames = graphData.nodes.map(n => n.name).join('ã€');
                    return `æ‰€æœ‰å®ä½“åŒ…æ‹¬ï¼š${entityNames}`;
                }
                if (message.includes('é¢†åŸŸ') || message.includes('domain')) {
                    const domains = [...new Set(graphData.nodes.map(n => n.domain || 'default'))];
                    return `å›¾è°±ä¸­çš„é¢†åŸŸåŒ…æ‹¬ï¼š${domains.join('ã€')}`;
                }
            }
            
            // å…³ç³»ç›¸å…³æŸ¥è¯¢
            if (message.includes('å…³ç³»') || message.includes('è¿æ¥') || message.includes('link') || message.includes('å…³è”')) {
                if (message.includes('æ•°é‡') || message.includes('å¤šå°‘ä¸ª')) {
                    return `å½“å‰çŸ¥è¯†å›¾è°±ä¸­å…±æœ‰ ${graphData.links.length} ä¸ªå…³ç³»ã€‚`;
                }
                if (message.includes('ç±»å‹') || message.includes('å…³ç³»ç±»å‹')) {
                    const relationTypes = [...new Set(graphData.links.map(l => l.type))];
                    return `å…³ç³»ç±»å‹åŒ…æ‹¬ï¼š${relationTypes.join('ã€')}`;
                }
            }
            
            // ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢
            if (message.includes('ç»Ÿè®¡') || message.includes('æ€»ç»“') || message.includes('æ¦‚å†µ')) {
                const domains = [...new Set(graphData.nodes.map(n => n.domain || 'default'))];
                const relationTypes = [...new Set(graphData.links.map(l => l.type))];
                return `çŸ¥è¯†å›¾è°±ç»Ÿè®¡ï¼šå…±æœ‰ ${graphData.nodes.length} ä¸ªå®ä½“ï¼Œ${graphData.links.length} ä¸ªå…³ç³»ï¼Œæ¶‰åŠ ${domains.length} ä¸ªé¢†åŸŸï¼Œ${relationTypes.length} ç§å…³ç³»ç±»å‹ã€‚`;
            }
            
            // å¸®åŠ©ä¿¡æ¯
            if (message.includes('å¸®åŠ©') || message.includes('help') || message.includes('èƒ½åšä»€ä¹ˆ')) {
                return `æˆ‘æ˜¯å²åŠªæ¯”AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨ï¼š

1. æŸ¥è¯¢å®ä½“ä¿¡æ¯ï¼šè¯¢é—®ç‰¹å®šå®ä½“ã€å®ä½“æ•°é‡ã€åˆ—è¡¨ç­‰
2. æŸ¥è¯¢å…³ç³»ä¿¡æ¯ï¼šè¯¢é—®å…³ç³»ç±»å‹ã€è¿æ¥æƒ…å†µç­‰
3. æ¨¡ç³Šæœç´¢ï¼šå³ä½¿ä¸çŸ¥é“ç¡®åˆ‡åç§°ä¹Ÿèƒ½æ‰¾åˆ°ç›¸å…³å®ä½“
4. ç»Ÿè®¡åˆ†æï¼šå›¾è°±æ•´ä½“æ¦‚å†µå’Œç»Ÿè®¡ä¿¡æ¯
5. æ™ºèƒ½é—®ç­”ï¼šåŸºäºçŸ¥è¯†å›¾è°±æ•°æ®å›ç­”å„ç§é—®é¢˜

è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ`;
            }
            
            // é€šç”¨å›å¤
            return "æˆ‘ç†è§£æ‚¨çš„é—®é¢˜ï¼Œè®©æˆ‘ä¸ºæ‚¨æœç´¢ç›¸å…³ä¿¡æ¯ã€‚æ‚¨å¯ä»¥è¯¢é—®å®ä½“ã€å…³ç³»ã€ç»Ÿè®¡ä¿¡æ¯ï¼Œæˆ–è€…ç›´æ¥æè¿°æ‚¨æƒ³äº†è§£çš„å†…å®¹ï¼Œæˆ‘ä¼šå°½åŠ›å¸®æ‚¨æ‰¾åˆ°ç­”æ¡ˆã€‚";
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllData() {
            // ç¡®è®¤å¯¹è¯æ¡†
            const confirmMessage = `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\n1. è‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®ä¸ºJSONæ–‡ä»¶\n2. åˆ é™¤MySQLæ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®\n3. æ¸…ç©ºç•Œé¢æ˜¾ç¤º\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const clearButton = document.getElementById('clear-all-data');
                if (clearButton) {
                    const originalText = clearButton.textContent;
                    clearButton.textContent = 'æ¸…ç©ºä¸­...';
                    clearButton.disabled = true;
                }
                
                // 1. è‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®
                const backupData = {
                    nodes: graphData.nodes.map(node => ({
                        id: node.id,
                        name: node.name,
                        description: node.description || '',
                        domain: node.domain || 'default'
                    })),
                    links: graphData.links.map(link => ({
                        source: typeof link.source === 'object' ? link.source.id : link.source,
                        target: typeof link.target === 'object' ? link.target.id : link.target,
                        type: link.type,
                        description: link.description || '',
                        domain: link.domain || 'default'
                    }))
                };
                
                // åˆ›å»ºå¹¶ä¸‹è½½å¤‡ä»½æ–‡ä»¶
                const backupBlob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const backupUrl = URL.createObjectURL(backupBlob);
                const backupLink = document.createElement('a');
                backupLink.href = backupUrl;
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const timestamp = `${year}${month}${day}_${hours}${minutes}${seconds}`;
                backupLink.download = `kg_${timestamp}_backup.json`;
                document.body.appendChild(backupLink);
                backupLink.click();
                document.body.removeChild(backupLink);
                URL.revokeObjectURL(backupUrl);
                
                console.log('æ•°æ®å¤‡ä»½å®Œæˆ');
                
                // 2. è°ƒç”¨åç«¯APIæ¸…ç©ºæ•°æ®
                const result = await clearAllDataAPI();
                
                if (result && (result.success || result.ret === 0)) {
                    // 3. æ¸…ç©ºæœ¬åœ°æ•°æ®
                    graphData = { nodes: [], links: [] };
                    allGraphData = { nodes: [], links: [] };
                    filteredGraphData = { nodes: [], links: [] };
                    
                    // 4. æ›´æ–°ç•Œé¢
                    updateGraphDataLocally();
                    
                    // 5. æ¸…ç©ºå®ä½“åˆ—è¡¨
                    renderEntityList();
                    
                    // 6. æ¸…ç©ºæœç´¢çŠ¶æ€
                    searchResults = [];
                    currentResultIndex = -1;
                    lastSearchKeyword = '';
                    lastSearchType = 'entityName';
                    
                    // 7. æ¸…ç©ºé€‰ä¸­çŠ¶æ€
                    selectedNode = null;
                    selectedLink = null;
                    editingEntityId = null;
                    editingLinkIndex = -1;
                    
                    // 8. é‡ç½®é¢†åŸŸé€‰æ‹©
                    currentDomain = 'all';
                    const domainSelect = document.getElementById('domain-select');
                    if (domainSelect) {
                        domainSelect.value = 'all';
                    }
                    
                    // 9. æ¸…ç©ºå³ä¾§è¯¦æƒ…é¢æ¿
                    const detailPanel = document.getElementById('entity-detail-panel');
                    if (detailPanel) {
                        detailPanel.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°entity-detail-panelï¼Œå°è¯•æ¸…ç©ºdetail-view
                        const detailView = document.getElementById('detail-view');
                        if (detailView) {
                            detailView.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
                        }
                    }
                    
                    // 10. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const successMessage = `æ•°æ®æ¸…ç©ºæˆåŠŸï¼\n\nå·²åˆ é™¤ï¼š\n- ${result.deleted_count.entities} ä¸ªå®ä½“\n- ${result.deleted_count.relationships} ä¸ªå…³ç³»\n\næ•°æ®å·²è‡ªåŠ¨å¤‡ä»½åˆ°æœ¬åœ°æ–‡ä»¶ã€‚`;
                    alert(successMessage);
                    
                } else {
                    throw new Error(result ? result.message : 'æ¸…ç©ºæ•°æ®å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                alert(`æ¸…ç©ºæ•°æ®å¤±è´¥ï¼š${error.message}\n\næ•°æ®å¤‡ä»½å·²å®Œæˆï¼Œä½†æ•°æ®åº“æ¸…ç©ºå¤±è´¥ã€‚`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const clearButton = document.getElementById('clear-all-data');
                if (clearButton) {
                    clearButton.textContent = 'ä¸€é”®æ¸…ç©ºæ•°æ®';
                    clearButton.disabled = false;
                }
            }
        }

        // åˆ·æ–°æ•°æ®ä»æ•°æ®åº“
        async function refreshDataFromDatabase() {
            console.log('refreshDataFromDatabaseå‡½æ•°è¢«è°ƒç”¨');
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const refreshButton = document.getElementById('refresh-data');
                if (refreshButton) {
                    const originalText = refreshButton.textContent;
                    refreshButton.textContent = 'åˆ·æ–°ä¸­...';
                    refreshButton.disabled = true;
                    refreshButton.style.cursor = 'not-allowed';
                    console.log('åˆ·æ–°æŒ‰é’®çŠ¶æ€å·²æ›´æ–°');
                } else {
                    console.error('åˆ·æ–°æŒ‰é’®æœªæ‰¾åˆ°');
                }
                
                console.log('å¼€å§‹ä»æ•°æ®åº“åˆ·æ–°æ•°æ®...');
                
                // è°ƒç”¨APIé‡æ–°åŠ è½½æ•°æ®
                const response = await fetch('/api/kg/data');
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯${response.status}`);
                }
                
                const result = await response.json();
                if (result.ret === 0) {
                    // æ›´æ–°å…¨å±€æ•°æ®
                    graphData = result.data;
                    
                    // å®Œå…¨æ¨¡æ‹ŸswitchToPreviewModeçš„é€»è¾‘
                    if (currentMode === 'preview') {
                        // é‡æ–°å¯ç”¨å³ä¾§é¢æ¿åŠŸèƒ½ï¼ˆè¿™ä¼šè°ƒç”¨resetDomainSelectorå’ŒfilterDataByDomainï¼‰
                        enableRightPanel();
                        
                        // é‡æ–°åˆå§‹åŒ–å›¾å½¢
                        if (graphData && graphData.nodes && graphData.nodes.length > 0) {
                            // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                            console.log('åˆ·æ–°æ•°æ®ï¼Œå½“å‰æ•°æ®:', graphData);
                            initializeGraph();
                            
                            // å»¶è¿Ÿæ‰§è¡Œé€‚é…æ˜¾ç¤ºï¼Œç¡®ä¿å›¾å½¢å·²å®Œå…¨æ¸²æŸ“
                            setTimeout(() => {
                                fitView();
                                console.log('åˆ·æ–°æ•°æ®ï¼šå·²æ‰§è¡Œé€‚é…æ˜¾ç¤º');
                            }, 500);
                        } else {
                            console.log('æ²¡æœ‰æ•°æ®ï¼Œé‡æ–°åŠ è½½...');
                            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé‡æ–°åŠ è½½
                            loadGraphData();
                        }
                    }
                    
                    // æ›´æ–°å®ä½“åˆ—è¡¨
                    renderEntityList();
                    
                    // æ›´æ–°å…³ç³»ç±»å‹ä¸‹æ‹‰æ¡†
                    updateRelationTypeDropdown();
                    
                    // æ›´æ–°å®ä½“é€‰æ‹©ä¸‹æ‹‰æ¡†
                    updateEntityDropdowns();
                    
                    console.log('æ•°æ®åˆ·æ–°æˆåŠŸ:', {
                        å®ä½“æ•°é‡: graphData.nodes.length,
                        å…³ç³»æ•°é‡: graphData.links.length
                    });
                    
                } else {
                    throw new Error(result.msg || 'æ•°æ®åŠ è½½å¤±è´¥');
                }
                
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const refreshButton = document.getElementById('refresh-data');
                if (refreshButton) {
                    refreshButton.textContent = 'ğŸ”„ åˆ·æ–°æ•°æ®';
                    refreshButton.disabled = false;
                    refreshButton.style.cursor = 'pointer';
                }
            }
        }

        // äº’æ¢æºå®ä½“å’Œç›®æ ‡å®ä½“
        function swapEntities() {
            console.log('å¼€å§‹äº’æ¢å®ä½“...');
            
            // è·å–å½“å‰ç¼–è¾‘ä¸­çš„æºå®ä½“å’Œç›®æ ‡å®ä½“å…ƒç´ 
            const sourceDisplay = document.getElementById('edit-source-entity-display');
            const sourceInput = document.getElementById('edit-source-entity');
            const targetDisplay = document.getElementById('edit-target-entity-display');
            const targetInput = document.getElementById('edit-target-entity');
            
            if (!sourceDisplay || !sourceInput || !targetDisplay || !targetInput) {
                console.error('æ‰¾ä¸åˆ°å®ä½“è¾“å…¥å…ƒç´ ');
                return;
            }
            
            // ä¿å­˜å½“å‰å€¼
            const sourceDisplayValue = sourceDisplay.value;
            const sourceInputValue = sourceInput.value;
            const targetDisplayValue = targetDisplay.value;
            const targetInputValue = targetInput.value;
            
            console.log('äº’æ¢å‰ - æºå®ä½“:', sourceDisplayValue, 'ç›®æ ‡å®ä½“:', targetDisplayValue);
            
            // äº’æ¢æ˜¾ç¤ºå€¼
            sourceDisplay.value = targetDisplayValue;
            sourceInput.value = targetInputValue;
            targetDisplay.value = sourceDisplayValue;
            targetInput.value = sourceInputValue;
            
            console.log('äº’æ¢å - æºå®ä½“:', sourceDisplay.value, 'ç›®æ ‡å®ä½“:', targetDisplay.value);
            
            // æ·»åŠ ç®€å•çš„è§†è§‰åé¦ˆï¼ˆåªæ”¹å˜é¢œè‰²ï¼Œä¸æ”¹å˜æ–‡å­—ï¼‰
            const swapButton = document.querySelector('.btn-swap');
            if (swapButton) {
                swapButton.style.background = '#d4edda';
                swapButton.style.color = '#155724';
                swapButton.style.borderColor = '#c3e6cb';
                
                // 1ç§’åæ¢å¤åŸæ ·å¼
                setTimeout(() => {
                    swapButton.style.background = '';
                    swapButton.style.color = '';
                    swapButton.style.borderColor = '';
                }, 1000);
            }
            
            // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥æ›´æ–°ä¸‹æ‹‰æ¡†
            sourceDisplay.dispatchEvent(new Event('input'));
            targetDisplay.dispatchEvent(new Event('input'));
        }

        // å¼ºåˆ¶åˆ·æ–°æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
        async function forceRefreshData() {
            console.log('å¼ºåˆ¶åˆ·æ–°æ•°æ®...');
            
            // æ·»åŠ å»¶è¿Ÿï¼Œç¡®ä¿åç«¯æ•°æ®å·²ä¿å­˜
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
                try {
                    console.log(`å°è¯•åˆ·æ–°æ•°æ® (ç¬¬${retryCount + 1}æ¬¡)...`);
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    const loadSuccess = await loadGraphData();
                    if (loadSuccess) {
                        console.log('æ•°æ®åˆ·æ–°æˆåŠŸ');
                        
                        // æ›´æ–°ç•Œé¢
                        updateEntityDropdowns();
                        updateRelationTypeDropdown();
                        renderEntityList();
                        reloadGraph();
                        
                        // æ›´æ–°é¢†åŸŸä¿¡æ¯
                        updateDomainInfo();
                        
                        console.log('ç•Œé¢æ›´æ–°å®Œæˆ');
                        return true;
                    } else {
                        console.error(`æ•°æ®åˆ·æ–°å¤±è´¥ (ç¬¬${retryCount + 1}æ¬¡)`);
                        retryCount++;
                        if (retryCount < maxRetries) {
                            console.log('ç­‰å¾…2ç§’åé‡è¯•...');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                } catch (error) {
                    console.error(`å¼ºåˆ¶åˆ·æ–°æ•°æ®æ—¶å‡ºé”™ (ç¬¬${retryCount + 1}æ¬¡):`, error);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.log('ç­‰å¾…2ç§’åé‡è¯•...');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            
            console.error('æ•°æ®åˆ·æ–°å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
            return false;
        }

        // æ›´æ–°é¢†åŸŸé€‰æ‹©å™¨ï¼Œæ·»åŠ æ–°çš„è‡ªå®šä¹‰é¢†åŸŸ
        function updateDomainSelectorWithCustom(domainName) {
            console.log('æ›´æ–°é¢†åŸŸé€‰æ‹©å™¨ï¼Œæ·»åŠ è‡ªå®šä¹‰é¢†åŸŸ:', domainName);
            
            // æ›´æ–°é¢†åŸŸä¸‹æ‹‰æ¡†
            if (typeof updateDomainDropdown === 'function') {
                updateDomainDropdown(null, '');
            }
            
            // æ›´æ–°é¢†åŸŸä¿¡æ¯æ˜¾ç¤º
            if (typeof updateDomainInfo === 'function') {
                updateDomainInfo();
            }
            
            // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯è¿™ä¸ªè‡ªå®šä¹‰é¢†åŸŸï¼Œæ›´æ–°æ˜¾ç¤º
            const domainSelect = document.getElementById('domain-select');
            const domainSelectDisplay = document.getElementById('domain-select-display');
            
            if (domainSelect && domainSelect.value === domainName) {
                if (domainSelectDisplay) {
                    domainSelectDisplay.value = domainName;
                }
            }
            
            console.log('é¢†åŸŸé€‰æ‹©å™¨æ›´æ–°å®Œæˆ');
        }

        // æµ‹è¯•æ•°æ®åŠ è½½å’Œæ˜¾ç¤º
        function testDataLoading() {
            console.log('=== æ•°æ®åŠ è½½æµ‹è¯• ===');
            console.log('graphData:', {
                nodes: graphData.nodes.length,
                links: graphData.links.length,
                domains: [...new Set(graphData.nodes.map(n => n.domain))]
            });
            console.log('allGraphData:', {
                nodes: allGraphData.nodes.length,
                links: allGraphData.links.length,
                domains: [...new Set(allGraphData.nodes.map(n => n.domain))]
            });
            console.log('filteredGraphData:', {
                nodes: filteredGraphData.nodes.length,
                links: filteredGraphData.links.length,
                domains: [...new Set(filteredGraphData.nodes.map(n => n.domain))]
            });
            console.log('currentDomain:', currentDomain);
            console.log('=== æµ‹è¯•å®Œæˆ ===');
        }

        // æµ‹è¯•ç‰¹å®šé¢†åŸŸçš„æ•°æ®ç­›é€‰
        function testDomainFilter(domainName) {
            console.log(`=== æµ‹è¯•é¢†åŸŸç­›é€‰: ${domainName} ===`);
            
            // æ£€æŸ¥ allGraphData ä¸­æ˜¯å¦æœ‰è¯¥é¢†åŸŸçš„æ•°æ®
            const domainNodes = allGraphData.nodes.filter(n => n.domain === domainName);
            const domainLinks = allGraphData.links.filter(l => l.domain === domainName);
            
            console.log('è¯¥é¢†åŸŸçš„æ•°æ®:', {
                nodes: domainNodes.length,
                links: domainLinks.length,
                nodeIds: domainNodes.map(n => n.id),
                linkInfo: domainLinks.map(l => ({
                    source: typeof l.source === 'object' ? l.source.id : l.source,
                    target: typeof l.target === 'object' ? l.target.id : l.target,
                    type: l.type
                }))
            });
            
            // æ¨¡æ‹Ÿç­›é€‰è¿‡ç¨‹
            const filteredNodeIds = new Set(domainNodes.map(n => n.id));
            const relatedNodeIds = new Set(filteredNodeIds);
            
            domainLinks.forEach(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                relatedNodeIds.add(sourceId);
                relatedNodeIds.add(targetId);
            });
            
            const allRelatedNodes = allGraphData.nodes.filter(node => 
                relatedNodeIds.has(node.id)
            );
            
            const allRelatedLinks = allGraphData.links.filter(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                return relatedNodeIds.has(sourceId) && relatedNodeIds.has(targetId);
            });
            
            console.log('ç­›é€‰ç»“æœ:', {
                relatedNodes: allRelatedNodes.length,
                relatedLinks: allRelatedLinks.length,
                relatedNodeIds: Array.from(relatedNodeIds)
            });
            
            console.log('=== ç­›é€‰æµ‹è¯•å®Œæˆ ===');
        }

        // å…¨å±€å‡½æ•°ï¼Œç”¨äºAIèŠå¤©
        window.toggleAIChat = toggleAIChat;
        window.handleAIKeyPress = handleAIKeyPress;
        window.sendAIMessage = sendAIMessage;
        window.toggleAISwitch = toggleAISwitch;
        window.switchToPreviewMode = switchToPreviewMode;
        window.switchToDataMode = switchToDataMode;
        window.saveJsonData = saveJsonData;
        window.cancelDataEdit = cancelDataEdit;
        window.swapEntities = swapEntities;
        window.addSuffixToIds = addSuffixToIds;
        
        // å¯¼å‡ºJSONç¼–è¾‘å™¨ç›¸å…³å‡½æ•°
        window.parseAndRenderJson = parseAndRenderJson;

        window.testDataLoading = testDataLoading;
        window.testDomainFilter = testDomainFilter;

        // ç®€åŒ–çš„JSONç¼–è¾‘å™¨åŠŸèƒ½
        let jsonData = null;

        // ç®€åŒ–çš„JSONå¤„ç†
        function parseAndRenderJson(jsonString) {
            try {
                jsonData = JSON.parse(jsonString);
                const jsonEditor = document.getElementById('json-editor');
                if (jsonEditor) {
                    jsonEditor.value = JSON.stringify(jsonData, null, 2);
                }
            } catch (error) {
                console.error('JSONè§£æé”™è¯¯:', error);
                alert('JSONæ ¼å¼é”™è¯¯: ' + error.message);
            }
        }



        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const contentDiv = document.getElementById('json-content');
            const lineNumbersDiv = document.getElementById('line-numbers');
            const jsonEditor = document.getElementById('json-editor');
            
            if (contentDiv && contentDiv.style.display !== 'none') {
                contentDiv.scrollTop = contentDiv.scrollHeight;
            }
            if (lineNumbersDiv && lineNumbersDiv.style.display !== 'none') {
                lineNumbersDiv.scrollTop = lineNumbersDiv.scrollHeight;
            }
            if (jsonEditor && jsonEditor.style.display !== 'none') {
                jsonEditor.scrollTop = jsonEditor.scrollHeight;
            }
        }

        // JSONæœç´¢åŠŸèƒ½
        function searchInJson(query) {
            const searchCount = document.getElementById('search-count');
            
            if (!searchCount) return;
            
            // æ¸…é™¤ä¹‹å‰çš„æœç´¢é«˜äº®
            clearSearchHighlights();
            
            if (!query.trim()) {
                searchCount.textContent = '';
                return;
            }
            
            const contentDiv = document.getElementById('json-content');
            if (!contentDiv) return;
            
            const text = contentDiv.textContent;
            const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            const matches = [];
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                matches.push({
                    index: match.index,
                    length: match[0].length,
                    text: match[0]
                });
            }
            
            jsonSearchResults = matches;
            currentJsonSearchIndex = -1;
            
            if (matches.length > 0) {
                searchCount.textContent = `${matches.length} ä¸ªç»“æœ`;
                highlightSearchResults();
                navigateToNextMatch();
            } else {
                searchCount.textContent = 'æ— ç»“æœ';
            }
        }

        // æ¸…é™¤æœç´¢é«˜äº®
        function clearSearchHighlights() {
            const highlights = document.querySelectorAll('.search-highlight');
            highlights.forEach(highlight => {
                const parent = highlight.parentNode;
                parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                parent.normalize();
            });
        }

        // é«˜äº®æœç´¢ç»“æœ
        function highlightSearchResults() {
            const contentDiv = document.getElementById('json-content');
            if (!contentDiv || jsonSearchResults.length === 0) return;
            
            const text = contentDiv.textContent;
            let highlightedText = text;
            let offset = 0;
            
            jsonSearchResults.forEach((match, index) => {
                const start = match.index + offset;
                const end = start + match.length;
                
                const before = highlightedText.substring(0, start);
                const after = highlightedText.substring(end);
                const highlighted = `<span class="search-highlight" data-index="${index}">${match.text}</span>`;
                
                highlightedText = before + highlighted + after;
                offset += highlighted.length - match.text.length;
            });
            
            // åˆ›å»ºä¸´æ—¶æ˜¾ç¤ºå±‚
            const container = contentDiv.parentElement;
            const highlightDiv = document.createElement('div');
            highlightDiv.className = 'json-highlight-display';
            highlightDiv.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: transparent;
                pointer-events: none;
                font-family: inherit;
                font-size: inherit;
                line-height: inherit;
                padding: inherit;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow: hidden;
                z-index: 1;
            `;
            highlightDiv.innerHTML = highlightedText;
            
            // ç§»é™¤ä¹‹å‰çš„æ˜¾ç¤º
            const existingDisplay = container.querySelector('.json-highlight-display');
            if (existingDisplay) {
                existingDisplay.remove();
            }
            
            container.appendChild(highlightDiv);
        }

        // å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹
        function navigateToNextMatch() {
            if (jsonSearchResults.length === 0) return;
            
            currentJsonSearchIndex = (currentJsonSearchIndex + 1) % jsonSearchResults.length;
            const match = jsonSearchResults[currentJsonSearchIndex];
            const searchCount = document.getElementById('search-count');
            
            if (searchCount) {
                searchCount.textContent = `${currentJsonSearchIndex + 1}/${jsonSearchResults.length}`;
            }
            
            // æ»šåŠ¨åˆ°åŒ¹é…é¡¹
            const contentDiv = document.getElementById('json-content');
            if (contentDiv) {
                const text = contentDiv.textContent;
                const beforeMatch = text.substring(0, match.index);
                const lines = beforeMatch.split('\n');
                const lineNumber = lines.length - 1;
                const lineHeight = 20;
                const scrollTop = lineNumber * lineHeight;
                
                contentDiv.scrollTop = Math.max(0, scrollTop - 100);
            }
            
            // é«˜äº®å½“å‰åŒ¹é…é¡¹
            const currentHighlight = document.querySelector('.search-highlight.current');
            if (currentHighlight) {
                currentHighlight.classList.remove('current');
            }
            
            const highlights = document.querySelectorAll('.search-highlight');
            if (highlights[currentJsonSearchIndex]) {
                highlights[currentJsonSearchIndex].classList.add('current');
            }
        }

        // é”®ç›˜å¿«æ·é”®
        function setupJsonEditorShortcuts() {
            const searchInput = document.getElementById('json-search');
            if (searchInput) {
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            // Shift+Enter: ä¸Šä¸€ä¸ªåŒ¹é…é¡¹
                            if (jsonSearchResults.length > 0) {
                                currentJsonSearchIndex = currentJsonSearchIndex <= 0 ? jsonSearchResults.length - 1 : currentJsonSearchIndex - 1;
                                const match = jsonSearchResults[currentJsonSearchIndex];
                                navigateToMatch(match);
                                
                                const searchCount = document.getElementById('search-count');
                                if (searchCount) {
                                    searchCount.textContent = `${currentJsonSearchIndex + 1}/${jsonSearchResults.length}`;
                                }
                            }
                        } else {
                            // Enter: ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹
                            navigateToNextMatch();
                        }
                    }
                });
            }
        }

        // å¯¼èˆªåˆ°æŒ‡å®šåŒ¹é…é¡¹
        function navigateToMatch(match) {
            const contentDiv = document.getElementById('json-content');
            if (contentDiv) {
                const text = contentDiv.textContent;
                const beforeMatch = text.substring(0, match.index);
                const lines = beforeMatch.split('\n');
                const lineNumber = lines.length - 1;
                const lineHeight = 20;
                const scrollTop = lineNumber * lineHeight;
                
                contentDiv.scrollTop = Math.max(0, scrollTop - 100);
            }
            
            // é«˜äº®å½“å‰åŒ¹é…é¡¹
            const currentHighlight = document.querySelector('.search-highlight.current');
            if (currentHighlight) {
                currentHighlight.classList.remove('current');
            }
            
            const highlights = document.querySelectorAll('.search-highlight');
            if (highlights[currentJsonSearchIndex]) {
                highlights[currentJsonSearchIndex].classList.add('current');
            }
        }

        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleEditMode() {
            const jsonEditor = document.getElementById('json-editor');
            const jsonContent = document.getElementById('json-content');
            const lineNumbers = document.getElementById('line-numbers');
            const editBtn = document.querySelector('.toolbar-btn[onclick="toggleEditMode()"]');
            
            if (!jsonEditor || !jsonContent || !lineNumbers) return;
            
            if (jsonEditor.style.display === 'none') {
                // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                jsonEditor.style.display = 'block';
                jsonContent.style.display = 'none';
                lineNumbers.style.display = 'none';
                editBtn.textContent = 'ğŸ‘ï¸ é¢„è§ˆ';
                editBtn.title = 'åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼';
                
                // åŒæ­¥æ•°æ®åˆ°textarea
                if (jsonData) {
                    jsonEditor.value = JSON.stringify(jsonData, null, 2);
                }
            } else {
                // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                jsonEditor.style.display = 'none';
                jsonContent.style.display = 'block';
                lineNumbers.style.display = 'block';
                editBtn.textContent = 'âœï¸ ç¼–è¾‘';
                editBtn.title = 'åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼';
                
                // ä»textareaåŒæ­¥æ•°æ®å¹¶é‡æ–°æ¸²æŸ“
                try {
                    const newData = JSON.parse(jsonEditor.value);
                    jsonData = newData;
                    parseAndRenderJson(jsonEditor.value);
                } catch (error) {
                    alert('JSONæ ¼å¼é”™è¯¯ï¼Œæ— æ³•åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼');
                    return;
                }
            }
        }



        // ç¦ç”¨å³ä¾§é¢æ¿åŠŸèƒ½
        function disableRightPanel() {
            console.log('ç¦ç”¨å³ä¾§é¢æ¿åŠŸèƒ½...');
            
            // ç¦ç”¨é¢†åŸŸé€‰æ‹©å™¨
            const domainSelectContainer = document.querySelector('.domain-selector-container');
            const domainSelectDisplay = document.getElementById('domain-select-display');
            const domainSelect = document.getElementById('domain-select');
            const domainDropdown = document.getElementById('domain-dropdown');
            const currentDomainInfo = document.getElementById('current-domain-info');
            
            if (domainSelectContainer) {
                domainSelectContainer.classList.add('domain-select-disabled');
            }
            
            if (domainSelectDisplay) {
                domainSelectDisplay.disabled = true;
                domainSelectDisplay.placeholder = 'æ•°æ®æ¨¡å¼ä¸‹å·²ç¦ç”¨';
            }
            
            if (domainSelect) {
                domainSelect.disabled = true;
            }
            
            if (domainDropdown) {
                domainDropdown.style.display = 'none';
            }
            
            if (currentDomainInfo) {
                currentDomainInfo.textContent = 'æ•°æ®æ¨¡å¼ä¸‹åŠŸèƒ½å·²ç¦ç”¨';
                currentDomainInfo.classList.add('domain-info-disabled');
            }
            
            // ç¦ç”¨æœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const searchType = document.getElementById('search-type');
            
            if (searchInput) {
                searchInput.disabled = true;
                searchInput.placeholder = 'æ•°æ®æ¨¡å¼ä¸‹æœç´¢å·²ç¦ç”¨';
            }
            
            if (searchBtn) {
                searchBtn.disabled = true;
                searchBtn.textContent = 'æœç´¢å·²ç¦ç”¨';
            }
            
            if (searchType) {
                searchType.disabled = true;
            }
            
            // ä¸ç¦ç”¨JSONç¼–è¾‘å™¨æœç´¢åŠŸèƒ½ - æ•°æ®ç¼–è¾‘å™¨åŠŸèƒ½åº”è¯¥ä¿æŒå¯ç”¨
            // const jsonSearchInput = document.getElementById('json-search');
            // if (jsonSearchInput) {
            //     jsonSearchInput.disabled = true;
            //     jsonSearchInput.placeholder = 'æ•°æ®æ¨¡å¼ä¸‹æœç´¢åŠŸèƒ½å·²ç¦ç”¨';
            // }
            
            // ç¦ç”¨AIèŠå¤©åŠŸèƒ½
            const aiChatbot = document.querySelector('.ai-chatbot');
            if (aiChatbot) {
                aiChatbot.style.pointerEvents = 'none';
                aiChatbot.style.opacity = '0.5';
            }
            
            // ç¦ç”¨è¯¦æƒ…é¢æ¿
            const detailView = document.getElementById('detail-view');
            if (detailView) {
                detailView.innerHTML = '<div class="no-data">æ•°æ®æ¨¡å¼ä¸‹è¯¦æƒ…æŸ¥çœ‹å·²ç¦ç”¨</div>';
            }
            
            // ç¦ç”¨æ‰€æœ‰ç¼–è¾‘åŠŸèƒ½ï¼Œä½†ä¿ç•™JSONç¼–è¾‘å™¨å’Œæ•°æ®æ¨¡å¼ç›¸å…³åŠŸèƒ½
            const allEditButtons = document.querySelectorAll('.btn-edit, .btn-save, .btn-cancel, .btn-delete, .btn-copy, .btn-update');
            allEditButtons.forEach(btn => {
                // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å±äºæ•°æ®æ¨¡å¼ç›¸å…³åŠŸèƒ½æˆ–JSONç¼–è¾‘å™¨åŠŸèƒ½
                if (btn.closest('.data-controls') || btn.closest('.mode-switcher') || btn.closest('.json-editor-toolbar') || btn.closest('.json-editor-container')) {
                    return; // ä¸ç¦ç”¨æ•°æ®æ¨¡å¼ç›¸å…³çš„æŒ‰é’®å’ŒJSONç¼–è¾‘å™¨æŒ‰é’®
                }
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // ç¦ç”¨å®ä½“æè¿°ç¼–è¾‘åŠŸèƒ½
            const entityDetailPanel = document.getElementById('entity-detail-panel');
            if (entityDetailPanel) {
                const editButtons = entityDetailPanel.querySelectorAll('.btn-edit, .btn-save, .btn-cancel');
                editButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });
            }
            
            // ç¦ç”¨å®ä½“åˆ—è¡¨ç¼–è¾‘åŠŸèƒ½
            const entityList = document.getElementById('entity-list');
            if (entityList) {
                // ç¦ç”¨å®ä½“åˆ—è¡¨ä¸­çš„æ“ä½œæŒ‰é’®
                const actionButtons = entityList.querySelectorAll('.action-btn');
                actionButtons.forEach(btn => {
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.3';
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'æ•°æ®æ¨¡å¼ä¸‹å·²ç¦ç”¨';
                });
                
                // ç¦ç”¨å®ä½“åˆ—è¡¨ä¸­çš„ç¼–è¾‘ã€å¤åˆ¶ã€åˆ é™¤æŒ‰é’®
                const editButtons = entityList.querySelectorAll('.edit-btn, .copy-btn, .delete-btn');
                editButtons.forEach(btn => {
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.3';
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'æ•°æ®æ¨¡å¼ä¸‹å·²ç¦ç”¨';
                });
                
                // ä¸ºå®ä½“åˆ—è¡¨æ·»åŠ ç¦ç”¨æ ‡è¯†
                entityList.setAttribute('data-mode-disabled', 'true');
                
                // ç¦ç”¨å®ä½“åˆ—è¡¨é¡¹çš„ç‚¹å‡»
                const entityItems = entityList.querySelectorAll('.entity-item');
                entityItems.forEach(item => {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.7';
                    item.style.cursor = 'not-allowed';
                });
            }
            
            // ç›‘å¬å®ä½“åˆ—è¡¨çš„åŠ¨æ€å˜åŒ–
            const entitiesContainer = document.getElementById('entities-container');
            if (entitiesContainer) {
                // åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿå™¨æ¥ç›‘å¬å®ä½“åˆ—è¡¨çš„å˜åŒ–
                const observer = new MutationObserver((mutations) => {
                    if (currentMode === 'data') {
                        mutations.forEach((mutation) => {
                            mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
                                    // ç¦ç”¨æ–°æ·»åŠ çš„æ“ä½œæŒ‰é’®
                                    const actionButtons = node.querySelectorAll('.action-btn');
                                    actionButtons.forEach(btn => {
                                        btn.style.pointerEvents = 'none';
                                        btn.style.opacity = '0.3';
                                        btn.style.cursor = 'not-allowed';
                                        btn.title = 'æ•°æ®æ¨¡å¼ä¸‹å·²ç¦ç”¨';
                                    });
                                    
                                    // ç¦ç”¨æ–°æ·»åŠ çš„å®ä½“é¡¹
                                    const entityItems = node.querySelectorAll('.entity-item');
                                    entityItems.forEach(item => {
                                        item.style.pointerEvents = 'none';
                                        item.style.opacity = '0.7';
                                        item.style.cursor = 'not-allowed';
                                    });
                                    
                                    // å¦‚æœæ·»åŠ çš„èŠ‚ç‚¹æœ¬èº«å°±æ˜¯å®ä½“é¡¹
                                    if (node.classList && node.classList.contains('entity-item')) {
                                        node.style.pointerEvents = 'none';
                                        node.style.opacity = '0.7';
                                        node.style.cursor = 'not-allowed';
                                    }
                                }
                            });
                        });
                    }
                });
                
                observer.observe(entitiesContainer, {
                    childList: true,
                    subtree: true
                });
            }
            
            // ç¦ç”¨å…³ç³»ç¼–è¾‘åŠŸèƒ½
            const relationEditButtons = document.querySelectorAll('[onclick*="edit"], [onclick*="Edit"]');
            relationEditButtons.forEach(btn => {
                if (btn.closest('.data-controls') || btn.closest('.mode-switcher')) {
                    return; // ä¸ç¦ç”¨æ•°æ®æ¨¡å¼ç›¸å…³çš„æŒ‰é’®
                }
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // ç¦ç”¨æ‰€æœ‰å¯èƒ½çš„ç¼–è¾‘è¾“å…¥æ¡†
            const editInputs = document.querySelectorAll('input[type="text"], textarea');
            editInputs.forEach(input => {
                if (input.closest('.data-controls') || 
                    input.closest('.mode-switcher') || 
                    input.id === 'json-editor') {
                    return; // ä¸ç¦ç”¨æ•°æ®æ¨¡å¼ç›¸å…³çš„è¾“å…¥æ¡†
                }
                input.disabled = true;
                input.style.opacity = '0.5';
                input.style.cursor = 'not-allowed';
            });
            
            // ç¦ç”¨æ‰€æœ‰å¯èƒ½çš„ç¼–è¾‘ä¸‹æ‹‰æ¡†
            const editSelects = document.querySelectorAll('select');
            editSelects.forEach(select => {
                if (select.closest('.data-controls') || 
                    select.closest('.mode-switcher')) {
                    return; // ä¸ç¦ç”¨æ•°æ®æ¨¡å¼ç›¸å…³çš„ä¸‹æ‹‰æ¡†
                }
                select.disabled = true;
                select.style.opacity = '0.5';
                select.style.cursor = 'not-allowed';
            });
            
            console.log('å³ä¾§é¢æ¿åŠŸèƒ½å·²ç¦ç”¨');
            
            // ç¦ç”¨å·¦ä¾§é¢æ¿åŠŸèƒ½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const leftPanel = document.querySelector('.left-panel');
            if (leftPanel) {
                const leftPanelInputs = leftPanel.querySelectorAll('input, select, button');
                leftPanelInputs.forEach(element => {
                    if (element.classList.contains('data-btn') || 
                        element.closest('.data-controls') || 
                        element.closest('.mode-switcher')) {
                        // ä¸ç¦ç”¨æ•°æ®æ¨¡å¼ç›¸å…³çš„æŒ‰é’®
                        return;
                    }
                    element.disabled = true;
                    element.style.opacity = '0.5';
                    element.style.cursor = 'not-allowed';
                });
            }
        }

        // é‡ç½®é¢†åŸŸç­›é€‰å™¨åˆ°æ‰€æœ‰é¢†åŸŸ
        function resetDomainSelector() {
            console.log('é‡ç½®é¢†åŸŸç­›é€‰å™¨...');
            
            // é‡ç½®é¢†åŸŸé€‰æ‹©ä¸º"æ‰€æœ‰é¢†åŸŸ"
            if (domainSelect) {
                domainSelect.value = 'all';
                console.log('domainSelect å·²é‡ç½®ä¸º all');
            }
            if (domainSelectDisplay) {
                domainSelectDisplay.value = 'æ‰€æœ‰é¢†åŸŸ';
                console.log('domainSelectDisplay å·²é‡ç½®ä¸º æ‰€æœ‰é¢†åŸŸ');
            }
            currentDomain = 'all';
            console.log('currentDomain å·²é‡ç½®ä¸º all');
            
            // ç¡®ä¿ä¸‹æ‹‰æ¡†å¯è§æ€§æ­£ç¡®
            if (domainDropdown) {
                domainDropdown.style.display = ''; // æ¢å¤æ˜¾ç¤º
                domainDropdown.classList.remove('visible');
                console.log('ä¸‹æ‹‰æ¡†æ˜¾ç¤ºçŠ¶æ€å·²é‡ç½®');
            }
            
            // é‡æ–°åˆå§‹åŒ–é¢†åŸŸé€‰æ‹©å™¨
            if (typeof initializeDomainSelector === 'function') {
                initializeDomainSelector();
                console.log('é¢†åŸŸé€‰æ‹©å™¨å·²é‡æ–°åˆå§‹åŒ–');
            }
            
            // é‡æ–°ç­›é€‰æ•°æ®ä¸ºæ‰€æœ‰é¢†åŸŸ
            if (typeof filterDataByDomain === 'function') {
                filterDataByDomain();
                console.log('æ•°æ®å·²é‡æ–°ç­›é€‰ä¸ºæ‰€æœ‰é¢†åŸŸ');
            }
            
            // é‡æ–°æ›´æ–°é¢†åŸŸä¿¡æ¯
            if (typeof updateDomainInfo === 'function') {
                updateDomainInfo();
                console.log('é¢†åŸŸä¿¡æ¯å·²æ›´æ–°');
            }
            
            // æµ‹è¯•ä¸‹æ‹‰æ¡†åŠŸèƒ½
            setTimeout(() => {
                console.log('æµ‹è¯•ä¸‹æ‹‰æ¡†åŠŸèƒ½...');
                console.log('domainSelectDisplay:', domainSelectDisplay);
                console.log('domainDropdown:', domainDropdown);
                console.log('domainSelectDisplay.disabled:', domainSelectDisplay?.disabled);
                console.log('domainDropdown.style.display:', domainDropdown?.style.display);
                console.log('domainDropdown.classList:', domainDropdown?.classList);
                
                // æµ‹è¯•ç‚¹å‡»äº‹ä»¶
                if (domainSelectDisplay && !domainSelectDisplay.disabled) {
                    console.log('é¢†åŸŸé€‰æ‹©å™¨å·²å¯ç”¨ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨');
                } else {
                    console.log('é¢†åŸŸé€‰æ‹©å™¨ä»ç„¶è¢«ç¦ç”¨');
                }
            }, 100);
            
            console.log('é¢†åŸŸç­›é€‰å™¨å·²é‡ç½®ä¸ºæ‰€æœ‰é¢†åŸŸ');
        }

        // å¯ç”¨å³ä¾§é¢æ¿åŠŸèƒ½
        function enableRightPanel() {
            console.log('å¯ç”¨å³ä¾§é¢æ¿åŠŸèƒ½...');
            
            // å¯ç”¨é¢†åŸŸé€‰æ‹©å™¨
            const domainSelectContainer = document.querySelector('.domain-selector-container');
            const domainSelectDisplay = document.getElementById('domain-select-display');
            const domainSelect = document.getElementById('domain-select');
            const currentDomainInfo = document.getElementById('current-domain-info');
            
            if (domainSelectContainer) {
                domainSelectContainer.classList.remove('domain-select-disabled');
                console.log('é¢†åŸŸé€‰æ‹©å™¨å®¹å™¨ç¦ç”¨æ ·å¼å·²ç§»é™¤');
            }
            
            if (domainSelectDisplay) {
                domainSelectDisplay.disabled = false;
                domainSelectDisplay.placeholder = 'è¾“å…¥æˆ–é€‰æ‹©é¢†åŸŸ';
            }
            
            if (domainSelect) {
                domainSelect.disabled = false;
            }
            
            // æ¢å¤ä¸‹æ‹‰æ¡†æ˜¾ç¤º
            if (domainDropdown) {
                domainDropdown.style.display = '';
            }
            
            if (currentDomainInfo) {
                currentDomainInfo.classList.remove('domain-info-disabled');
            }
            
            // é‡ç½®é¢†åŸŸç­›é€‰å™¨åˆ°æ‰€æœ‰é¢†åŸŸ
            resetDomainSelector();
            
            // å¯ç”¨æœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const searchType = document.getElementById('search-type');
            
            if (searchInput) {
                searchInput.disabled = false;
                searchInput.placeholder = 'è¯·è¾“å…¥æœç´¢å†…å®¹...';
            }
            
            if (searchBtn) {
                searchBtn.disabled = false;
                searchBtn.textContent = 'æœç´¢';
            }
            
            if (searchType) {
                searchType.disabled = false;
            }
            
            // JSONç¼–è¾‘å™¨æœç´¢åŠŸèƒ½å§‹ç»ˆä¿æŒå¯ç”¨ï¼Œæ— éœ€æ¢å¤
            // const jsonSearchInput = document.getElementById('json-search');
            // if (jsonSearchInput) {
            //     jsonSearchInput.disabled = false;
            //     jsonSearchInput.placeholder = 'æœç´¢JSONå†…å®¹...';
            // }
            
            // å¯ç”¨AIèŠå¤©åŠŸèƒ½
            const aiChatbot = document.querySelector('.ai-chatbot');
            if (aiChatbot) {
                aiChatbot.style.pointerEvents = 'auto';
                aiChatbot.style.opacity = '1';
            }
            
            // æ¢å¤è¯¦æƒ…é¢æ¿
            const detailView = document.getElementById('detail-view');
            if (detailView) {
                detailView.innerHTML = '<div class="no-data">é€‰æ‹©ä¸€ä¸ªå®ä½“æˆ–å…³ç³»æŸ¥çœ‹è¯¦æƒ…</div>';
            }
            
            // æ¢å¤æ‰€æœ‰ç¼–è¾‘åŠŸèƒ½
            const allEditButtons = document.querySelectorAll('.btn-edit, .btn-save, .btn-cancel, .btn-delete, .btn-copy, .btn-update');
            allEditButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '';
                btn.style.cursor = '';
            });
            
            // æ¢å¤å®ä½“æè¿°ç¼–è¾‘åŠŸèƒ½
            const entityDetailPanel = document.getElementById('entity-detail-panel');
            if (entityDetailPanel) {
                const editButtons = entityDetailPanel.querySelectorAll('.btn-edit, .btn-save, .btn-cancel');
                editButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                });
            }
            
            // æ¢å¤å®ä½“åˆ—è¡¨ç¼–è¾‘åŠŸèƒ½
            const entityList = document.getElementById('entity-list');
            if (entityList) {
                // æ¢å¤å®ä½“åˆ—è¡¨ä¸­çš„æ“ä½œæŒ‰é’®
                const actionButtons = entityList.querySelectorAll('.action-btn');
                actionButtons.forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                    // æ¢å¤åŸå§‹æ ‡é¢˜
                    if (btn.classList.contains('edit-btn')) {
                        btn.title = 'ç¼–è¾‘';
                    } else if (btn.classList.contains('copy-btn')) {
                        btn.title = 'å¤åˆ¶';
                    } else if (btn.classList.contains('delete-btn')) {
                        btn.title = 'åˆ é™¤';
                    }
                });
                
                // æ¢å¤å®ä½“åˆ—è¡¨ä¸­çš„ç¼–è¾‘ã€å¤åˆ¶ã€åˆ é™¤æŒ‰é’®
                const editButtons = entityList.querySelectorAll('.edit-btn, .copy-btn, .delete-btn');
                editButtons.forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                    // æ¢å¤åŸå§‹æ ‡é¢˜
                    if (btn.classList.contains('edit-btn')) {
                        btn.title = 'ç¼–è¾‘';
                    } else if (btn.classList.contains('copy-btn')) {
                        btn.title = 'å¤åˆ¶';
                    } else if (btn.classList.contains('delete-btn')) {
                        btn.title = 'åˆ é™¤';
                    }
                });
                
                // æ¢å¤å®ä½“åˆ—è¡¨é¡¹çš„ç‚¹å‡»
                const entityItems = entityList.querySelectorAll('.entity-item');
                entityItems.forEach(item => {
                    item.style.pointerEvents = 'auto';
                    item.style.opacity = '';
                    item.style.cursor = '';
                });
            }
            
            // æ¢å¤å…³ç³»ç¼–è¾‘åŠŸèƒ½
            const relationEditButtons = document.querySelectorAll('[onclick*="edit"], [onclick*="Edit"]');
            relationEditButtons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '';
                btn.style.cursor = '';
            });
            
            // æ¢å¤æ‰€æœ‰ç¼–è¾‘è¾“å…¥æ¡†
            const editInputs = document.querySelectorAll('input[type="text"], textarea');
            editInputs.forEach(input => {
                if (input.id === 'json-editor') {
                    return; // ä¸æ¢å¤JSONç¼–è¾‘å™¨ï¼Œå› ä¸ºå®ƒå±äºæ•°æ®æ¨¡å¼
                }
                input.disabled = false;
                input.style.opacity = '';
                input.style.cursor = '';
            });
            
            // æ¢å¤æ‰€æœ‰ç¼–è¾‘ä¸‹æ‹‰æ¡†
            const editSelects = document.querySelectorAll('select');
            editSelects.forEach(select => {
                select.disabled = false;
                select.style.opacity = '';
                select.style.cursor = '';
            });
            
            console.log('å³ä¾§é¢æ¿åŠŸèƒ½å·²å¯ç”¨');
            
            // å¯ç”¨å·¦ä¾§é¢æ¿åŠŸèƒ½
            const leftPanel = document.querySelector('.left-panel');
            if (leftPanel) {
                const leftPanelInputs = leftPanel.querySelectorAll('input, select, button');
                leftPanelInputs.forEach(element => {
                    element.disabled = false;
                    element.style.opacity = '';
                    element.style.cursor = '';
                });
            }
        }

        // æ¨¡å¼åˆ‡æ¢ç›¸å…³å˜é‡
        let currentMode = 'preview'; // 'preview' æˆ– 'data'
        let originalJsonData = null; // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºå–æ¶ˆç¼–è¾‘

        // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
        function switchToPreviewMode() {
            if (currentMode === 'preview') return;
            
            currentMode = 'preview';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelector('.mode-btn.preview').classList.add('active');
            document.querySelector('.mode-btn.data').classList.remove('active');
            
            // å¯ç”¨åˆ·æ–°æŒ‰é’®
            const refreshBtn = document.getElementById('refresh-data');
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.style.opacity = '1';
                refreshBtn.style.cursor = 'pointer';
                console.log('åˆ·æ–°æŒ‰é’®å·²å¯ç”¨');
            }
            
            // æ˜¾ç¤ºé¢„è§ˆæ¨¡å¼ï¼Œéšè—æ•°æ®æ¨¡å¼
            document.getElementById('preview-mode').style.display = 'block';
            document.getElementById('data-mode').classList.remove('active');
            
            // é‡æ–°å¯ç”¨å³ä¾§é¢æ¿åŠŸèƒ½
            enableRightPanel();
            
            // é‡æ–°åˆå§‹åŒ–å›¾å½¢
            if (graphData && graphData.nodes && graphData.nodes.length > 0) {
                // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                console.log('åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼ï¼Œå½“å‰æ•°æ®:', graphData);
                initializeGraph();
                
                // å»¶è¿Ÿæ‰§è¡Œé€‚é…æ˜¾ç¤ºï¼Œç¡®ä¿å›¾å½¢å·²å®Œå…¨æ¸²æŸ“
                setTimeout(() => {
                    fitView();
                    console.log('é¢„è§ˆæ¨¡å¼ï¼šå·²æ‰§è¡Œé€‚é…æ˜¾ç¤º');
                }, 500);
            } else {
                console.log('æ²¡æœ‰æ•°æ®ï¼Œé‡æ–°åŠ è½½...');
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé‡æ–°åŠ è½½
                loadGraphData();
            }
        }

        // åˆ‡æ¢åˆ°æ•°æ®æ¨¡å¼
        function switchToDataMode() {
            console.log('åˆ‡æ¢åˆ°æ•°æ®æ¨¡å¼...');
            
            if (currentMode === 'data') {
                console.log('å·²ç»åœ¨æ•°æ®æ¨¡å¼');
                return;
            }
            
            currentMode = 'data';
            console.log('å½“å‰æ¨¡å¼è®¾ç½®ä¸º:', currentMode);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const previewBtn = document.querySelector('.mode-btn.preview');
            const dataBtn = document.querySelector('.mode-btn.data');
            const refreshBtn = document.getElementById('refresh-data');
            
            if (previewBtn) previewBtn.classList.remove('active');
            if (dataBtn) dataBtn.classList.add('active');
            
            // ç¦ç”¨åˆ·æ–°æŒ‰é’®
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.style.opacity = '0.5';
                refreshBtn.style.cursor = 'not-allowed';
                console.log('åˆ·æ–°æŒ‰é’®å·²ç¦ç”¨');
            }
            
            // éšè—é¢„è§ˆæ¨¡å¼ï¼Œæ˜¾ç¤ºæ•°æ®æ¨¡å¼
            const previewMode = document.getElementById('preview-mode');
            const dataMode = document.getElementById('data-mode');
            
            if (previewMode) {
                previewMode.style.display = 'none';
                console.log('éšè—é¢„è§ˆæ¨¡å¼');
            }
            
            if (dataMode) {
                dataMode.classList.add('active');
                console.log('æ˜¾ç¤ºæ•°æ®æ¨¡å¼');
            } else {
                console.error('æ‰¾ä¸åˆ°æ•°æ®æ¨¡å¼å…ƒç´ ');
            }
            
            // ç¦ç”¨å³ä¾§é¢æ¿åŠŸèƒ½
            disableRightPanel();
            
            // å‡†å¤‡JSONæ•°æ®
            prepareJsonData();
            
            console.log('æ•°æ®æ¨¡å¼åˆ‡æ¢å®Œæˆ');
        }

        // ç”Ÿæˆè‡ªå®šä¹‰é¢†åŸŸçš„åˆå§‹åŒ–æ•°æ®
        function generateCustomDomainData(domainName) {
            console.log('ä¸ºè‡ªå®šä¹‰é¢†åŸŸç”Ÿæˆåˆå§‹åŒ–æ•°æ®:', domainName);
            
            // ç”Ÿæˆæ—¶é—´æˆ³ä½œä¸ºIDå‰ç¼€
            const timestamp = Date.now();
            
            // æ ¹æ®é¢†åŸŸåç§°ç”Ÿæˆç›¸å…³çš„å®ä½“å’Œå…³ç³»
            const sampleData = {
                nodes: [
                    {
                        id: `${timestamp}_1`,
                        name: `${domainName}æ ¸å¿ƒæ¦‚å¿µ`,
                        description: `${domainName}é¢†åŸŸçš„åŸºç¡€æ ¸å¿ƒæ¦‚å¿µ`,
                        domain: domainName
                    },
                    {
                        id: `${timestamp}_2`,
                        name: `${domainName}ä¸»è¦æŠ€æœ¯`,
                        description: `${domainName}é¢†åŸŸçš„ä¸»è¦æŠ€æœ¯æ–¹æ³•`,
                        domain: domainName
                    },
                    {
                        id: `${timestamp}_3`,
                        name: `${domainName}åº”ç”¨åœºæ™¯`,
                        description: `${domainName}é¢†åŸŸçš„å…¸å‹åº”ç”¨åœºæ™¯`,
                        domain: domainName
                    },
                    {
                        id: `${timestamp}_4`,
                        name: `${domainName}å‘å±•è¶‹åŠ¿`,
                        description: `${domainName}é¢†åŸŸçš„å‘å±•è¶‹åŠ¿å’Œå‰æ™¯`,
                        domain: domainName
                    },
                    {
                        id: `${timestamp}_5`,
                        name: `${domainName}ç›¸å…³å·¥å…·`,
                        description: `${domainName}é¢†åŸŸå¸¸ç”¨çš„å·¥å…·å’Œå¹³å°`,
                        domain: domainName
                    }
                ],
                links: [
                    {
                        source: `${timestamp}_1`,
                        target: `${timestamp}_2`,
                        type: "æ”¯æ’‘",
                        description: "æ ¸å¿ƒæ¦‚å¿µæ”¯æ’‘ä¸»è¦æŠ€æœ¯",
                        domain: domainName
                    },
                    {
                        source: `${timestamp}_2`,
                        target: `${timestamp}_3`,
                        type: "åº”ç”¨",
                        description: "ä¸»è¦æŠ€æœ¯åº”ç”¨äºå…·ä½“åœºæ™¯",
                        domain: domainName
                    },
                    {
                        source: `${timestamp}_3`,
                        target: `${timestamp}_4`,
                        type: "å½±å“",
                        description: "åº”ç”¨åœºæ™¯å½±å“å‘å±•è¶‹åŠ¿",
                        domain: domainName
                    },
                    {
                        source: `${timestamp}_1`,
                        target: `${timestamp}_5`,
                        type: "éœ€è¦",
                        description: "æ ¸å¿ƒæ¦‚å¿µéœ€è¦ç›¸å…³å·¥å…·æ”¯æŒ",
                        domain: domainName
                    },
                    {
                        source: `${timestamp}_2`,
                        target: `${timestamp}_5`,
                        type: "ä½¿ç”¨",
                        description: "ä¸»è¦æŠ€æœ¯ä½¿ç”¨ç›¸å…³å·¥å…·",
                        domain: domainName
                    }
                ]
            };
            
            console.log('ç”Ÿæˆçš„åˆå§‹åŒ–æ•°æ®:', sampleData);
            return sampleData;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªå®šä¹‰é¢†åŸŸ
        function isCustomDomain(domainName) {
            // è·å–æ‰€æœ‰ç°æœ‰é¢†åŸŸ
            const existingDomains = new Set();
            if (allGraphData && allGraphData.nodes) {
                allGraphData.nodes.forEach(node => {
                    if (node.domain) {
                        existingDomains.add(node.domain);
                    }
                });
            }
            
            console.log('æ£€æŸ¥è‡ªå®šä¹‰é¢†åŸŸ:', {
                domainName: domainName,
                existingDomains: Array.from(existingDomains),
                isCustom: domainName !== 'all' && !existingDomains.has(domainName)
            });
            
            // å¦‚æœé¢†åŸŸåç§°ä¸åœ¨ç°æœ‰é¢†åŸŸä¸­ï¼Œä¸”ä¸æ˜¯"all"ï¼Œåˆ™è®¤ä¸ºæ˜¯è‡ªå®šä¹‰é¢†åŸŸ
            return domainName !== 'all' && !existingDomains.has(domainName);
        }

        // å‡†å¤‡JSONæ•°æ®ç”¨äºç¼–è¾‘
        function prepareJsonData() {
            console.log('å‡†å¤‡JSONæ•°æ®...');
            
            // è·å–å½“å‰é€‰æ‹©çš„é¢†åŸŸ
            const domainSelect = document.getElementById('domain-select');
            if (!domainSelect) {
                console.error('æ‰¾ä¸åˆ°é¢†åŸŸé€‰æ‹©å™¨');
                return;
            }
            
            const currentDomain = domainSelect.value;
            console.log('å½“å‰é€‰æ‹©çš„é¢†åŸŸ:', currentDomain);
            
            let dataToEdit;
            
            if (currentDomain === 'all') {
                // å¦‚æœé€‰æ‹©æ‰€æœ‰é¢†åŸŸï¼Œä½¿ç”¨å®Œæ•´æ•°æ®
                dataToEdit = allGraphData;
                console.log('ä½¿ç”¨æ‰€æœ‰é¢†åŸŸæ•°æ®');
            } else if (isCustomDomain(currentDomain)) {
                // å¦‚æœæ˜¯è‡ªå®šä¹‰é¢†åŸŸï¼Œç”Ÿæˆåˆå§‹åŒ–æ•°æ®
                console.log('æ£€æµ‹åˆ°è‡ªå®šä¹‰é¢†åŸŸï¼Œè‡ªåŠ¨ç”Ÿæˆåˆå§‹åŒ–æ•°æ®');
                dataToEdit = generateCustomDomainData(currentDomain);
            } else {
                // å¦‚æœé€‰æ‹©ç‰¹å®šé¢†åŸŸï¼Œåªä½¿ç”¨è¯¥é¢†åŸŸçš„æ•°æ®
                dataToEdit = filteredGraphData;
                console.log('ä½¿ç”¨ç‰¹å®šé¢†åŸŸæ•°æ®:', currentDomain);
            }
            
            // ç¡®ä¿å…³ç³»æ•°æ®æ ¼å¼æ­£ç¡®
            const processedLinks = (dataToEdit.links || []).map(link => {
                // å¦‚æœsourceæˆ–targetæ˜¯å¯¹è±¡ï¼Œæå–ID
                const source = typeof link.source === 'object' ? link.source.id : link.source;
                const target = typeof link.target === 'object' ? link.target.id : link.target;
                
                return {
                    source: source,
                    target: target,
                    type: link.type || '',
                    description: link.description || '',
                    id: link.id,
                    domain: link.domain || 'default'
                };
            });
            
            const jsonData = {
                nodes: dataToEdit.nodes || [],
                links: processedLinks,
                currentDomain: currentDomain // æ·»åŠ å½“å‰é¢†åŸŸä¿¡æ¯
            };
            
            // ä¿å­˜åŸå§‹æ•°æ®
            originalJsonData = JSON.stringify(jsonData, null, 2);
            
            // æ˜¾ç¤ºåˆ°ç¼–è¾‘å™¨
            const jsonEditor = document.getElementById('json-editor');
            if (jsonEditor) {
                jsonEditor.value = originalJsonData;
            }
            
            // æ›´æ–°ç¼–è¾‘èŒƒå›´ä¿¡æ¯
            const editScopeElement = document.getElementById('edit-scope');
            const customDomainTip = document.getElementById('custom-domain-tip');
            
            if (currentDomain === 'all') {
                editScopeElement.textContent = 'æ‰€æœ‰é¢†åŸŸ';
                if (customDomainTip) customDomainTip.style.display = 'none';
            } else if (isCustomDomain(currentDomain)) {
                editScopeElement.textContent = `æ–°é¢†åŸŸï¼š${currentDomain}`;
                if (customDomainTip) customDomainTip.style.display = 'block';
            } else {
                editScopeElement.textContent = `é¢†åŸŸï¼š${currentDomain}`;
                if (customDomainTip) customDomainTip.style.display = 'none';
            }
            
            console.log('å‡†å¤‡çš„æ•°æ®:', jsonData);
            console.log('æ•°æ®æ¨¡å¼å‡†å¤‡å®Œæˆ');
        }

        // é‡æ–°æ’åºå®ä½“ID
        function reorderEntityIds() {
            try {
                const jsonEditor = document.getElementById('json-editor');
                if (!jsonEditor) {
                    alert('æ‰¾ä¸åˆ°JSONç¼–è¾‘å™¨');
                    return;
                }
                
                const jsonText = jsonEditor.value.trim();
                if (!jsonText) {
                    alert('è¯·å…ˆåŠ è½½æ•°æ®');
                    return;
                }
                
                // è§£æJSONæ•°æ®
                let parsedData;
                try {
                    parsedData = JSON.parse(jsonText);
                } catch (e) {
                    alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³•');
                    return;
                }
                
                if (!parsedData.nodes || !Array.isArray(parsedData.nodes)) {
                    alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘nodesæ•°ç»„');
                    return;
                }
                
                // è·å–å½“å‰ç¼–è¾‘çš„é¢†åŸŸ
                const currentDomain = parsedData.currentDomain || 'all';
                console.log('å½“å‰ç¼–è¾‘é¢†åŸŸ:', currentDomain);
                
                // è·å–æ‰€æœ‰é¢†åŸŸçš„å·²ä½¿ç”¨IDï¼ˆç”¨äºé¿å…å†²çªï¼‰
                const allUsedIds = new Set();
                if (currentDomain !== 'all' && allGraphData && allGraphData.nodes) {
                    // å¦‚æœå½“å‰ä¸æ˜¯ç¼–è¾‘æ‰€æœ‰é¢†åŸŸï¼Œéœ€è¦è·å–æ‰€æœ‰é¢†åŸŸçš„IDä»¥é¿å…å†²çª
                    allGraphData.nodes.forEach(node => {
                        allUsedIds.add(node.id);
                    });
                    console.log('æ‰€æœ‰é¢†åŸŸå·²ä½¿ç”¨çš„ID:', Array.from(allUsedIds));
                }
                
                // åˆ›å»ºIDæ˜ å°„è¡¨
                const idMapping = {};
                const nodes = parsedData.nodes;
                let nextId = 1;
                
                // ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…æ–°çš„IDï¼Œé¿å…ä¸æ‰€æœ‰é¢†åŸŸçš„IDå†²çª
                nodes.forEach((node, index) => {
                    const oldId = node.id;
                    let newId;
                    
                    if (currentDomain === 'all') {
                        // å¦‚æœæ˜¯ç¼–è¾‘æ‰€æœ‰é¢†åŸŸï¼ŒæŒ‰é¡ºåºä»1å¼€å§‹åˆ†é…
                        newId = (index + 1).toString();
                    } else {
                        // å¦‚æœæ˜¯ç¼–è¾‘ç‰¹å®šé¢†åŸŸï¼Œéœ€è¦é¿å…ä¸æ‰€æœ‰é¢†åŸŸçš„IDå†²çª
                        while (allUsedIds.has(nextId.toString())) {
                            nextId++;
                        }
                        newId = nextId.toString();
                        nextId++;
                    }
                    
                    idMapping[oldId] = newId;
                    node.id = newId;
                });
                
                // æ›´æ–°å…³ç³»ä¸­çš„æºå’Œç›®æ ‡ID
                if (parsedData.links && Array.isArray(parsedData.links)) {
                    parsedData.links.forEach(link => {
                        if (link.source && idMapping[link.source]) {
                            link.source = idMapping[link.source];
                        }
                        if (link.target && idMapping[link.target]) {
                            link.target = idMapping[link.target];
                        }
                    });
                }
                
                // æ›´æ–°JSONç¼–è¾‘å™¨å†…å®¹
                const newJsonText = JSON.stringify(parsedData, null, 2);
                jsonEditor.value = newJsonText;
                
                // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                graphData = parsedData;
                
                // æ˜¾ç¤ºç»“æœä¿¡æ¯
                if (currentDomain === 'all') {
                    alert(`é‡æ–°æ’åºå®Œæˆï¼\n\né¢†åŸŸï¼šæ‰€æœ‰é¢†åŸŸ\nå®ä½“IDå·²ä»1å¼€å§‹é€’å¢ï¼Œå…±å¤„ç† ${nodes.length} ä¸ªå®ä½“`);
                } else {
                    alert(`é‡æ–°æ’åºå®Œæˆï¼\n\né¢†åŸŸï¼š${currentDomain}\nå®ä½“IDå·²é‡æ–°åˆ†é…ï¼Œé¿å…ä¸æ‰€æœ‰é¢†åŸŸIDå†²çª\nå…±å¤„ç† ${nodes.length} ä¸ªå®ä½“`);
                }
                
            } catch (error) {
                console.error('é‡æ–°æ’åºå¤±è´¥:', error);
                alert('é‡æ–°æ’åºå¤±è´¥: ' + error.message);
            }
        }

        // ä¸ºæ‰€æœ‰IDæ·»åŠ åç¼€
        function addSuffixToIds() {
            try {
                const jsonEditor = document.getElementById('json-editor');
                if (!jsonEditor) {
                    alert('æ‰¾ä¸åˆ°JSONç¼–è¾‘å™¨');
                    return;
                }
                
                const jsonText = jsonEditor.value.trim();
                if (!jsonText) {
                    alert('è¯·å…ˆåŠ è½½æ•°æ®');
                    return;
                }
                
                // è§£æJSONæ•°æ®
                let parsedData;
                try {
                    parsedData = JSON.parse(jsonText);
                } catch (e) {
                    alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³•');
                    return;
                }
                
                if (!parsedData.nodes || !Array.isArray(parsedData.nodes)) {
                    alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘nodesæ•°ç»„');
                    return;
                }
                
                const suffix = '0000';
                let processedCount = 0;
                
                // ä¸ºæ‰€æœ‰å®ä½“IDæ·»åŠ åç¼€
                parsedData.nodes.forEach(node => {
                    if (node.id) {
                        node.id = node.id + suffix;
                        processedCount++;
                    }
                });
                
                // æ›´æ–°å…³ç³»ä¸­çš„æºå’Œç›®æ ‡ID
                if (parsedData.links && Array.isArray(parsedData.links)) {
                    parsedData.links.forEach(link => {
                        if (link.source) {
                            link.source = link.source + suffix;
                        }
                        if (link.target) {
                            link.target = link.target + suffix;
                        }
                    });
                }
                
                // æ›´æ–°JSONç¼–è¾‘å™¨å†…å®¹
                const updatedJson = JSON.stringify(parsedData, null, 2);
                jsonEditor.value = updatedJson;
                
                // æ˜¾ç¤ºç»“æœä¿¡æ¯
                const currentDomain = parsedData.currentDomain || 'all';
                const domainName = currentDomain === 'all' ? 'æ‰€æœ‰é¢†åŸŸ' : currentDomain;
                alert(`æ·»åŠ åç¼€å®Œæˆï¼\n\né¢†åŸŸï¼š${domainName}\nåç¼€ï¼š${suffix}\nå¤„ç†å®ä½“ï¼š${processedCount}ä¸ª\nå¤„ç†å…³ç³»ï¼š${parsedData.links ? parsedData.links.length : 0}ä¸ª`);
                
            } catch (error) {
                console.error('æ·»åŠ åç¼€å¤±è´¥:', error);
                alert('æ·»åŠ åç¼€å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜JSONæ•°æ®åˆ°æ•°æ®åº“
        async function saveJsonData() {
            try {
                console.log('å¼€å§‹ä¿å­˜æ•°æ®...');
                
                const jsonEditor = document.getElementById('json-editor');
                if (!jsonEditor) {
                    alert('æ‰¾ä¸åˆ°JSONç¼–è¾‘å™¨');
                    return;
                }
                
                const jsonText = jsonEditor.value.trim();
                
                if (!jsonText) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„JSONæ•°æ®');
                    return;
                }
                
                // éªŒè¯JSONæ ¼å¼
                let parsedData;
                try {
                    parsedData = JSON.parse(jsonText);
                } catch (e) {
                    alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³•');
                    return;
                }
                
                // éªŒè¯æ•°æ®ç»“æ„
                if (!parsedData.nodes || !parsedData.links) {
                    alert('JSONæ•°æ®å¿…é¡»åŒ…å« nodes å’Œ links å­—æ®µ');
                    return;
                }
                
                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                const dataDomain = parsedData.currentDomain || 'all';
                let confirmMessage;
                if (dataDomain === 'all') {
                    confirmMessage = `ç¡®è®¤è¦æ›´æ–°æ‰€æœ‰é¢†åŸŸçš„æ•°æ®å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–æ‰€æœ‰ç°æœ‰çš„å®ä½“å’Œå…³ç³»æ•°æ®ã€‚\n\nå®ä½“æ•°é‡ï¼š${parsedData.nodes.length}\nå…³ç³»æ•°é‡ï¼š${parsedData.links.length}`;
                } else if (isCustomDomain(dataDomain)) {
                    confirmMessage = `ç¡®è®¤è¦åˆ›å»ºæ–°é¢†åŸŸ"${dataDomain}"çš„æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ›å»ºæ–°çš„å®ä½“å’Œå…³ç³»ï¼Œä¸ä¼šå½±å“å…¶ä»–é¢†åŸŸçš„æ•°æ®ã€‚\n\nå®ä½“æ•°é‡ï¼š${parsedData.nodes.length}\nå…³ç³»æ•°é‡ï¼š${parsedData.links.length}`;
                } else {
                    confirmMessage = `ç¡®è®¤è¦æ›´æ–°é¢†åŸŸ"${dataDomain}"çš„æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åªæ›´æ–°è¯¥é¢†åŸŸçš„å®ä½“å’Œå…³ç³»ï¼Œå…¶ä»–é¢†åŸŸçš„æ•°æ®ä¸å—å½±å“ã€‚\n\nå®ä½“æ•°é‡ï¼š${parsedData.nodes.length}\nå…³ç³»æ•°é‡ï¼š${parsedData.links.length}`;
                }
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
                const saveBtn = document.querySelector('.data-btn.save');
                if (saveBtn) {
                    saveBtn.textContent = 'ä¿å­˜ä¸­...';
                    saveBtn.disabled = true;
                }
                
                // è°ƒç”¨åç«¯APIä¿å­˜æ•°æ®
                const requestBody = {
                    nodes: parsedData.nodes,
                    links: parsedData.links,
                    currentDomain: dataDomain
                };
                
                console.log('å‘é€åˆ°åç«¯çš„æ•°æ®:', requestBody);
                
                const response = await fetch('/api/kg/save-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
                
                const result = await response.json();
                
                if (result.ret === 0) {
                    alert('æ•°æ®ä¿å­˜æˆåŠŸï¼');
                    
                    // ä¿å­˜å½“å‰é¢†åŸŸé€‰æ‹©
                    const savedDomain = currentDomain;
                    console.log('ä¿å­˜å½“å‰é¢†åŸŸé€‰æ‹©:', savedDomain);
                    
                    // å¼ºåˆ¶åˆ·æ–°æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
                    try {
                        const refreshSuccess = await forceRefreshData();
                        if (refreshSuccess) {
                            // æ¢å¤é¢†åŸŸé€‰æ‹©
                            currentDomain = savedDomain;
                            console.log('æ¢å¤é¢†åŸŸé€‰æ‹©:', currentDomain);
                            
                            // é‡æ–°åº”ç”¨é¢†åŸŸç­›é€‰
                            filterDataByDomain();
                            updateDomainInfo();
                            
                            // æ›´æ–°é¢†åŸŸé€‰æ‹©å™¨æ˜¾ç¤º
                            const domainSelectDisplay = document.getElementById('domain-select-display');
                            const domainSelect = document.getElementById('domain-select');
                            if (domainSelectDisplay && domainSelect) {
                                if (currentDomain === 'all') {
                                    domainSelectDisplay.value = 'æ‰€æœ‰é¢†åŸŸ';
                                } else {
                                    domainSelectDisplay.value = currentDomain;
                                }
                                domainSelect.value = currentDomain;
                            }
                            
                            // è‡ªåŠ¨åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                            switchToPreviewMode();
                            
                            // å¦‚æœæ˜¯è‡ªå®šä¹‰é¢†åŸŸï¼Œæ›´æ–°é¢†åŸŸé€‰æ‹©å™¨
                            if (isCustomDomain(dataDomain)) {
                                console.log('æ£€æµ‹åˆ°è‡ªå®šä¹‰é¢†åŸŸï¼Œæ›´æ–°é¢†åŸŸé€‰æ‹©å™¨');
                                updateDomainSelectorWithCustom(dataDomain);
                            }
                            
                            console.log('æ•°æ®ä¿å­˜å¹¶åˆ·æ–°æˆåŠŸ:', graphData);
                        } else {
                            throw new Error('åˆ·æ–°æ•°æ®å¤±è´¥');
                        }
                    } catch (dataError) {
                        console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', dataError);
                        alert(`æ•°æ®ä¿å­˜æˆåŠŸï¼Œä½†åˆ·æ–°æ•°æ®å¤±è´¥ï¼š${dataError.message}\n\nè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢æˆ–ç‚¹å‡»"ğŸ”„ åˆ·æ–°æ•°æ®"æŒ‰é’®`);
                    }
                    
                } else {
                    throw new Error(result.msg || 'ä¿å­˜å¤±è´¥');
                }
                
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const saveBtn = document.querySelector('.data-btn.save');
                if (saveBtn) {
                    saveBtn.textContent = 'ä¿å­˜åˆ°æ•°æ®åº“';
                    saveBtn.disabled = false;
                }
            }
        }

        // å–æ¶ˆæ•°æ®ç¼–è¾‘
        function cancelDataEdit() {
            try {
                console.log('å–æ¶ˆæ•°æ®ç¼–è¾‘...');
                
                const jsonEditor = document.getElementById('json-editor');
                if (!jsonEditor) {
                    alert('æ‰¾ä¸åˆ°JSONç¼–è¾‘å™¨');
                    return;
                }
                
                // æ¢å¤åŸå§‹æ•°æ®
                if (originalJsonData) {
                    jsonEditor.value = originalJsonData;
                    console.log('å·²æ¢å¤åˆ°åŸå§‹æ•°æ®');
                } else {
                    console.log('æ²¡æœ‰åŸå§‹æ•°æ®å¯æ¢å¤');
                }
                
                // åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼
                switchToPreviewMode();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert('å·²å–æ¶ˆç¼–è¾‘å¹¶åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼');
                
            } catch (error) {
                console.error('å–æ¶ˆç¼–è¾‘å¤±è´¥:', error);
                alert('å–æ¶ˆç¼–è¾‘å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
